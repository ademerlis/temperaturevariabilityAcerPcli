---
title: "immunecellassay"
author: "allyson_demerlis"
date: "2023-02-28"
output: html_document
---
Load libraries and datasets
```{r}
library(tidyverse)
library(plotrix)
library(ggpubr)
library(rstatix)
library(cowplot)
library(dunn.test)
library(Rmisc)
library(plyr)
library(dplyr)

percent_cells_df <- read_csv("Grace_percentcells_alldata.csv") 

percent_cells_df%>% 
    mutate(Treatment = case_when(Treatment == "Control" ~ "Untreated",
                               Treatment == "Variable" ~ "Treated")) -> percent_cells_df

#there's one outlier to remove right off the bat: T1	Pcli	B	P9	r2	Percent=111.50	T1	Untreated
percent_cells_df %>% 
  filter(!(TimePoint=="T1" & Species == "Pcli" & Genotype == "B" & Treatment == "Untreated" & ID == "P9" & Replicate == "r2")) -> percent_cells_df

#replicates are technical replicates of the same coral fragment
#time points:
#T0 = initial pre-treatment (March 22)
#T1 = one week into treatment (March 30)
#T2 = end of treatment (April 20)
#follow-up = post CBASS and treatment follow-up (June 1)

percent_cells_df %>% 
  mutate(num_days = case_when(TimePoint == "T0" ~ "0",
                              TimePoint == "T1" ~ "7",
                              TimePoint == "T2" ~ "28",
                              TimePoint == "FollowUp" ~ "71")) %>% 
  mutate(num_days = as.factor(num_days)) %>% 
  mutate(num_days = fct_relevel(num_days, "0", "7", "28", "71")) -> percent_cells_df

```


# Raw percent at each time point (compare reps 1-3) and testing if significant differences between technical replicates 

None of the technical replicates are significantly different than one another within a given species:genotype:treatment. So I feel confident taking the mean percent across the three technical replicates and using that moving forward.

## T0
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0") %>% 
  ggplot(., aes(x=Replicate, y=Percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species+Genotype) + 
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```
### Statistics

#### Acer BC-8b 

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Acer" & Genotype == "BC-8b") -> T0_Acer_BC8b_df

str(T0_df)

#make factors
T0_Acer_BC8b_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Acer_BC8b_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Acer_BC8b_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Acer_BC8b_df)
T0_Acer_BC8b_model_metrics <- augment(T0_Acer_BC8b_model)
plot(T0_Acer_BC8b_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Acer_BC8b_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Acer_BC8b_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T0_Acer_BC8b_df)

summary(aov(Percent ~ Treatment*Replicate, data = T0_Acer_BC8b_df)) #replicate is not significant. wooooo
```

#### Acer MB-B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Acer" & Genotype == "MB-B") -> T0_Acer_MBB_df

#make factors
T0_Acer_MBB_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Acer_MBB_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Acer_MBB_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Acer_MBB_df)
T0_Acer_MBB_model_metrics <- augment(T0_Acer_MBB_model)
plot(T0_Acer_MBB_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Acer_MBB_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Acer_MBB_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T0_Acer_MBB_df)

summary(aov(Percent ~ Treatment*Replicate, data = T0_Acer_MBB_df)) #replicate is not significant. wooooo
```

#### Acer SI-C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Acer" & Genotype == "SI-C") -> T0_Acer_SIC_df

#make factors
T0_Acer_SIC_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Acer_SIC_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Acer_SIC_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Acer_SIC_df)
T0_Acer_SIC_model_metrics <- augment(T0_Acer_SIC_model)
plot(T0_Acer_SIC_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Acer_SIC_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Acer_SIC_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T0_Acer_SIC_df)

summary(aov(Percent ~ Treatment*Replicate, data = T0_Acer_SIC_df)) #replicate is not significant. wooooo
```

#### Pcli A

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Pcli" & Genotype == "A") -> T0_Pcli_A_df

#make factors
T0_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Pcli_A_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Pcli_A_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Pcli_A_df)
T0_Pcli_A_model_metrics <- augment(T0_Pcli_A_model)
plot(T0_Pcli_A_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Pcli_A_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Pcli_A_model_metrics) #significant

#make interaction term
T0_Pcli_A_df$Treatment_Replicate <- interaction(T0_Pcli_A_df$Treatment, T0_Pcli_A_df$Replicate)

#run Welch's anova
oneway.test(Percent ~ Treatment_Replicate, data = T0_Pcli_A_df, var.equal = FALSE) #not significant
```


#### Pcli B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Pcli" & Genotype == "B") -> T0_Pcli_B_df

#make factors
T0_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Pcli_B_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Pcli_B_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Pcli_B_df)
T0_Pcli_B_model_metrics <- augment(T0_Pcli_B_model)
plot(T0_Pcli_B_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Pcli_B_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Pcli_B_model_metrics) #significant

#make interaction term
T0_Pcli_B_df$Treatment_Replicate <- interaction(T0_Pcli_B_df$Treatment, T0_Pcli_B_df$Replicate)

#run Welch's anova
oneway.test(Percent ~ Treatment_Replicate, data = T0_Pcli_B_df, var.equal = FALSE) #not significant
```


#### Pcli C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0" & Species == "Pcli" & Genotype == "C") -> T0_Pcli_C_df

#make factors
T0_Pcli_C_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T0_Pcli_C_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T0_Pcli_C_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T0_Pcli_C_df)
T0_Pcli_C_model_metrics <- augment(T0_Pcli_C_model)
plot(T0_Pcli_C_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T0_Pcli_C_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T0_Pcli_C_model_metrics) #significant

#make interaction term
T0_Pcli_C_df$Treatment_Replicate <- interaction(T0_Pcli_C_df$Treatment, T0_Pcli_C_df$Replicate)

#run Welch's anova
oneway.test(Percent ~ Treatment_Replicate, data = T0_Pcli_C_df, var.equal = FALSE) #not significant
```


## T1
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1") %>% 
  ggplot(., aes(x=Replicate, y=Percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species+Genotype) + 
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```

### Statistics

#### Acer BC-8b 

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Acer" & Genotype == "BC-8b") -> T1_Acer_BC8b_df

#make factors
T1_Acer_BC8b_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Acer_BC8b_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Acer_BC8b_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Acer_BC8b_df)
T1_Acer_BC8b_model_metrics <- augment(T1_Acer_BC8b_model)
plot(T1_Acer_BC8b_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Acer_BC8b_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Acer_BC8b_model_metrics) #significant

#make interaction term
T1_Acer_BC8b_df$Treatment_Replicate <- interaction(T1_Acer_BC8b_df$Treatment, T1_Acer_BC8b_df$Replicate)

#run Welch's anova
oneway.test(Percent ~ Treatment_Replicate, data = T1_Acer_BC8b_df, var.equal = FALSE) #not significant
```

#### Acer MB-B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Acer" & Genotype == "MB-B") -> T1_Acer_MBB_df

#make factors
T1_Acer_MBB_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Acer_MBB_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Acer_MBB_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Acer_MBB_df)
T1_Acer_MBB_model_metrics <- augment(T1_Acer_MBB_model)
plot(T1_Acer_MBB_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Acer_MBB_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Acer_MBB_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T1_Acer_MBB_df)

summary(aov(Percent ~ Treatment*Replicate, data = T1_Acer_MBB_df)) #replicate is not significant. wooooo
```

#### Acer SI-C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Acer" & Genotype == "SI-C") -> T1_Acer_SIC_df

#make factors
T1_Acer_SIC_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Acer_SIC_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Acer_SIC_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Acer_SIC_df)
T1_Acer_SIC_model_metrics <- augment(T1_Acer_SIC_model)
plot(T1_Acer_SIC_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Acer_SIC_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Acer_SIC_model_metrics) #significant

#make interaction term
T1_Acer_SIC_df$Treatment_Replicate <- interaction(T1_Acer_SIC_df$Treatment, T1_Acer_SIC_df$Replicate)

#run kruskal wallis test
kruskal_test(Percent ~ T1_Acer_SIC_df$Treatment_Replicate, data = T1_Acer_SIC_df) #not significant
```

#### Pcli A

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Pcli" & Genotype == "A") -> T1_Pcli_A_df

#make factors
T1_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Pcli_A_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Pcli_A_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Pcli_A_df)
T1_Pcli_A_model_metrics <- augment(T1_Pcli_A_model)
plot(T1_Pcli_A_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Pcli_A_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Pcli_A_model_metrics) #significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T1_Pcli_A_df)

summary(aov(Percent ~ Treatment*Replicate, data = T1_Pcli_A_df)) #replicate is not significant. wooooo
```


#### Pcli B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Pcli" & Genotype == "B") -> T1_Pcli_B_df

#make factors
T1_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Pcli_B_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Pcli_B_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Pcli_B_df)
T1_Pcli_B_model_metrics <- augment(T1_Pcli_B_model)
plot(T1_Pcli_B_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Pcli_B_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Pcli_B_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T1_Pcli_B_df)

summary(aov(Percent ~ Treatment*Replicate, data = T1_Pcli_B_df)) #replicate is not significant. wooooo
```


#### Pcli C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T1" & Species == "Pcli" & Genotype == "C") -> T1_Pcli_C_df

#make factors
T1_Pcli_C_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T1_Pcli_C_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T1_Pcli_C_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T1_Pcli_C_df)
T1_Pcli_C_model_metrics <- augment(T1_Pcli_C_model)
plot(T1_Pcli_C_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T1_Pcli_C_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T1_Pcli_C_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T1_Pcli_C_df)

summary(aov(Percent ~ Treatment*Replicate, data = T1_Pcli_C_df)) #replicate is not significant. wooooo
```




## T2
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2") %>% 
  ggplot(., aes(x=Replicate, y=Percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species+Genotype) + 
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```


### Statistics

#### Acer BC-8b 

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Acer" & Genotype == "BC-8b") -> T2_Acer_BC8b_df

#make factors
T2_Acer_BC8b_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Acer_BC8b_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Acer_BC8b_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Acer_BC8b_df)
T2_Acer_BC8b_model_metrics <- augment(T2_Acer_BC8b_model)
plot(T2_Acer_BC8b_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Acer_BC8b_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Acer_BC8b_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Acer_BC8b_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Acer_BC8b_df)) #replicate is not significant. wooooo
```

#### Acer MB-B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Acer" & Genotype == "MB-B") -> T2_Acer_MBB_df

#make factors
T2_Acer_MBB_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Acer_MBB_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Acer_MBB_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Acer_MBB_df)
T2_Acer_MBB_model_metrics <- augment(T2_Acer_MBB_model)
plot(T2_Acer_MBB_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Acer_MBB_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Acer_MBB_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Acer_MBB_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Acer_MBB_df)) #replicate is not significant. wooooo
```

#### Acer SI-C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Acer" & Genotype == "SI-C") -> T2_Acer_SIC_df

#make factors
T2_Acer_SIC_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Acer_SIC_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Acer_SIC_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Acer_SIC_df)
T2_Acer_SIC_model_metrics <- augment(T2_Acer_SIC_model)
plot(T2_Acer_SIC_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Acer_SIC_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Acer_SIC_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Acer_SIC_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Acer_SIC_df)) #replicate is not significant. wooooo
```

#### Pcli A

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Pcli" & Genotype == "A") -> T2_Pcli_A_df

#make factors
T2_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Pcli_A_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Pcli_A_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Pcli_A_df)
T2_Pcli_A_model_metrics <- augment(T2_Pcli_A_model)
plot(T2_Pcli_A_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Pcli_A_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Pcli_A_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Pcli_A_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Pcli_A_df)) #replicate is not significant. wooooo
```


#### Pcli B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Pcli" & Genotype == "B") -> T2_Pcli_B_df

#make factors
T2_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Pcli_B_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Pcli_B_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Pcli_B_df)
T2_Pcli_B_model_metrics <- augment(T2_Pcli_B_model)
plot(T2_Pcli_B_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Pcli_B_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Pcli_B_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Pcli_B_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Pcli_B_df)) #replicate is not significant. wooooo
```


#### Pcli C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "T2" & Species == "Pcli" & Genotype == "C") -> T2_Pcli_C_df

#make factors
T2_Pcli_C_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> T2_Pcli_C_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
T2_Pcli_C_model <- lm(Percent ~ Treatment*Replicate + Tank, data = T2_Pcli_C_df)
T2_Pcli_C_model_metrics <- augment(T2_Pcli_C_model)
plot(T2_Pcli_C_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(T2_Pcli_C_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = T2_Pcli_C_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = T2_Pcli_C_df)

summary(aov(Percent ~ Treatment*Replicate, data = T2_Pcli_C_df)) #replicate is not significant. wooooo
```



## FollowUp
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp") %>% 
  ggplot(., aes(x=Replicate, y=Percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species+Genotype) + 
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```



### Statistics

#### Acer BC-8b 

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Acer" & Genotype == "BC-8b") -> FollowUp_Acer_BC8b_df

#make factors
FollowUp_Acer_BC8b_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Acer_BC8b_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Acer_BC8b_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Acer_BC8b_df)
FollowUp_Acer_BC8b_model_metrics <- augment(FollowUp_Acer_BC8b_model)
plot(FollowUp_Acer_BC8b_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Acer_BC8b_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Acer_BC8b_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_BC8b_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_BC8b_df)) #replicate is not significant. wooooo
```

#### Acer MB-B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Acer" & Genotype == "MB-B") -> FollowUp_Acer_MBB_df

#make factors
FollowUp_Acer_MBB_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Acer_MBB_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Acer_MBB_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Acer_MBB_df)
FollowUp_Acer_MBB_model_metrics <- augment(FollowUp_Acer_MBB_model)
plot(FollowUp_Acer_MBB_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Acer_MBB_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Acer_MBB_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_MBB_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_MBB_df)) #replicate is not significant. wooooo
```

#### Acer SI-C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Acer" & Genotype == "SI-C") -> FollowUp_Acer_SIC_df

#make factors
FollowUp_Acer_SIC_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Acer_SIC_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Acer_SIC_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Acer_SIC_df)
FollowUp_Acer_SIC_model_metrics <- augment(FollowUp_Acer_SIC_model)
plot(FollowUp_Acer_SIC_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Acer_SIC_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Acer_SIC_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_SIC_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Acer_SIC_df)) #replicate is not significant. wooooo
```

#### Pcli A

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Pcli" & Genotype == "A") -> FollowUp_Pcli_A_df

#make factors
FollowUp_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Pcli_A_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Pcli_A_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Pcli_A_df)
FollowUp_Pcli_A_model_metrics <- augment(FollowUp_Pcli_A_model)
plot(FollowUp_Pcli_A_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Pcli_A_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Pcli_A_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_A_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_A_df)) #replicate is not significant. wooooo
```


#### Pcli B

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Pcli" & Genotype == "B") -> FollowUp_Pcli_B_df

#make factors
FollowUp_Pcli_A_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Pcli_B_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Pcli_B_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Pcli_B_df)
FollowUp_Pcli_B_model_metrics <- augment(FollowUp_Pcli_B_model)
plot(FollowUp_Pcli_B_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Pcli_B_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Pcli_B_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_B_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_B_df)) #replicate is not significant. wooooo
```


#### Pcli C

do within each species:genotype because you are interested in whether replicates within the species:genotype comparison are significantly different
```{r}
percent_cells_df %>%
  filter(TimePoint == "FollowUp" & Species == "Pcli" & Genotype == "C") -> FollowUp_Pcli_C_df

#make factors
FollowUp_Pcli_C_df %>% 
  mutate_at(vars(TimePoint, Species, Genotype, Replicate, Tank, Treatment), factor) -> FollowUp_Pcli_C_df
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
FollowUp_Pcli_C_model <- lm(Percent ~ Treatment*Replicate + Tank, data = FollowUp_Pcli_C_df)
FollowUp_Pcli_C_model_metrics <- augment(FollowUp_Pcli_C_model)
plot(FollowUp_Pcli_C_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(FollowUp_Pcli_C_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Replicate, data = FollowUp_Pcli_C_model_metrics) #not significant

#run two-way anova
aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_C_df)

summary(aov(Percent ~ Treatment*Replicate, data = FollowUp_Pcli_C_df)) #replicate is not significant. wooooo
```


None of the technical replicates are significantly different than one another within a given species:genotype:treatment. So I feel confident taking the mean percent across the three technical replicates and using that moving forward.



# Percent at each time point (replicates combined)

## T0
```{r}
percent_cells_df %>%
  filter(TimePoint == "T0") %>% 
  ggplot(., aes(x=Genotype, y=Percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species, scales = "free_x") + 
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```



# Percent comparison beginning and end of treatment
(average of all technical replicates)

## species:treatment comparison
```{r}
plot1 <- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::group_by(num_days, Species, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species, scales = "free_x", dir = "v") +
  theme(text = element_text(size = 15)) +
  ylim(0, 20) +
  theme(legend.position="none")
  
#ggsave("percentcells_speciestreatments_overtime.pdf", width = 8, height = 5)
```

### Statistics

Change to factors
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> percent_cells_speciestreatments

str(percent_cells_speciestreatments)

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Treatment, num_days), factor) -> percent_cells_speciestreatments
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(mean_replicate_percent_perID ~ Treatment*Species*num_days + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*num_days, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#make interaction term
percent_cells_speciestreatments$Treatment_Species_numdays <- interaction(percent_cells_speciestreatments$Treatment, percent_cells_speciestreatments$Species, percent_cells_speciestreatments$num_days)

#run Welch's anova
oneway.test(mean_replicate_percent_perID ~ Treatment_Species_numdays, data = percent_cells_speciestreatments, var.equal = FALSE) #significant

#posthoc test: Games-Howell

games_howell_test(percent_cells_speciestreatments, mean_replicate_percent_perID ~ Treatment_Species_numdays) #%>% 
 # write_csv("percentcells_speciestreatment_posthoc.csv")
```



## separated by genotype and species
```{r}
plot2 <- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Species, Genotype, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Number of Days")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species+Genotype, scales = "free_x") +
  theme(text = element_text(size = 15)) +
  ylim(0, 20)
```


```{r}
plot_grid(plot1, plot2, ncol = 2, rel_widths = c(1,2))

#ggsave("percentphagocyticactivity_species_genets.pdf", width = 10, height = 5)
```

### Statistics

Change to factors

Separate species 

#### Acer
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  filter(Species == "Acer") %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> Acer_percent_cells 

str(Acer_percent_cells)

Acer_percent_cells %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment, num_days), factor) -> Acer_percent_cells
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
Acer_model <- lm(mean_replicate_percent_perID ~ Treatment*Genotype*num_days + Tank, data = Acer_percent_cells)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype*num_days, data = Acer_model_metrics) #not significant

# identifying outliers
Acer_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#make interaction term
Acer_percent_cells$Treatment_Genotype_numdays <- interaction(Acer_model_metrics$Treatment, Acer_percent_cells$Genotype, Acer_percent_cells$num_days)

# kruskal wallis test
kruskal_test(mean_replicate_percent_perID ~ Treatment_Genotype_numdays, data = Acer_percent_cells)#significant

#posthoc test
as.data.frame(dunn.test(Acer_percent_cells$mean_replicate_percent_perID, Acer_percent_cells$Treatment_Genotype_numdays, method = "bonferroni")) %>% 
  write_csv("Acer_percent_cells_genet_posthoc.csv")

```

#### Pcli
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  filter(Species == "Pcli") %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> Pcli_percent_cells 

str(Pcli_percent_cells)

Pcli_percent_cells %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment, num_days), factor) -> Pcli_percent_cells
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
Pcli_model <- lm(mean_replicate_percent_perID ~ Treatment*Genotype*num_days + Tank, data = Pcli_percent_cells)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype*num_days, data = Pcli_model_metrics) #not significant

# identifying outliers
Pcli_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#run two-way anova
summary(aov(mean_replicate_percent_perID ~ Treatment*Genotype*num_days, data = Pcli_percent_cells)) #only num of days is significant

#capture.output(TukeyHSD(aov(mean_replicate_percent_perID ~ Treatment*Genotype*num_days, data = Pcli_percent_cells)), file = "pcli_phagocytosis_posthoc.csv")
```


# Percent change over treatment 

## By species x treatment

```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> percent_cells_speciestreatments 
  
#average all technical replicates together before running stats
cell_means <- summarySE(percent_cells_speciestreatments, measurevar="mean_replicate_percent_perID", groupvars=c("Species","Treatment", "num_days"))
```

```{r}

```


# Percent change end of treatment vs recovery time point 



