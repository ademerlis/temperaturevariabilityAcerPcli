---
title: "survivorship"
author: "allyson_demerlis"
date: "2023-02-20"
output: html_document
---
# Load data and packages
```{r}
library(tidyverse)
library(janitor)
library(rstatix)
library(cowplot)
library(plotrix)
library(survival)
library(ggpubr)
library(survminer)
library(coxme)
library(ggsurvfit)
library(gtsummary)
library(dunn.test)

metadata <- readxl::read_xlsx("../metadata.xlsx", sheet = "tidy_data")

str(metadata) #295 corals

survivorship <- readxl::read_xlsx("../metadata.xlsx", sheet ="kaplanmeiercurve")
```

Tidy data 

```{r}
metadata %>% 
  mutate(CBASS_temp = case_when(CBASS_tank == "1" ~ "36",
                               CBASS_tank == "2" ~ "37",
                               CBASS_tank == "3" ~ "32",
                               CBASS_tank == "4" ~ "33",
                               CBASS_tank == "5" ~ "35",
                               CBASS_tank == "6" ~ "30",
                               CBASS_tank == "7" ~ "34",
                               CBASS_tank == "8" ~ "28")) -> tidy_metadata
```


There are two columns of significance for survivorship, Removed_Date and Mortality_Date. At some point, tank 7 become the recovery tank for corals. If the coral had a lot of tissue on it but looked stressed, it was removed from either the CBASS tank or the slow burn heat stress assay (high temp) into the recovery tank at 28ºC. That date of transfer was recorded in the column "Removed_Date". The column "Mortality_Date" refers to corals that were removed from any tank and died. 

```{r}
metadata %>% 
  filter(is.na(Removed_Date) & is.na(mortality_date)) #41 corals don't have either. But if they weren't assigned a heat-stress tank, that should indicate that they were removed/died before 06/15/2022

metadata %>% 
  filter(is.na(Removed_Date) & is.na(mortality_date) & is.na(slowburn_heatstress_tank)) # 5 corals. looks like the four Acer were tissue sampled and the Pcli who knows, it got buoyant weighed on April 21. they probably died sometime after CBASS and before heat stress.
```


# CBASS Mortality

```{r}
tidy_metadata %>%
  filter(Removed_Date < "2022-05-20") %>% 
  arrange(desc(Removed_Date))

#April 26 was the last coral reported with a mortality date until the slow burn heat stress started. So have April 26 be the cut-off point for CBASS mortality plots.

ggplot(tidy_metadata, aes(x=Removed_Date, fill = Treatment)) +
  geom_bar() + 
  facet_wrap(~Species)

ggplot(tidy_metadata, aes(x=mortality_date, fill = Treatment)) +
  geom_bar() + 
  facet_wrap(~Species)

CBASS_mortality <- tidy_metadata %>% 
  dplyr::filter(Removed_Date >= "2022-04-20" & Removed_Date <= "2022-04-26") 
#for this time period, Removed_Date and mortality_date match up so there's no need to use the coalesce function

#99 corals died during CBASS
```

## Number of corals that died due to CBASS
```{r}
tidy_metadata %>% 
  dplyr::filter(Removed_Date >= "2022-04-20" & Removed_Date <= "2022-04-26") %>%
  drop_na(Species, Treatment, Reason_removed) %>% 
  group_by(Reason_removed, Species, Treatment) %>% 
  dplyr::summarize(count = n()) %>% 
  ggplot(., aes(x=Reason_removed, y=count, fill = Treatment)) +
  geom_col(position = position_dodge()) +
  theme_classic() +
  facet_wrap(~Species)  +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))  +
  theme(text = element_text(size = 15)) +
  labs(x="Category", y="Number of corals") + 
  coord_flip()
```

```{r}
CBASS_mortality %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "post-CBASS RTL" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL")) %>% 
  drop_na(Species, Treatment) %>% 
  group_by(Species, Treatment) %>% 
  dplyr::summarize(count_RTL = n()) -> RTL_species_treatment_count

CBASS_mortality %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "post-CBASS RTL" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL")) %>% 
  drop_na(Species, Treatment) %>% 
  group_by(Species, Treatment, CBASS_temp) %>% 
  dplyr::summarize(count_RTL = n()) -> RTL_species_treatment_CBASStemps
```


```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  dplyr::summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!count_total) %>% 
  pivot_longer(count_RTL:count_survived, names_to="label", values_to="count") %>% 
  ggplot(., aes(x=Treatment, y=count, fill = label)) +
  geom_col() +
  theme_classic() +
  scale_fill_manual(labels=c("RTL", "Survived"), values = c("black", "grey"))  +
  theme(text = element_text(size = 12)) +
  facet_wrap(~Species, scales = "free_x") +
  labs(y="Count", fill = "Category") 
```

```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  dplyr::summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!count_total) 
  
#write_csv("RTL_vs_survived_CBASS_speciestreatments.csv")
```


```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment, CBASS_temp) %>% 
  dplyr::summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_CBASStemps) %>% 
  drop_na(CBASS_temp) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  mutate(count_survived = if_else(is.na(count_survived),0,count_survived)) %>% 
  dplyr::select(!count_total) %>% 
  pivot_longer(count_RTL:count_survived, names_to="label", values_to="count") %>% 
  ggplot(., aes(x=CBASS_temp, y=count, fill = label)) +
  geom_col() +
  theme_classic() +
  scale_fill_manual(labels=c("RTL", "Survived"), values = c("black", "grey"))  +
  theme(text = element_text(size = 12)) +
  facet_wrap(~Species*Treatment, scales = "free_x") +
  labs(y="Count", fill = "Category") 
```


```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment, CBASS_temp) %>% 
  summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_CBASStemps) %>% 
  drop_na(CBASS_temp) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  mutate(count_survived = if_else(is.na(count_survived),0,count_survived)) %>% 
  select(!count_total) #%>% 
  #write_csv("RTL_vs_survived_CBASS_byCBASStemp.csv")
```

## stats test on counts (not standardized)

### species x treatment
```{r}
#chi squared test for comparing mortality numbers
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_survived = count_total-count_RTL) %>% 
  select(!count_total) %>% 
  unite("Species.Treatment", Species,Treatment, sep = ".") %>% 
  column_to_rownames(var="Species.Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() #not significant
```

post-hoc test for pairwise comparisons
```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  select(!count_total) %>% 
  unite("Species.Treatment", Species,Treatment, sep = ".") %>% 
  column_to_rownames(var="Species.Treatment") %>% 
  as.data.frame() %>% 
  pairwise_prop_test() 
```

### species x treatment x CBASS temp
```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment,CBASS_temp) %>% 
  summarize(count_total = n()) %>%
  drop_na(CBASS_temp) %>% 
  full_join(., RTL_species_treatment_CBASStemps) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  select(!count_total) %>% 
  unite("Species.Treatment.CBASS_temp", Species,Treatment,CBASS_temp, sep = ".") %>% 
  column_to_rownames(var="Species.Treatment.CBASS_temp") %>%  
  as.data.frame() %>% 
  chisq_test() #very significant 
```

```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment,CBASS_temp) %>% 
  summarize(count_total = n()) %>%
  drop_na(CBASS_temp) %>% 
  full_join(., RTL_species_treatment_CBASStemps) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  select(!count_total) %>% 
  unite("Species.Treatment.CBASS_temp", Species,Treatment,CBASS_temp, sep = ".") %>% 
  column_to_rownames(var="Species.Treatment.CBASS_temp") %>% 
  as.data.frame() %>% 
  pairwise_prop_test() #%>% 
  # write_csv("pairwise_prop_test_RTLvsSurvivedCounts.csv")
```


### species separate

#### Acer
```{r}
RTL_species_treatment_count %>% 
  filter(Species == "Acropora cervicornis") -> Acer_treatment_RTL

tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Acropora cervicornis") %>% 
  group_by(Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Acer_treatment_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  column_to_rownames(var="Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() #not significant
```

#### Acer x CBASS temps
```{r}
RTL_species_treatment_CBASStemps %>% 
  filter(Species == "Acropora cervicornis") -> Acer_treatment_CBASS_RTL

tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Acropora cervicornis") %>% 
  group_by(CBASS_temp, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Acer_treatment_CBASS_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  unite("Treatment.CBASS_temp", Treatment,CBASS_temp, sep = ".") %>%
  column_to_rownames(var="Treatment.CBASS_temp") %>% 
  as.data.frame() %>% 
  chisq_test() #not significant
```

```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Acropora cervicornis") %>% 
  group_by(CBASS_temp, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Acer_treatment_CBASS_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  unite("Treatment.CBASS_temp", Treatment,CBASS_temp, sep = ".") %>%
  column_to_rownames(var="Treatment.CBASS_temp") %>% 
  as.data.frame()  %>% 
  pairwise_prop_test() #%>% 
  # write_csv("pairwise_prop_test_RTLvsSurvivedCounts.csv")
```

#### Pcli
```{r}
RTL_species_treatment_count %>% 
  filter(Species == "Pseudodiploria clivosa") -> Pcli_treatment_RTL

tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Pseudodiploria clivosa") %>% 
  group_by(Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Pcli_treatment_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  column_to_rownames(var="Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() #not significant
```

#### Pcli x CBASS temps
```{r}
RTL_species_treatment_CBASStemps %>% 
  filter(Species == "Pseudodiploria clivosa") -> Pcli_treatment_CBASS_RTL

tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Pseudodiploria clivosa") %>% 
  group_by(CBASS_temp, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Pcli_treatment_CBASS_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  unite("Treatment.CBASS_temp", Treatment,CBASS_temp, sep = ".") %>%
  column_to_rownames(var="Treatment.CBASS_temp") %>% 
  as.data.frame() %>% 
  chisq_test() #not significant
```

```{r}
tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  filter(Species == "Pseudodiploria clivosa") %>% 
  group_by(CBASS_temp, Treatment) %>% 
  summarize(count_total = n()) %>%
  full_join(., Pcli_treatment_CBASS_RTL) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>%
  mutate(count_survived = count_total-count_RTL) %>% 
  dplyr::select(!c(count_total,Species)) %>% 
  unite("Treatment.CBASS_temp", Treatment,CBASS_temp, sep = ".") %>%
  column_to_rownames(var="Treatment.CBASS_temp") %>% 
  as.data.frame()  %>% 
  pairwise_prop_test() %>% 
  write_csv("pairwise_prop_test_RTLvsSurvivedCounts_Pcli_treatmentCBASStemp.csv")
```

## for figure bar plots of proportions 

```{r}
p1<- tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_survived = count_total-count_RTL) %>% 
  mutate(proportion_survived = count_survived/count_total) %>% 
  mutate(proportion_RTL = 1-proportion_survived) %>% 
  pivot_longer(proportion_survived:proportion_RTL, names_to="label", values_to="proportion") %>% 
  ggplot(., aes(x=Treatment, y=proportion, fill = label)) +
  geom_col() +
  theme_classic() +
  scale_fill_manual(labels=c("RTL", "Survived"), values = c("black", "grey"))  +
  theme(text = element_text(size = 15)) +
  facet_wrap(~Species, scales = "free_x") +
  labs(y="Proportion", fill = "Category")  +
  theme(legend.position="none")

#ggsave("coralmortalityduetoCBASS.pdf", width=8, height=5)
```


```{r}
p2<-tidy_metadata %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment,CBASS_temp) %>% 
  summarize(count_total = n()) %>% 
  drop_na(CBASS_temp) %>% 
  full_join(., RTL_species_treatment_CBASStemps) %>% 
  mutate(count_RTL = if_else(is.na(count_RTL),0,count_RTL)) %>% 
  mutate(count_survived = count_total-count_RTL) %>% 
  mutate(count_survived = if_else(is.na(count_survived),0,count_survived)) %>% 
  mutate(proportion_survived = count_survived/count_total) %>% 
  mutate(proportion_RTL = 1-proportion_survived) %>% 
  pivot_longer(proportion_survived:proportion_RTL, names_to="label", values_to="proportion") %>%
  ggplot(., aes(x=CBASS_temp, y=proportion, fill = label)) +
  geom_col() +
  theme_classic() +
  scale_fill_manual(labels=c("RTL", "Survived"), values = c("black", "grey"))  +
  theme(text = element_text(size = 12)) +
  facet_wrap(~Species*Treatment, scales = "free_x") +
  labs(y="Proportion", fill = "Category", x = "CBASS Temperature")
#ggsave("coralmortalityduetoCBASS_bytemp.pdf", width = 10, height =6)
```


combine plots
```{r}
plot_grid(p1, p2, ncol=2, rel_widths = c(1.5, 2))
#ggsave("coralmortalityduetoCBASS_bytreatandtemp.pdf", width = 10, height = 5)
```




# Slow-Burn Mortality

Heat-stress at 32ºC was reached on June 25. 
```{r}
metadata %>% 
  filter(!is.na(slowburn_heatstress_tank)) #163 corals

metadata %>% 
  filter(!is.na(slowburn_heatstress_tank)) %>% 
  select(Species:heatstress_recovery_tank) %>% 
  mutate(CBASS_temp = case_when(CBASS_tank == "1" ~ "36",
                               CBASS_tank == "2" ~ "37",
                               CBASS_tank == "3" ~ "32",
                               CBASS_tank == "4" ~ "33",
                               CBASS_tank == "5" ~ "35",
                               CBASS_tank == "6" ~ "30",
                               CBASS_tank == "7" ~ "34",
                               CBASS_tank == "8" ~ "28")) %>% 
  mutate(slowburn= case_when(slowburn_heatstress_tank == "7" ~ "ambient",
                             TRUE ~ "heatstress_32")) -> slowburn_metadata
```

## sample sizes going into slow-burn
```{r}
slowburn_metadata %>% 
  filter(Removed_Date >= "2022-06-21" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(mortality_date = ymd(mortality_date)) %>%
  mutate(end_date = coalesce(Removed_Date, mortality_date)) %>% #if removed_date is NA, then look and use the date from mortality date
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = end_date - start_date) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached"))  %>% 
  group_by(Species, Treatment, Reason_removed) %>% 
  summarise(count = n())
```

## days at 32ºC
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>%  
  ggplot(., aes(x=Treatment, y=days_to_removed, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species)
```

```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25") %>% 
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) %>% 
  group_by(Species, Treatment) %>% 
  dplyr::summarise(mean=mean(days_to_removed), sd = sd(days_to_removed), n = n()) %>% 
  as.data.frame()

slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25") %>% 
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) %>% 
  group_by(Species, Colony, Treatment) %>% 
  dplyr::summarise(mean=mean(days_to_removed), sd = sd(days_to_removed), n = n()) %>% 
  as.data.frame()
```

### create data frame for WGCNA import
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25") %>% 
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) %>% 
  select(Species, ID, Colony, Treatment, days_to_removed) %>% 
  write_csv("days_to_removed.csv")
```



```{r}
b1<- slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  group_by(Species, Treatment) %>% 
  summarise(averagedays = mean(days_to_removed), se = std.error(days_to_removed)) %>%
  ggplot(., aes(x = Treatment, y = averagedays, fill = Treatment)) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = averagedays - se, ymax = averagedays + se), width =
                  .2, position=position_dodge(.9)) +
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  labs( y="Number of Days at 32ºC") +
  theme(text = element_text(size = 15)) +
  theme(legend.position="none")
```

```{r}
b2<- slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  group_by(Species, Treatment, Colony) %>% 
  summarise(averagedays = mean(days_to_removed), se = std.error(days_to_removed)) %>%
  ggplot(., aes(x = Colony, y = averagedays, fill = Treatment)) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = averagedays - se, ymax = averagedays + se), width =
                  .2, position=position_dodge(.9)) +
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  labs( y="Number of Days at 32ºC") +
  theme(text = element_text(size = 15))
```

create combined plot
```{r}
plot_grid(b1, b2, rel_widths = c(1,2))
#ggsave("daysat32_barplot_speciesgenet.pdf", width = 12, height = 5)
```

## 1-way anova for species separately

### Acer

Change to factors
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  select(Species, ID, Colony, Treatment, CBASS_temp, slowburn, days_to_removed) -> slowburn_summary_data

slowburn_summary_data %>% 
  mutate_at(vars(Species, ID, Colony, Treatment, CBASS_temp), factor) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) -> slowburn_summary_data

slowburn_summary_data %>% 
  filter(Species == "Acropora cervicornis") -> Acer_slowburn
```

```{r}
Acer_slowburn_model <- lm(days_to_removed ~ Treatment + Colony, data = Acer_slowburn)
Acer_slowburn_model_metrics <- augment(Acer_slowburn_model)
plot(Acer_slowburn_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_slowburn_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Acer_slowburn_model_metrics) #not significant

#data visually does not look normal so i'm going to use the kruskal-wallis test
```

```{r}
kruskal_test(days_to_removed ~ Treatment, data = Acer_slowburn)# Significant!!!!!!!!!!!! 
```

### Pcli
```{r}
slowburn_summary_data %>% 
  filter(Species == "Pseudodiploria clivosa") -> Pcli_slowburn

Pcli_slowburn_model <- lm(days_to_removed ~ Treatment + Colony, data = Pcli_slowburn)
Pcli_slowburn_model_metrics <- augment(Pcli_slowburn_model)
plot(Pcli_slowburn_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_slowburn_model_metrics$.resid) # very significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Pcli_slowburn_model_metrics) #not significant

# identifying outliers
Pcli_slowburn_model_metrics %>% 
  filter(abs(.std.resid) > 3)  # no outliers

#data visually does not look normal so i'm going to use the kruskal-wallis test
```

```{r}
kruskal_test(days_to_removed ~ Treatment, data = Pcli_slowburn)# not significant
```



## (not used) 2-way anova for species and treatment

Change to factors
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  select(Species, ID, Colony, Treatment, CBASS_temp, slowburn, days_to_removed) -> slowburn_summary_data

#what are the sample sizes?
slowburn_summary_data %>% 
  drop_na() %>% 
  group_by(Species, Colony, Treatment) %>% 
  summarise(count = n())

str(slowburn_summary_data)
#make factors: Colony, Puck, Tank, Treatment, Species

slowburn_summary_data %>% 
  mutate_at(vars(Species, ID, Colony, Treatment, CBASS_temp), factor) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) -> slowburn_summary_data
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(days_to_removed ~ Treatment*Species + Colony, data = slowburn_summary_data)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #not significant
```

Run Welch's ANOVA
```{r}
#make interaction term
slowburn_summary_data$Species_Treatment <- interaction(slowburn_summary_data$Species, slowburn_summary_data$Treatment)

#run Welch's anova
oneway.test(days_to_removed ~ Species_Treatment, data = slowburn_summary_data, var.equal = FALSE) #significant

#posthoc test: Games-Howell

slowburn_summary_data %>% 
  ungroup() %>% 
games_howell_test(., days_to_removed ~ Species_Treatment)
```


### Welch's ANOVA for species, colony, and treatment
```{r}
treat_model <- lm(days_to_removed ~ Treatment*Species*Colony, data = slowburn_summary_data)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #not significant

slowburn_summary_data %>% 
  group_by(Species, Treatment, Colony) %>% 
  summarise(count = n())
#not enough samples to do the colony-level differences
```


## separated by max CBASS temp

```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  group_by(Species, Treatment, CBASS_temp) %>% 
  summarise(averagedays = mean(days_to_removed), se = std.error(days_to_removed)) %>%
  ggplot(., aes(x = CBASS_temp, y = averagedays, fill = Treatment)) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = averagedays - se, ymax = averagedays + se), width =
                  .2, position=position_dodge(.9)) +
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  labs(x="CBASS Temperature", y="Number of Days at 32ºC")
#ggsave("daysat32_byCBASS.pdf")
``` 

```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  group_by(Species, Treatment, CBASS_temp, Colony) %>% 
  summarise(averagedays = mean(days_to_removed), se = std.error(days_to_removed)) %>%
  ggplot(., aes(x = CBASS_temp, y = averagedays, fill = Treatment)) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = averagedays - se, ymax = averagedays + se), width =
                  .2, position=position_dodge(.9)) +
  theme_classic() +
  facet_wrap(~Species+Colony, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  labs(x="CBASS Temperature", y="Number of Days at 32ºC")
```

ranges to test: 
low = 28-32
high = 33-37

```{r}
slowburn_summary_data %>% 
  mutate(CBASS_range = case_when(CBASS_temp == "28" ~ "Low",
                                 CBASS_temp == "30" ~ "Low",
                                 CBASS_temp == "32" ~ "Low",
                                 CBASS_temp == "33" ~ "High",
                                 CBASS_temp == "34" ~ "High",
                                 CBASS_temp == "35" ~ "High")) %>% 
  group_by(Species, Treatment, CBASS_range) %>% 
  summarise(averagedays = mean(days_to_removed), se = std.error(days_to_removed)) %>%
  ggplot(., aes(x = CBASS_range, y = averagedays, fill = Treatment)) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = averagedays - se, ymax = averagedays + se), width =
                  .2, position=position_dodge(.9)) +
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  labs(x="CBASS Temperature", y="Number of Days at 32ºC")
#ggsave("CBASS_ranges_slowburn_speciestreatments.png", width = 8, height = 5)
```

Acer
```{r}
slowburn_summary_data %>% 
  mutate(CBASS_range = case_when(CBASS_temp == "28" ~ "Low",
                                 CBASS_temp == "30" ~ "Low",
                                 CBASS_temp == "32" ~ "Low",
                                 CBASS_temp == "33" ~ "High",
                                 CBASS_temp == "34" ~ "High",
                                 CBASS_temp == "35" ~ "High")) %>% 
  filter(Species == "Acropora cervicornis") -> Acer_CBASSrange

Acer_CBASSrange %>% 
  mutate_at(vars(Species, ID, Colony, Treatment, CBASS_temp), factor) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) -> Acer_CBASSrange

treat_model <- lm(days_to_removed ~ Treatment*CBASS_range + Colony, data = Acer_CBASSrange)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_range, data = treat_model_metrics) #not significant
```
two-way anova
```{r}
aov(days_to_removed ~ Treatment*CBASS_range, data = Acer_CBASSrange)

summary(aov(days_to_removed ~ Treatment*CBASS_range, data = Acer_CBASSrange))
 
#capture.output(summary(aov(days_to_removed ~ Treatment*CBASS_range, data = Acer_CBASSrange)), file = "daysuntilremoved_slowburn_anova_table_AcerCBASSrange.csv")

TukeyHSD(aov(days_to_removed ~ Treatment*CBASS_range, data = Acer_CBASSrange))
         
capture.output(TukeyHSD(aov(days_to_removed ~ Treatment*CBASS_range, data = Acer_CBASSrange)), file = "daysuntilremoved_slowburn_anova_tukey_AcerCBASSrange.csv")
```


Pcli
```{r}
slowburn_summary_data %>% 
  mutate(CBASS_range = case_when(CBASS_temp == "28" ~ "Low",
                                 CBASS_temp == "30" ~ "Low",
                                 CBASS_temp == "32" ~ "Low",
                                 CBASS_temp == "33" ~ "High",
                                 CBASS_temp == "34" ~ "High",
                                 CBASS_temp == "35" ~ "High")) %>% 
  filter(Species == "Pseudodiploria clivosa") -> Pcli_CBASSrange

Pcli_CBASSrange %>% 
  mutate_at(vars(Species, ID, Colony, Treatment, CBASS_temp), factor) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) -> Pcli_CBASSrange

treat_model <- lm(days_to_removed ~ Treatment*CBASS_range + Colony, data = Pcli_CBASSrange)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

treat_model_metrics %>% 
  filter(abs(.std.resid) > 3) 

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_range, data = treat_model_metrics) #not significant
```

non-parametric kruskal wallis test
```{r}
Pcli_CBASSrange$Treatment_CBASSrange <- interaction(Pcli_CBASSrange$Treatment, Pcli_CBASSrange$CBASS_range)

kruskal_test(days_to_removed ~ Treatment_CBASSrange, data = Pcli_CBASSrange) #not significant

#posthoc test

dunn.test(Pcli_CBASSrange$days_to_removed, Pcli_CBASSrange$Treatment_CBASSrange, method = "bonferroni")


as.data.frame(dunn.test(Pcli_CBASSrange$days_to_removed, Pcli_CBASSrange$Treatment_CBASSrange, method = "bonferroni")) %>% 
  write_csv("pcli_CBASSrange_posthocdunntest.csv")
```

## (not used) 3-way anova for species, treatment, and CBASS temp

Change to factors
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Removed_Date = ymd(Removed_Date)) %>%
  mutate(start_date="2022-06-25") %>% 
  mutate(start_date = ymd(start_date)) %>% 
  mutate(days_to_removed = Removed_Date - start_date) %>% 
  filter(!days_to_removed == "NA days") %>% 
  select(Species, ID, Colony, Treatment, CBASS_temp, slowburn, days_to_removed) -> slowburn_summary_data

str(slowburn_summary_data)
#make factors: Colony, Puck, Tank, Treatment, Species

slowburn_summary_data %>% 
  mutate_at(vars(Species, ID, Colony, Treatment, CBASS_temp), factor) %>% 
  mutate(days_to_removed = as.numeric(days_to_removed)) -> slowburn_summary_data
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(days_to_removed ~ Treatment*Species*CBASS_temp + Colony, data = slowburn_summary_data)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*CBASS_temp, data = treat_model_metrics) #not significant
```
Run 3-way ANOVA
```{r}
aov(days_to_removed ~ Treatment*Species*CBASS_temp, data = slowburn_summary_data)

summary(aov(days_to_removed ~ Treatment*Species*CBASS_temp, data = slowburn_summary_data))
 
#capture.output(summary(aov(days_to_removed ~ Treatment*Species*CBASS_temp, data = slowburn_summary_data)), file = "daysuntilremoved_slowburn_anova_table.csv")

TukeyHSD(aov(days_to_removed ~ Treatment*Species*CBASS_temp, data = slowburn_summary_data))
         
#capture.output(TukeyHSD(aov(days_to_removed ~ Treatment*Species*CBASS_temp, data = slowburn_summary_data)), file = "daysuntilremoved_slowburn_anova_tukey.csv")
```


## RTL vs Bleaching
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  ggplot(., aes(x=Reason_removed, y=count, fill = Treatment)) +
  geom_col(position = position_dodge()) +
  theme_classic() +
  facet_wrap(~Species)  +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))  +
  theme(text = element_text(size = 15)) +
  labs(x="Category", y="Number of corals")
```

## proportion of bleaching vs RTL

```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  ggplot(., aes(x=Treatment, y=count, fill = Reason_removed)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Species)
#ggsave("proportion_bleaching_RTL_species.pdf")
```

```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Colony, Reason_removed) %>% 
  summarise(count = n()) %>% 
  ggplot(., aes(x=Colony, y=count, fill = Reason_removed)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Species+Treatment, scales = "free_x")
#ggsave("proportion_bleaching_RTL_bycolony.pdf")
```


```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Reason_removed, CBASS_temp) %>% 
  summarise(count = n()) %>% 
  ggplot(., aes(x=CBASS_temp, y=count, fill = Reason_removed)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Species+Treatment)
```
## RTL vs bleaching species separate

### Acer
```{r}
#chi squared test for comparing mortality numbers
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  filter(Species == "Acropora cervicornis") %>% 
  group_by(Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  drop_na() %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  column_to_rownames(var="Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() # significant
```

### Pcli
```{r}
#chi squared test for comparing mortality numbers
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  filter(Species == "Pseudodiploria clivosa") %>% 
  group_by(Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  drop_na() %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  column_to_rownames(var="Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() # significant
```


(not used) RTL vs bleaching (Species*Treatment)
```{r}
#chi squared test for comparing mortality numbers
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  drop_na() %>% 
  unite("Species.Treatment", Species,Treatment, sep = ".") %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  column_to_rownames(var="Species.Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() # significant
```

 post-hoc test for pairwise comparisons (Species*Treatment)
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>% 
  group_by(Species,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  unite("Species.Treatment", Species,Treatment, sep = ".") %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  column_to_rownames(var="Species.Treatment") %>% 
  as.data.frame() %>% 
  pairwise_prop_test() %>% 
  write_csv("pairwise_prop_test_RTLvsbleaching_slowburn.csv")
```


(not used) chi squared test for counts of RTL vs bleaching (Species*Colony*Treatment)
```{r}
#chi squared test for comparing mortality numbers
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  group_by(Species, Colony,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  drop_na() %>% 
  unite("Species.Colony.Treatment", Species,Colony,Treatment, sep = ".") %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  mutate(bleached = if_else(is.na(bleached),0,bleached)) %>% 
  mutate(RTL = if_else(is.na(RTL),0,RTL)) %>% 
  column_to_rownames(var="Species.Colony.Treatment") %>% 
  as.data.frame() %>% 
  chisq_test() # significant
```

 post-hoc test for pairwise comparisons (Species*Colony*Treatment)
```{r}
slowburn_metadata %>% 
  filter(slowburn == "heatstress_32") %>% 
  filter(Removed_Date >= "2022-06-25" | is.na(Removed_Date)) %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL",
                             Reason_removed == "paling" ~ "bleached", 
                             Reason_removed == "bleaching" ~ "bleached")) %>% 
  drop_na(Reason_removed) %>%
  group_by(Species, Colony,Treatment, Reason_removed) %>% 
  summarise(count = n()) %>% 
  unite("Species.Colony.Treatment", Species,Colony,Treatment, sep = ".") %>% 
  pivot_wider(names_from="Reason_removed", values_from = "count") %>% 
  mutate(bleached = if_else(is.na(bleached),0,bleached)) %>% 
  mutate(RTL = if_else(is.na(RTL),0,RTL)) %>% 
  column_to_rownames(var="Species.Colony.Treatment") %>% 
  as.data.frame() %>% 
  pairwise_prop_test() #%>% 
  #write_csv("pairwise_prop_test_RTLvsbleaching_slowburn.csv")
```

# kaplan meier curve for slow burn survivorship

## species tested together
```{r}
survivorship$Species_Treatment <- interaction(survivorship$Species, survivorship$Treatment)
survfit2(Surv(daysToDeath, status) ~ Species_Treatment, data = survivorship) %>% 
  ggsurvfit() +
  labs(x = "Days", y = "Overall survival probability") +
  scale_ggsurvfit() +
  add_pvalue(caption = "Log-rank {p.value}") +
  add_pvalue(location  = "annotation") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "right") 
#ggsave("kmcurve_slowburn.pdf")
```

### Acer survivorship curves
```{r}
p1 <- survivorship %>% 
  filter(Species == "Acropora cervicornis") %>% 
survfit2(Surv(daysToDeath, status) ~ Treatment, data = .) %>% 
  ggsurvfit() +
  labs(x = "Days", y = "Overall survival probability") +
  scale_ggsurvfit() +
  add_pvalue(caption = "Log-rank {p.value}") +
  add_pvalue(location  = "annotation") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "right") +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) 
#significant!!
```

### Pcli survivorship curves
```{r}
p2<- survivorship %>% 
  filter(Species == "Pseudodiploria clivosa") %>% 
survfit2(Surv(daysToDeath, status) ~ Treatment, data = .) %>% 
  ggsurvfit() +
  labs(x = "Days", y = "Overall survival probability") +
  scale_ggsurvfit() +
  add_pvalue(caption = "Log-rank {p.value}") +
  add_pvalue(location  = "annotation") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "right") +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) 
# not significant

```

```{r}
plot_grid(p1,p2)
#ggsave("species_survivorship_slowburn.pdf", width = 10, height = 4)
```


# Species tested separately

## Acer

survivorship by colony
```{r}
survivorship %>% 
  filter(Species == "Acropora cervicornis") -> survivorship_Acer

survivorship_Acer$Colony_Treatment <- interaction(survivorship_Acer$Colony, survivorship_Acer$Treatment)

summary(survfit2(Surv(daysToDeath, status) ~ Colony_Treatment, data = survivorship_Acer))
```

```{r}
survfit2(Surv(daysToDeath, status) ~ Treatment, data = survivorship_Acer) %>% 
  ggsurvfit() +
  labs(x = "Days", y = "Overall survival probability") +
  scale_ggsurvfit() +
  add_pvalue(caption = "Log-rank {p.value}") +
  add_pvalue(location  = "annotation") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "right") +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) 
```

```{r}
survivorship_Acer %>% 
  group_by(Colony, Treatment) %>% 
  summarise(count = n())
```

```{r}
survfit2(Surv(daysToDeath, status) ~ Colony_Treatment, data = survivorship_Acer) %>% 
  ggsurvfit() +
  labs(x = "Days", y = "Overall survival probability") +
  scale_ggsurvfit() +
  add_pvalue(caption = "Log-rank {p.value}") +
  add_pvalue(location  = "annotation") +
  theme(text = element_text(size = 15)) +
  theme(legend.position = "right")
```


Cox Proportional Hazards Ratio
```{r}
survivorship %>% 
  filter(Species == "Acropora cervicornis") -> survivorship_Acer

surv_Acer <- Surv(time = survivorship_Acer$daysToDeath, event = survivorship_Acer$status)

coxph(surv_Acer ~ Treatment, data = survivorship_Acer)
summary(coxph(surv_Acer ~ Treatment, data = survivorship_Acer))
```

## Pcli

Cox Proportional Hazards Ratio
```{r}
survivorship %>% 
  filter(Species == "Pseudodiploria clivosa") -> survivorship_Pcli

surv_Pcli <- Surv(time = survivorship_Pcli$daysToDeath, event = survivorship_Pcli$status)

coxph(surv_Pcli ~ Treatment, data = survivorship_Pcli)
summary(coxph(surv_Pcli ~ Treatment, data = survivorship_Pcli))
```

