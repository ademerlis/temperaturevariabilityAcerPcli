---
title: "colorscores"
author: "allyson_demerlis"
date: "2022-11-30"
output: html_document
---

```{r}
library(tidyverse)
library(readxl)
library(rstatix)
library(plotrix)
library(ggpubr)

Rscoredata <- read_xlsx("data_rscores.xlsx")
Rscoredata %>% 
  select(`Date (Folder Name)`) %>% 
  distinct() #Dates with scores: 3/8-3/18 (Initial), 4/18, 6/21, 7/8 

Rscoredata %>% 
  rename(`Photo ID` = `Image #`) %>% 
  rename(Date = `Date (Folder Name)`) -> Rscoredata

initialphotos <- read_xlsx("photo_metadata.xlsx")
april18 <- read_xlsx("photo_metadata.xlsx", sheet = "april 18")
june21 <- read_xlsx("photo_metadata.xlsx", sheet = "june 21")
july8 <- read_xlsx("photo_metadata.xlsx", sheet = "july 8")

coral_metadata <- readxl::read_xlsx("../metadata.xlsx")

coral_metadata %>% 
  select(Species:CBASS_tank) -> coral_metadata
```


```{r}
str(initialphotos) 
initialphotos %>% 
  select(`Photo ID`:`Coral Position`) -> initialphotos

str(april18)
april18 %>% 
  select(`Photo ID`:`Coral Position`) -> april18

str(june21) 
june21%>% 
  select(`Photo ID`:`Coral Position`) -> june21

str(july8)
july8 %>% 
  select(`Photo ID`:`Coral Position`) -> july8

full_join(initialphotos, april18) %>% 
  full_join(., june21) %>% 
  full_join(., july8) -> allRscores

allRscores

#Tank column depends on time point, as the tank assignments changed throughout timeline. But, should be able to use the Puck ID + Species as the unique identifier

allRscores %>% 
  mutate(Species = case_when(Species == "Acer" ~ "Acropora cervicornis",
                             Species == "Pcli" ~ "Pseudodiploria clivosa")) -> allRscores

allRscores %>% 
  rename(ID = `Puck ID`) -> allRscores #835 rows

full_join(allRscores, coral_metadata, by = c("Species", "ID")) %>% 
  drop_na(`Photo ID`)  -> allmetadata #835 rows 

full_join(allmetadata, Rscoredata, by = c("Date", "Photo ID", "Coral Position")) -> Rintensity_withmetadata

Rintensity_withmetadata %>% 
  select(!Genotype) -> Rintensity_withmetadata

Rintensity_withmetadata$month <- format(Rintensity_withmetadata$Date, "%m")

Rintensity_withmetadata$Date <- as.factor(Rintensity_withmetadata$Date)

Rintensity_withmetadata$month <- as.factor(Rintensity_withmetadata$month)

Rintensity_withmetadata %>% 
  group_by(ID, Species, Colony, Treatment, month) %>% 
  mutate(mean_Rintensity_percoral = mean(Mean)) -> Rintensity_withmetadata

Rintensity_withmetadata %>% 
  filter(is.na(Species)) #photo 4709 is a duplicate from photo 4711 so I already have these values in the spreadsheet

Rintensity_withmetadata %>% 
  drop_na(ID) -> Rintensity_withmetadata
``` 


```{r}
  ggplot(Rintensity_withmetadata,aes(x = month, y= mean_Rintensity_percoral, fill = Treatment)) + 
  geom_boxplot() + 
  theme_classic() +
  facet_wrap(~Species, scales = "free") +
  ylim(0, 255) +
  labs(y = "R Intensity") +
  theme(text = element_text(size = 13)) + 
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```

Calculate percent change for the treatment period 
```{r}
Rintensity_withmetadata %>% 
  ungroup() %>% 
  filter(month == "03" | month == "04") %>% 
  select(ID, Species, Colony, Treatment, Treatment_Tank, month, mean_Rintensity_percoral) %>% 
  distinct() %>% 
  pivot_wider(names_from = "month", values_from = "mean_Rintensity_percoral") %>% 
  mutate(percent_change = ((`03`-`04`)/`03`)*100) -> percentchange

percentchange %>% 
  drop_na() -> percentchange #7 corals were not measured in the second time point 
```


```{r}
 ggplot(percentchange,aes(x = Colony, y= percent_change, fill = Treatment)) + 
  geom_boxplot() + 
  theme_classic() +
  facet_wrap(~Species, scales = "free") +
  labs(y = "Percent Change in R-Intensity") +
  theme(text = element_text(size = 15)) + 
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))
```

```{r}
percentchange %>% 
  dplyr::group_by(Species, Treatment) %>% 
  dplyr::mutate(mean_percent_change = mean(percent_change), se_percent_change = sd(percent_change)) %>% 
  ggplot(., aes(x = Species, y = mean_percent_change))+
  theme_classic()+
  geom_jitter(aes(y=percent_change, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = Species, ymax = mean_percent_change+se_percent_change, ymin = mean_percent_change-se_percent_change, color = Treatment), width = .2, position = position_dodge(width=0.8)) +
  #scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = Species, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  #scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  #facet_wrap(~Species, scales = "free_x", dir = "v") +
  theme(text = element_text(size = 15))
```



Calculate percent change for the slow-burn heat stress assay
```{r}

```

 