---
title: "survivorship"
author: "allyson_demerlis"
date: "2023-02-20"
output: html_document
---
# Load data and packages
```{r}
metadata <- readxl::read_xlsx("../metadata.xlsx")

library(tidyverse)
library(janitor)
library(rstatix)
```

Tidy data 

There are two columns of significance for survivorship, Removed_Date and Mortality_Date. At some point, tank 7 become the recovery tank for corals. If the coral had a lot of tissue on it but looked stressed, it was removed from either the CBASS tank or the slow burn heat stress assay (high temp) into the recovery tank at 28ºC. That date of transfer was recorded in the column "Removed_Date". The column "Mortality_Date" refers to corals that were removed from any tank and died. 

```{r}
metadata %>% 
  filter(is.na(Removed_Date)) #71 corals don't have a removed date

metadata %>% 
  filter(is.na(mortality_date)) #118 corals dont' have a mortality date

metadata %>% 
  filter(is.na(Removed_Date) & is.na(mortality_date)) #48 corals don't have either. But if they weren't assigned a heat-stress tank, that should indicate that they were removed/died before 06/15/2022

```


# CBASS Mortality

Number of corals that died due to CBASS
```{r}
metadata %>% 
  dplyr::filter(Removed_Date >= "2022-04-20" & Removed_Date <= "2022-04-25") %>% 
  drop_na(Species, Treatment, Reason_removed) %>% 
  group_by(Reason_removed, Species, Treatment) %>% 
  summarize(count = n()) %>% 
  ggplot(., aes(x=Reason_removed, y=count, fill = Treatment)) +
  geom_col(position = position_dodge()) +
  theme_classic() +
  facet_wrap(~Species, scales = "free")  +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  theme(text = element_text(size = 15)) +
  labs(x="Category", y="Number of corals") + 
  coord_flip()
```


```{r}
#proportion of corals that died during/post-CBASS versus the total number of corals that went into the CBASS
mortality_data %>% 
  dplyr::filter(Removed_Date >= "2022-04-21" & Removed_Date <= "2022-04-25") %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "post-CBASS RTL" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL")) %>% 
  drop_na(Species, Treatment) %>% 
  group_by(Species, Treatment) %>% 
  summarize(count_RTL = n()) -> RTL_species_treatment_count
```



```{r}
mortality_data %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% #remove everything that was removed before CBASS so you only account for RTL due to CBASS
  group_by(Species, Treatment) %>% 
  summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_count) %>% 
  mutate(proportion_RTL = (count_RTL/count_total)*100) %>% #need total number of corals that were alive at that time
  ggplot(., aes(x=Species, y=proportion_RTL, fill = Treatment)) +
  geom_col(position = position_dodge()) +
  theme_classic() +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  theme(text = element_text(size = 15)) +
  labs(y="% Mortality due to RTL")  + 
  coord_flip() +
  theme(text = element_text(size = 20)) 
#ggsave("coralmortalityduetoCBASS.png", width = 10, height =6)
```


```{r}
#chi squared test for comparing mortality numbers
mortality_data %>% 
  dplyr::filter(!Removed_Date <= "2022-04-20" | is.na(Removed_Date)) %>% 
  group_by(Species, Treatment) %>% 
  summarize(count_total = n()) %>% 
  full_join(., RTL_species_treatment_count) %>% 
  mutate(count_survived = count_total - count_RTL) %>% 
  filter(Species == "Acropora cervicornis") %>% 
  ungroup() %>% 
  dplyr::select(Treatment, count_RTL, count_survived) %>% 
  mutate(Treatment = as.factor(Treatment)) %>% 
  column_to_rownames(var = "Treatment")-> Acer_contingencytable

chisq_test(Acer_contingencytable)

goodnessOfFitTest(Acer_contingencytable)

mortality_data %>% 
  dplyr::filter(Removed_Date >= "2022-04-21" & Removed_Date <= "2022-04-25") %>% 
  mutate(Reason_removed = case_when(Reason_removed == "dead" ~ "RTL",
                             Reason_removed == "post-CBASS RTL" ~ "RTL",
                             Reason_removed == "RTL" ~ "RTL")) %>% 
  drop_na(Species, Treatment, Reason_removed) %>% 
  select(Species, Treatment, Reason_removed)
```



# Slow-Burn Mortality

Heat-stress at 32ºC was reached on June 25. 
```{r}
metadata %>% 
  filter(Removed_Date >= "2022-06-25")

metadata %>% 
  filter(is.na(Removed_Date)) # hmm this is suspect.
```

