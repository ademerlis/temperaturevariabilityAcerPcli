---
title: "immunecellassay"
author: "allyson_demerlis"
date: "2023-02-28"
output: html_document
---

# percent comparison beginning and end of treatment (unnormalized)
(average of all technical replicates)

sample sizes
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  select(TimePoint:ID, Treatment:mean_replicate_percent_perID) %>% 
  distinct() %>% 
  dplyr::group_by(num_days, Species, Genotype, Treatment) %>% 
  dplyr::summarise(count = n())
```
create data frame for WGCNA
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  select(TimePoint:ID, Treatment:mean_replicate_percent_perID) %>% 
  distinct() %>% 
  write_csv("phagocytosis_alltimepoints.csv")
```


## species:treatment comparison
```{r}
plot1 <- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::group_by(num_days, Species, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species, scales = "free_x", dir = "v") +
  theme(text = element_text(size = 15)) +
  ylim(0, 20) +
  theme(legend.position="none")
  
#ggsave("percentcells_speciestreatments_overtime.pdf", width = 8, height = 5)
```

boxplot
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = mean_replicate_percent_perID, fill = Treatment))+
  geom_boxplot() +
  facet_wrap(~Species) +
  theme_classic()+
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  theme(text = element_text(size = 15))
#ggsave("percentcells_species_boxplots.pdf")
```

boxplot normalized to control
```{r}
percent_cells_df %>% 
  drop_na(Percent) %>% 
  dplyr::group_by(Species, Genotype, num_days, Treatment) %>% 
  dplyr::summarise(average_percent = mean(Percent)) %>% 
  pivot_wider(names_from="Treatment", values_from="average_percent") %>% 
  mutate(corrected_treated = Treated - Untreated, Control = Untreated - Untreated) %>%
  select(Species:num_days, corrected_treated, Control) %>% 
  pivot_longer(corrected_treated:Control, names_to = "Treatment", values_to = "average_percent") %>% 
  ggplot(., aes(x=num_days, y= average_percent, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species) +
  theme_classic() +
  scale_fill_manual(labels=c("Untreated", "Treated"), values = c("#60DBDB","#F54A34")) +
  labs(x="Day", y="% Immune Activity (Corrected)")+
  theme(text = element_text(size = 14))
```


### Statistics

Change to factors
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> percent_cells_speciestreatments

str(percent_cells_speciestreatments)

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Treatment, num_days), factor) -> percent_cells_speciestreatments
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(mean_replicate_percent_perID ~ Treatment*Species*num_days + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*num_days, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#make interaction term
percent_cells_speciestreatments$Treatment_Species_numdays <- interaction(percent_cells_speciestreatments$Treatment, percent_cells_speciestreatments$Species, percent_cells_speciestreatments$num_days)

#run Welch's anova
oneway.test(mean_replicate_percent_perID ~ Treatment_Species_numdays, data = percent_cells_speciestreatments, var.equal = FALSE) #significant

#posthoc test: Games-Howell

games_howell_test(percent_cells_speciestreatments, mean_replicate_percent_perID ~ Treatment_Species_numdays) #%>% 
 # write_csv("percentcells_speciestreatment_posthoc.csv")
```



## separated by genotype and species
```{r}
plot2 <- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T0" | TimePoint == "T2") %>% 
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Species, Genotype, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Number of Days")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species+Genotype, scales = "free_x") +
  theme(text = element_text(size = 15)) +
  ylim(0, 20)
```


```{r}
plot_grid(plot1, plot2, ncol = 2, rel_widths = c(1,2))

#ggsave("percentphagocyticactivity_species_genets.pdf", width = 10, height = 5)
```

### Statistics

Change to factors

Separate species 

#### Acer
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  filter(Species == "Acer") %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> Acer_percent_cells 

str(Acer_percent_cells)

Acer_percent_cells %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment, num_days), factor) -> Acer_percent_cells
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
Acer_model <- lm(mean_replicate_percent_perID ~ Treatment*Genotype*num_days + Tank, data = Acer_percent_cells)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype*num_days, data = Acer_model_metrics) #not significant

# identifying outliers
Acer_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#make interaction term
Acer_percent_cells$Treatment_Genotype_numdays <- interaction(Acer_model_metrics$Treatment, Acer_percent_cells$Genotype, Acer_percent_cells$num_days)

# kruskal wallis test
kruskal_test(mean_replicate_percent_perID ~ Treatment_Genotype_numdays, data = Acer_percent_cells)#significant

#posthoc test
as.data.frame(dunn.test(Acer_percent_cells$mean_replicate_percent_perID, Acer_percent_cells$Treatment_Genotype_numdays, method = "bonferroni")) %>% 
  write_csv("Acer_percent_cells_genet_posthoc.csv")

```

#### Pcli
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  filter(Species == "Pcli") %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> Pcli_percent_cells 

str(Pcli_percent_cells)

Pcli_percent_cells %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment, num_days), factor) -> Pcli_percent_cells
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
Pcli_model <- lm(mean_replicate_percent_perID ~ Treatment*Genotype*num_days + Tank, data = Pcli_percent_cells)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype*num_days, data = Pcli_model_metrics) #not significant

# identifying outliers
Pcli_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers

#run two-way anova
summary(aov(mean_replicate_percent_perID ~ Treatment*Genotype*num_days, data = Pcli_percent_cells)) #only num of days is significant

#capture.output(TukeyHSD(aov(mean_replicate_percent_perID ~ Treatment*Genotype*num_days, data = Pcli_percent_cells)), file = "pcli_phagocytosis_posthoc.csv")
```




# Normalized percent comparison all time points

```{r}
#calculate mean control for a given species, genotype, time point. Then, subtract that mean from the mean percent for the corresponding treated coral. Now, the "control" percent phagocytosis should be zero, and then treated group will be based on that zeroing.

p1<- percent_cells_df %>% 
  drop_na(Percent) %>% 
  dplyr::group_by(Species, num_days, Treatment) %>% 
  dplyr::summarise(average_percent = mean(Percent)) %>% 
  pivot_wider(names_from="Treatment", values_from="average_percent") %>% 
  mutate(corrected_treated = Treated - Untreated, Control = Untreated - Untreated) %>%
  select(Species:num_days, corrected_treated, Control) %>% 
  pivot_longer(corrected_treated:Control, names_to = "Treatment", values_to = "average_percent") %>% 
  ggplot(., aes(x=num_days, y= average_percent, color = Treatment)) +
  geom_segment(aes(x = num_days, xend = num_days, y = 0, yend = average_percent), color = "#F54A34") + # Sticks
  geom_point(aes(color = Treatment), size = 3) +
  facet_wrap(~Species) +
  theme_classic() +
  scale_color_manual(labels=c("Untreated", "Treated"), values = c("#60DBDB","#F54A34")) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "#60DBDB", size = 1, alpha = 0.4) +
  geom_vline(xintercept = 0.8, linetype = "solid", color = "black", size = 1, alpha = 0.1) +
  geom_vline(xintercept = 3.2, linetype = "solid", color = "black", size = 1, alpha = 0.1) +
  labs(x="Day", y="% Immune Activity (Corrected)")+
  theme(text = element_text(size = 14)) +
  theme(legend.position="none")
```

```{r}
p2<- percent_cells_df %>% 
  drop_na(Percent) %>% 
  dplyr::group_by(Species, Genotype, num_days, Treatment) %>% 
  dplyr::summarise(average_percent = mean(Percent)) %>% 
  pivot_wider(names_from="Treatment", values_from="average_percent") %>% 
  mutate(corrected_treated = Treated - Untreated, Control = Untreated - Untreated) %>%
  select(Species:num_days, corrected_treated, Control) %>% 
  pivot_longer(corrected_treated:Control, names_to = "Treatment", values_to = "average_percent") %>% 
  ggplot(., aes(x=num_days, y= average_percent, color = Treatment)) +
  geom_segment(aes(x = num_days, xend = num_days, y = 0, yend = average_percent), color = "#F54A34") + # Sticks
  geom_point(aes(color = Treatment), size = 3) +
  facet_wrap(~Species+Genotype) +
  theme_classic() +
  scale_color_manual(labels=c("Untreated", "Treated"), values = c("#60DBDB","#F54A34")) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "#60DBDB", size = 1, alpha = 0.4) +
  geom_vline(xintercept = 0.8, linetype = "solid", color = "black", size = 1, alpha = 0.1) +
  geom_vline(xintercept = 3.2, linetype = "solid", color = "black", size = 1, alpha = 0.1) +
  labs(x="Day", y="% Immune Activity (Corrected)")+
  theme(text = element_text(size = 14))
```

```{r}
plot_grid(p1, p2, rel_widths = c(1.5,2))
#ggsave("immunecells_corrected_lollipop.pdf", width = 12, height = 5)
```

# Normalization to untreated day 0 genotype percentage cells

```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" & Treatment == "Untreated") %>% 
  group_by(Species, Genotype) %>% 
  dplyr::summarise(mean_untreated_day0_genet = mean(mean_replicate_percent_perID)) -> untreated_day0_immunecells

percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "28") %>% 
  right_join(., untreated_day0_immunecells, by = c("Species", "Genotype")) %>% 
  mutate(relative_activity = ((mean_replicate_percent_perID-mean_untreated_day0_genet)/mean_untreated_day0_genet)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Species, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) 
#ggsave("normalized_percentchangeimmuneactivity_boxplot_species.pdf")
```

separating genotype
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "28") %>% 
  right_join(., untreated_day0_immunecells, by = c("Species", "Genotype")) %>% 
  mutate(relative_activity = ((mean_replicate_percent_perID-mean_untreated_day0_genet)/mean_untreated_day0_genet)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Genotype, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) +
  facet_wrap(~Species, scales = "free_x")
```


### Statistics

Change to factors
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") -> percent_cells_speciestreatments

str(percent_cells_speciestreatments)

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Treatment, num_days), factor) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  filter(num_days == "0" & Treatment == "Untreated") %>% 
  group_by(Species, Genotype) %>% 
  dplyr::summarise(mean_untreated_day0_genet = mean(mean_replicate_percent_perID)) -> untreated_day0_immunecells

percent_cells_speciestreatments %>% 
  filter(num_days == "28") %>% 
  right_join(., untreated_day0_immunecells, by = c("Species", "Genotype")) %>% 
  mutate(relative_activity = ((mean_replicate_percent_perID-mean_untreated_day0_genet)/mean_untreated_day0_genet)*100) -> relative_activity_df

#save data frame for WGCNA
#write_csv(relative_activity_df, "relative_immune_activity.csv")
```


Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = relative_activity_df)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

relative_activity_df %>% filter(relative_activity < 43) -> relative_activity_df

#rerun tests

treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = relative_activity_df)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

#make interaction term
relative_activity_df$Treatment_Species <- interaction(relative_activity_df$Treatment, relative_activity_df$Species)

# kruskal wallis test
kruskal_test(relative_activity ~ Treatment_Species, data = relative_activity_df) #not significant

#posthoc test
as.data.frame(dunn.test(relative_activity_df$relative_activity, relative_activity_df$Treatment_Species, method = "bonferroni"))



  write_csv("Acer_percent_cells_genet_posthoc.csv")
```

### archive

Colony x treatment (can't statistically test this because the sample size is 2 per treatment for each colony)
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Genotype, y=relative_activity, color= Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15)) 
#ggsave("percentchange_immunecellactivity_treatment.pdf")
```

Acer
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Acer") -> cells_Acer
```


```{r}
Acer_model <- lm(relative_activity ~ Treatment*Genotype + Tank, data = cells_Acer)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype, data = Acer_model_metrics) #very significant

#welch's anova
#make interaction term
cells_Acer$Treatment_Colony <- interaction(cells_Acer$Treatment, cells_Acer$Genotype)

#run Welch's anova
oneway.test(relative_activity ~ Treatment_Colony, data = cells_Acer, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(cells_Acer$relative_activity, cells_Acer$Treatment_Colony, method = "bonferroni"))
```

Pcli
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Pcli") -> cells_Pcli
```


```{r}
Pcli_model <- lm(relative_activity ~ Treatment*Genotype + Tank, data = cells_Pcli)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype, data = Pcli_model_metrics) #very significant

# identifying outliers
Pcli_model_metrics %>% 
  filter(abs(.std.resid) > 3)

#welch's anova
#make interaction term
cells_Pcli$Treatment_Colony <- interaction(cells_Pcli$Treatment, cells_Pcli$Genotype)

#run Welch's anova
oneway.test(relative_activity ~ Treatment_Colony, data = cells_Pcli, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(cells_Pcli$relative_activity, cells_Pcli$Treatment_Colony, method = "bonferroni"))
```

