---
title: "immunecellassay_take2"
author: "allyson_demerlis"
date: "2024-03-21"
output: html_document
---

# Load libraries and datasets
```{r}
library(tidyverse)
library(plotrix)
library(ggpubr)
library(rstatix)
library(cowplot)
library(dunn.test)
library(Rmisc)
library(plyr)
library(dplyr)

percent_cells_df <- read_csv("Grace_percentcells_alldata.csv") 

percent_cells_df%>% 
    mutate(Treatment = case_when(Treatment == "Control" ~ "Untreated",
                               Treatment == "Variable" ~ "Treated")) -> percent_cells_df

#there's one outlier to remove right off the bat: T1	Pcli	B	P9	r2	Percent=111.50	T1	Untreated
percent_cells_df %>% 
  filter(!(TimePoint=="T1" & Species == "Pcli" & Genotype == "B" & Treatment == "Untreated" & ID == "P9" & Replicate == "r2")) -> percent_cells_df

#replicates are technical replicates of the same coral fragment
#time points:
#T0 = initial pre-treatment (March 22)
#T1 = one week into treatment (March 30)
#T2 = end of treatment (April 20)
#follow-up = post CBASS and treatment follow-up (June 1)

percent_cells_df %>% 
  mutate(num_days = case_when(TimePoint == "T0" ~ "0",
                              TimePoint == "T1" ~ "7",
                              TimePoint == "T2" ~ "28",
                              TimePoint == "FollowUp" ~ "71")) %>%
  mutate(Date = case_when(TimePoint == "T0" ~ "2022-03-22",
                              TimePoint == "T1" ~ "2022-03-30",
                              TimePoint == "T2" ~ "2022-04-20",
                              TimePoint == "FollowUp" ~ "2022-06-01")) %>% 
  mutate(num_days = as.factor(num_days)) %>% 
  mutate(num_days = fct_relevel(num_days, "0", "7", "28", "71")) -> percent_cells_df

#write_csv(percent_cells_df, "immunecells_tidydata.csv")
```

# percent immune activity per species, colony, and treatment over the entire experiment period
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(!c(Replicate,Percent)) %>% 
  distinct() %>% 
  ggplot(., aes(x=num_days, y=mean_replicate_percent_perID, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species + Genotype) +
  theme_classic() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) 
```

# calculate percent change for day 28 to day 0
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Species, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) 
#ggsave("percentchange_immunecellactivity_treatment.pdf")
```

## Stats

### Species x treatment

Change to factors
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment), factor) -> percent_cells_speciestreatments
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

percent_cells_speciestreatments %>% 
  filter(!(Treatment=="Treated" & Species =="Pcli" & Genotype == "B" & Tank == "T3")) -> percent_cells_speciestreatments

treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

#welch's anova
#make interaction term
percent_cells_speciestreatments$Species_Treatment <- interaction(percent_cells_speciestreatments$Species, percent_cells_speciestreatments$Treatment)

#run Welch's anova
oneway.test(relative_activity ~ Species_Treatment, data = percent_cells_speciestreatments, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(percent_cells_speciestreatments$relative_activity, percent_cells_speciestreatments$Species_Treatment, method = "bonferroni"))
```

### species separate

Create master tidy data 
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment), factor) -> percent_cells_speciestreatments
```

Acer
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Acer") -> cells_Acer
```


```{r}
Acer_model <- lm(relative_activity ~ Treatment + Genotype + Tank, data = cells_Acer)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Acer_model_metrics) #not significant
```
Acer one-way ANOVA
```{r}
aov(relative_activity ~ Treatment, data = cells_Acer)

summary(aov(relative_activity ~ Treatment, data = cells_Acer)) #not significant
```


Pcli
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Pcli") -> cells_Pcli
```


```{r}
Pcli_model <- lm(relative_activity ~ Treatment + Genotype + Tank, data = cells_Pcli)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Pcli_model_metrics) #not significant
```
Pcli one-way ANOVA
```{r}
aov(relative_activity ~ Treatment, data = cells_Pcli)

summary(aov(relative_activity ~ Treatment, data = cells_Pcli)) #not significant
```



### archive

Colony x treatment (can't statistically test this because the sample size is 2 per treatment for each colony)
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Genotype, y=relative_activity, color= Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15)) 
#ggsave("percentchange_immunecellactivity_treatment.pdf")
```

Acer
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Acer") -> cells_Acer
```


```{r}
Acer_model <- lm(relative_activity ~ Treatment*Genotype + Tank, data = cells_Acer)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype, data = Acer_model_metrics) #very significant

#welch's anova
#make interaction term
cells_Acer$Treatment_Colony <- interaction(cells_Acer$Treatment, cells_Acer$Genotype)

#run Welch's anova
oneway.test(relative_activity ~ Treatment_Colony, data = cells_Acer, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(cells_Acer$relative_activity, cells_Acer$Treatment_Colony, method = "bonferroni"))
```

Pcli
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Pcli") -> cells_Pcli
```


```{r}
Pcli_model <- lm(relative_activity ~ Treatment*Genotype + Tank, data = cells_Pcli)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Genotype, data = Pcli_model_metrics) #very significant

# identifying outliers
Pcli_model_metrics %>% 
  filter(abs(.std.resid) > 3)

#welch's anova
#make interaction term
cells_Pcli$Treatment_Colony <- interaction(cells_Pcli$Treatment, cells_Pcli$Genotype)

#run Welch's anova
oneway.test(relative_activity ~ Treatment_Colony, data = cells_Pcli, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(cells_Pcli$relative_activity, cells_Pcli$Treatment_Colony, method = "bonferroni"))
```