---
title: "immunecellassay"
author: "allyson_demerlis"
date: "2024-08-16"
output: html_document
---

# Load libraries and datasets
```{r}
library(tidyverse)
library(plotrix)
library(ggpubr)
library(rstatix)
library(cowplot)
library(dunn.test)
library(Rmisc)
library(plyr)
library(dplyr)

percent_cells_df <- read_csv("immunecellsdata.csv")
```


# percent immune activity per species, colony, and treatment over the entire experiment period (all technical replicates)
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  ggplot(., aes(x=num_days, y=Percent, color = Treatment)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Species + Genotype) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 15)) 
```


# percent immune activity per species, colony, and treatment over the entire experiment period (mean technical replicate)
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species:ID, Tank:num_days, mean_replicate_percent_perID) %>% 
  ggplot(., aes(x=num_days, y=mean_replicate_percent_perID, color = Treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Species + Genotype) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 15)) +
  labs(x="Days in Treatment")
#ggsave("immunecellactivityovertime_bothspecies_genotypes.pdf", width = 10, height = 7)
```


```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species:ID, Tank:num_days, mean_replicate_percent_perID) %>% 
  ggplot(., aes(x=num_days, y=mean_replicate_percent_perID, color = Treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Species) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 15)) +
  labs(x="Days in Treatment")
#ggsave("immunecellactivityovertime_bothspecies.pdf", width = 10, height = 7)
```

  

  

# calculate percent change for day 28 to day 0
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Species, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) 
#ggsave("percentchange_immunecellactivity_treatment.pdf")
```

## Stats

### Species x treatment

Change to factors
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment), factor) -> percent_cells_speciestreatments
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

percent_cells_speciestreatments %>% 
  filter(!(Treatment=="Treated" & Species =="Pcli" & Genotype == "B" & Tank == "T3")) -> percent_cells_speciestreatments

treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

#welch's anova
#make interaction term
percent_cells_speciestreatments$Species_Treatment <- interaction(percent_cells_speciestreatments$Species, percent_cells_speciestreatments$Treatment)

#run Welch's anova
oneway.test(relative_activity ~ Species_Treatment, data = percent_cells_speciestreatments, var.equal = FALSE) #not significant

#posthoc test
as.data.frame(dunn.test(percent_cells_speciestreatments$relative_activity, percent_cells_speciestreatments$Species_Treatment, method = "bonferroni"))
```

### species separate

Create master tidy data 
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "28") %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`28`-`0`)/`0`)*100) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment), factor) -> percent_cells_speciestreatments
```

Acer
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Acer") -> cells_Acer
```


```{r}
Acer_model <- lm(relative_activity ~ Treatment + Genotype + Tank, data = cells_Acer)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Acer_model_metrics) #not significant
```
Acer one-way ANOVA
```{r}
aov(relative_activity ~ Treatment, data = cells_Acer)

summary(aov(relative_activity ~ Treatment, data = cells_Acer)) #not significant
```


Pcli
```{r}
percent_cells_speciestreatments %>% 
  filter(Species == "Pcli") -> cells_Pcli
```


```{r}
Pcli_model <- lm(relative_activity ~ Treatment + Genotype + Tank, data = cells_Pcli)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_model_metrics$.resid) #not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = Pcli_model_metrics) #not significant
```
Pcli one-way ANOVA
```{r}
aov(relative_activity ~ Treatment, data = cells_Pcli)

summary(aov(relative_activity ~ Treatment, data = cells_Pcli)) #not significant
```


