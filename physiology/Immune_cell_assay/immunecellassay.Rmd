---
title: "immunecellassay"
author: "allyson_demerlis"
date: "2024-08-16"
output: html_document
---

# Load libraries and datasets
```{r}
library(tidyverse)
library(plotrix)
library(ggpubr)
library(rstatix)
library(cowplot)
library(dunn.test)
library(Rmisc)
library(plyr)
library(dplyr)
library(lme4)
library(emmeans)
library(modelsummary)
library(car)
library(multcomp)

percent_cells_df <- read_csv("immunecellsdata.csv")
```

# percent immune activity over the entire experiment period (mean technical replicate)

## species x treatment
```{r}
plot1<-percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species:ID, Tank:num_days, mean_replicate_percent_perID) %>% 
  ggplot(., aes(x=num_days, y=mean_replicate_percent_perID, color = Treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Species,ncol = 1, nrow = 2) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 15)) +
  labs(x="Days in Treatment") +
  theme(legend.position="none")
#ggsave("immunecellactivityovertime_bothspecies.pdf", width = 10, height = 7)
```

## species x colony x treatment
```{r}
plot2<-percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species:ID, Tank:num_days, mean_replicate_percent_perID) %>% 
  ggplot(., aes(x=num_days, y=mean_replicate_percent_perID, color = Treatment)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Species + Genotype) +
  ylab("% Immune Cell Activity")+
  theme_classic() +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 15)) +
  labs(x="Days in Treatment")
#ggsave("immunecellactivityovertime_bothspecies_genotypes.pdf", width = 10, height = 7)
```
  
## combined plot
```{r}
plot_grid(plot1, plot2, ncol = 2, rel_widths = c(1.5, 2))
ggsave("percentimmunecellactivity_species_genet.pdf", width = 10, height = 5)
```

  
# Mixed effects GLMM (fixed: treatment, colony, timepoint; random: tank)

First, make the dataset with percentages as the mean technical replicates per coral fragment (r1, r2, and r3)
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species:ID, Tank:num_days, mean_replicate_percent_perID) -> immmunecells_meanreps

immmunecells_meanreps %>% 
  dplyr::mutate(across(c(Species, Genotype, ID, Tank, Treatment, num_days), as.factor)) -> immmunecells_meanreps

immmunecells_meanreps %>% 
  filter(Species == "Acer") %>% 
  distinct() -> immmunecells_meanreps_Acer

immmunecells_meanreps %>% 
  filter(Species == "Pcli") %>% 
  distinct() -> immmunecells_meanreps_Pcli
```


```{r}
#although this was measured over time, it is not repeated measures because different corals were measured at each time point. so coral ID is not included in this formula
Acer_model <- lmer(mean_replicate_percent_perID~Treatment*Genotype*num_days + (1|Tank), data = immmunecells_meanreps_Acer)
summary(Acer_model)
Anova(Acer_model, type = "II", test.statistic = "F")

Pcli_model <- lmer(mean_replicate_percent_perID~Treatment*Genotype*num_days + (1|Tank), data = immmunecells_meanreps_Pcli)
summary(Pcli_model)
Anova(Pcli_model, type = "II", test.statistic = "F")
```

## Model fitting and assumptions diagnostic

Acer
```{r}
x = residuals(Acer_model)
plot(fitted(Acer_model), x) 
qqnorm(x); qqline(x) # qq plot to check for normal distribution of residuals
hist(x) # histogram of residuals to check for normal distribution of residuals

Anova(Acer_model, type = "II", test.statistic = "F")
capture.output(Anova(Acer_model, type = "II", test.statistic = "F"), file = "Acer_immunecells_model_ANOVA.csv")
```

Pcli
```{r}
x = residuals(Pcli_model)
plot(fitted(Pcli_model), x) 
qqnorm(x); qqline(x) # qq plot to check for normal distribution of residuals
hist(x) # histogram of residuals to check for normal distribution of residuals

Anova(Pcli_model, type = "II", test.statistic = "F")
capture.output(Anova(Pcli_model, type = "II", test.statistic = "F"), file = "Pcli_immunecells_model_ANOVA.csv")
```

## Statistical pairwise comparisons

Acer
```{r}
#treatment + timepoint
Acer_emms <- emmeans(Acer_model, pairwise ~ Treatment*num_days, weights = "proportional", adjust="none")
# P.value adjustment of the Bonferroni
rbind(Acer_emms$contrasts) # Tukey HSD with Bonferroni P value adjustment, and kenward-roger degrees of freedom method
#no significant difference between treatments at either time point
capture.output(rbind(Acer_emms$contrasts), file = "Acer_Tukey_treatmenttimepoint.csv")


#colony + treatment + timepoint
Acer_emms <- emmeans(Acer_model, pairwise ~ Treatment*Genotype*num_days, weights = "proportional", adjust="none")
# P.value adjustment of the Bonferroni
rbind(Acer_emms$contrasts) # Tukey HSD with Bonferroni P value adjustment, and kenward-roger degrees of freedom method
capture.output(rbind(Acer_emms$contrasts), file = "Acer_Tukey_colonytreatmenttimepoint.csv")
```

Pcli
```{r}
#treatment + timepoint
Pcli_emms <- emmeans(Pcli_model, pairwise ~ Treatment*num_days, weights = "proportional", adjust="none")
# P.value adjustment of the Bonferroni
rbind(Pcli_emms$contrasts) # Tukey HSD with Bonferroni P value adjustment, and kenward-roger degrees of freedom method
#no significant difference between treatments at either time point
capture.output(rbind(Pcli_emms$contrasts), file = "Pcli_Tukey_treatmenttimepoint.csv")

#colony + treatment + timepoint
Pcli_emms <- emmeans(Pcli_model, pairwise ~ Treatment*Genotype*num_days, weights = "proportional", adjust="none")
# P.value adjustment of the Bonferroni
rbind(Pcli_emms$contrasts) # Tukey HSD with Bonferroni P value adjustment, and kenward-roger degrees of freedom method
capture.output(rbind(Pcli_emms$contrasts), file = "Pcli_Tukey_colonytreatmenttimepoint.csv")
```




