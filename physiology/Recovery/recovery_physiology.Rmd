---
title: "recovery_physiology"
author: "allyson_demerlis"
date: "2024-01-12"
output: html_document
---
# Load libraries
```{r}
library(tidyverse)
library(readxl)
library(rstatix)
library(plotrix)
library(ggpubr)
library(cowplot)
library(dunn.test)
```

# Import data
```{r}
coral_metadata <- readxl::read_xlsx("../metadata.xlsx")

fvfm <- read.csv("../Photosynthetic_efficiency/ipam_tidy_data.csv")

Rscoredata <- read_xlsx("../R_intensity//data_rscores.xlsx")

april18 <- read_xlsx("../R_intensity/photo_metadata.xlsx", sheet = "april 18")
june21 <- read_xlsx("../R_intensity/photo_metadata.xlsx", sheet = "june 21")

percent_cells_df <- read_csv("../Immune_cell_assay/Grace_percentcells_alldata.csv") 
```

# Tidy fvfm data
```{r}
treatment_metadata<-fvfm %>% 
  select(Puck, Treatment) %>% 
  distinct() %>% 
  drop_na() #282 corals
  
fvfm %>% 
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  select(fvfm, Puck, Colony, Date, Species) %>% 
  filter(Date == "4/20/22" | Date == "4/22/22" | Date == "5/25/22") %>% 
  full_join(., treatment_metadata, by = "Puck") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  select(!"NA") %>% 
  drop_na() %>% 
  mutate(change=(`5/25/22`-`4/22/22`)/`4/22/22`*100) -> fvfm_recovery_change

fvfm_recovery_change %>% 
  arrange(change) #there is one outlier

fvfm_recovery_change %>% 
  filter(change > -39) -> fvfm_recovery_change
```

## fvfm species treatment boxplot
```{r}
fvfm_recovery_change %>% 
  ggplot(., aes(x = Species, y = change, fill = Treatment)) +
  theme_classic()+
  geom_boxplot() +  
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline in Fv/Fm")+
  theme(text = element_text(size = 15))
#ggsave("fvfmdecline_recovery_boxplot_species.pdf")
```

## stats species x treatments
```{r}
fvfm_recovery_change %>% 
  select(Puck:Treatment, change) %>% 
  mutate_at(vars(Colony, Puck, Treatment, Species), factor) -> fvfm_recovery_stats

fvfm_recovery_stats

recovery_model_1 <- lm(change ~ Treatment*Species + Colony, data = fvfm_recovery_stats)
recovery_model_metrics_1 <- augment(recovery_model_1)
plot(recovery_model_1)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(recovery_model_metrics_1$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = recovery_model_metrics_1) #not significant

# identifying outliers
recovery_model_metrics_1 %>% 
  filter(abs(.std.resid) > 3) 
# 1 outlier

fvfm_recovery_stats %>% 
  filter(change < 39) -> fvfm_recovery_stats

recovery_model_1 <- lm(change ~ Treatment*Species + Colony, data = fvfm_recovery_stats)
recovery_model_metrics_1 <- augment(recovery_model_1)
plot(recovery_model_1)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(recovery_model_metrics_1$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = recovery_model_metrics_1) #not significant
```

### two-way ANOVA
```{r}
aov(change ~ Treatment*Species, data = fvfm_recovery_stats)

summary(aov(change ~ Treatment*Species, data = fvfm_recovery_stats))

TukeyHSD(aov(change ~ Treatment*Species, data = fvfm_recovery_stats))
         
```


## stats species separate

### Acer
```{r}
fvfm_recovery_change %>% 
  select(Puck:Treatment, change) %>% 
  mutate_at(vars(Colony, Puck, Treatment, Species), factor) -> fvfm_recovery_stats

fvfm_recovery_stats

fvfm_recovery_stats %>% 
  filter(Species == "Acervicornis") -> Acer_fvfm

recovery_model_Acer <- lm(change ~ Treatment + Colony, data = Acer_fvfm)
recovery_model_Acer_metrics <- augment(recovery_model_Acer)
plot(recovery_model_Acer)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(recovery_model_Acer_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment, data = recovery_model_Acer_metrics) #not significant
```

### one-way ANOVA
```{r}
aov(change ~ Treatment, data = Acer_fvfm)

summary(aov(change ~ Treatment, data = Acer_fvfm)) #p<0.001
```
### Acer colonies
```{r}

```


## for figure combined plot
```{r}
p1<-fvfm_recovery_change %>% 
  group_by(Species, Treatment) %>% 
  mutate(mean_fvfmlossnorm = mean(change), se_fvfmlossnorm = std.error(change)) %>% 
  ggplot(., aes(x = Treatment, y = mean_fvfmlossnorm)) +
  theme_classic()+
  geom_jitter(aes(y=change, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.1, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = Treatment, ymax = mean_fvfmlossnorm+se_fvfmlossnorm, ymin = mean_fvfmlossnorm-se_fvfmlossnorm, color = Treatment), width = .1, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = Treatment, fill = Treatment), size = 2.5, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Treatment")+
  ylab("% Decline in Fv/Fm")+
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15)) +
  theme(legend.position="none")
```

```{r}
p2<-fvfm_recovery_change %>% 
  group_by(Species, Treatment, Colony) %>% 
  mutate(mean_fvfmlossnorm = mean(change), se_fvfmlossnorm = std.error(change)) %>% 
  ggplot(., aes(x = Colony, y = mean_fvfmlossnorm)) +
  theme_classic()+
  geom_jitter(aes(y=change, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.1, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = Colony, ymax = mean_fvfmlossnorm+se_fvfmlossnorm, ymin = mean_fvfmlossnorm-se_fvfmlossnorm, color = Treatment), width = .1, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = Colony, fill = Treatment), size = 2.5, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Colony")+
  ylab("% Decline in Fv/Fm")+
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15))
```

create combined plot
```{r}
plot_grid(p1, p2, rel_widths = c(1.5,2))
#ggsave("recoveryperiod_percentfvfmloss_dotplot.pdf", width = 12, height = 5)
```


# Tidy color score data
```{r}
Rscoredata %>% 
  select(`Date (Folder Name)`) %>% 
  distinct() #Dates with scores: 3/8-3/18 (Initial), 4/18, 6/21, 7/8 

Rscoredata %>% 
  dplyr::rename(`Photo ID` = `Image #`) %>% 
  dplyr::rename(Date = `Date (Folder Name)`) -> Rscoredata

april18 %>% 
  dplyr::select(`Photo ID`:`Coral Position`) -> april18

june21%>% 
  dplyr::select(`Photo ID`:`Coral Position`) -> june21

full_join(april18, june21) %>% 
  dplyr::mutate(Species = case_when(Species == "Acer" ~ "Acropora cervicornis",
                             Species == "Pcli" ~ "Pseudodiploria clivosa")) %>% 
 dplyr::rename(ID = `Puck ID`) -> allRscores

full_join(allRscores, coral_metadata, by = c("Species", "ID")) %>% 
  drop_na(`Photo ID`)  -> R_metadata #821 rows 

full_join(R_metadata, Rscoredata, by = c("Date", "Photo ID", "Coral Position")) %>% 
 dplyr::select(!Genotype) -> Rintensity_withmetadata

Rintensity_withmetadata$month <- format(Rintensity_withmetadata$Date, "%m")

Rintensity_withmetadata$Date <- as.factor(Rintensity_withmetadata$Date)

Rintensity_withmetadata$month <- as.factor(Rintensity_withmetadata$month)

Rintensity_withmetadata %>% 
  dplyr::group_by(ID, Species, Colony, Treatment, month) %>% 
  dplyr::mutate(mean_Rintensity_percoral = mean(Mean)) %>% 
  drop_na(ID) -> Rintensity_withmetadata

Rintensity_withmetadata %>% 
  ungroup() %>% 
  filter(month == "04" | month == "06") %>% 
  dplyr::select(ID, Species, Colony, Treatment, Treatment_Tank, month, mean_Rintensity_percoral) %>% 
  distinct() %>% 
  pivot_wider(names_from = "month", values_from = "mean_Rintensity_percoral") %>% 
  dplyr::mutate(percent_change = ((`06`-`04`)/`04`)*100) %>% 
  drop_na() -> percentchange
```

```{r}
g1<- percentchange %>% 
  group_by(Species, Treatment) %>% 
  mutate(mean_change = mean(percent_change), se_change = std.error(percent_change)) %>% 
  ggplot(., aes(x = Treatment, y = mean_change)) +
  theme_classic()+
  geom_jitter(aes(y=percent_change, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.1, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = Treatment, ymax = mean_change+se_change, ymin = mean_change-se_change, color = Treatment), width = .1, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = Treatment, fill = Treatment), size = 2.5, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Treatment")+
  ylab("% Change R-Intensity")+
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15)) +
  theme(legend.position="none")
```


```{r}
g2<-percentchange %>% 
  group_by(Species, Colony, Treatment) %>% 
  mutate(mean_change = mean(percent_change), se_change = std.error(percent_change)) %>% 
  ggplot(., aes(x = Colony, y = mean_change)) +
  theme_classic()+
  geom_jitter(aes(y=percent_change, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.1, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = Colony, ymax = mean_change+se_change, ymin = mean_change-se_change, color = Treatment), width = .1, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = Colony, fill = Treatment), size = 2.5, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Colony")+
  ylab("% Change R-Intensity")+
  facet_wrap(~Species, scales = "free_x") +
  theme(text = element_text(size = 15))
```


create combined plot
```{r}
plot_grid(g1, g2, rel_widths = c(1.5,2))
#ggsave("treatment_percentRintensity_dotplot.pdf", width = 12, height = 5)
```


# tidy immune cell data
```{r}
percent_cells_df%>% 
    mutate(Treatment = case_when(Treatment == "Control" ~ "Untreated",
                               Treatment == "Variable" ~ "Treated")) -> percent_cells_df

#there's one outlier to remove right off the bat: T1	Pcli	B	P9	r2	Percent=111.50	T1	Untreated
percent_cells_df %>% 
  filter(!(TimePoint=="T1" & Species == "Pcli" & Genotype == "B" & Treatment == "Untreated" & ID == "P9" & Replicate == "r2")) -> percent_cells_df

#replicates are technical replicates of the same coral fragment
#time points:
#T0 = initial pre-treatment (March 22)
#T1 = one week into treatment (March 30)
#T2 = end of treatment (April 20)
#follow-up = post CBASS and treatment follow-up (June 1)

percent_cells_df %>% 
  filter(TimePoint == "T2" | TimePoint == "FollowUp") %>% 
  mutate(num_days = case_when(TimePoint == "T2" ~ "0",
                              TimePoint == "FollowUp" ~ "43")) %>% 
  mutate(num_days = as.factor(num_days)) %>% 
  mutate(num_days = fct_relevel(num_days, "0", "43")) -> percent_cells_df
```

```{r}
a1<- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::group_by(num_days, Species, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species, scales = "free_x", dir = "v") +
  theme(text = element_text(size = 15)) +
  theme(legend.position="none")
```



```{r}
a2<- percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Species, Genotype, Treatment) %>% 
  dplyr::mutate(avg_percent_per_genet = mean(mean_replicate_percent_perID), se_percent_per_genet = std.error(mean_replicate_percent_perID)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = avg_percent_per_genet))+
  theme_classic()+
  geom_jitter(aes(y=mean_replicate_percent_perID, color = Treatment, fill = Treatment),
              position=position_dodge(width=0.8),
              alpha=0.2, pch = 21,
              color = "black") +
  geom_errorbar(aes(x = num_days, ymax = avg_percent_per_genet+se_percent_per_genet, ymin = avg_percent_per_genet-se_percent_per_genet, color = Treatment), width = .3, position = position_dodge(width=0.8)) +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_point(mapping = aes(x = num_days, fill = Treatment), size = 2, pch = 21, color = "black", position = position_dodge(width=0.8))+
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  facet_wrap(~Species+Genotype, scales = "free_x") +
  theme(text = element_text(size = 15))
```

create combined plot
```{r}
plot_grid(a1, a2, rel_widths = c(1,2))
#ggsave("recovery_phagocytosis_dotplot.pdf", width = 12, height = 5)
```


## immune cell boxplots
no normalizing for control/untreated mean percent
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, Genotype, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  group_by(num_days, Tank, Species, Genotype, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perGenet = mean(Percent)) %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perGenet) %>% 
  distinct() %>% 
  pivot_wider(names_from = "num_days", values_from = "mean_replicate_percent_perGenet") %>% 
  mutate(relative_activity = ((`43`-`0`)/`0`)*100) -> percent_cells_speciestreatments
```

new boxplot
```{r}
ggplot(percent_cells_speciestreatments, aes(x=Species, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Decline Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15)) 
ggsave("percentchange_immunecellactivity_treatment.pdf")
```



### Statistics

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Genotype, Treatment), factor) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  ungroup() -> percent_cells_speciestreatments

treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) #significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #significant

#make interaction term
percent_cells_speciestreatments$Treatment_Species <- interaction(percent_cells_speciestreatments$Treatment, percent_cells_speciestreatments$Species)

# kruskal wallis test
kruskal_test(relative_activity ~ Treatment_Species, data = percent_cells_speciestreatments)# not significant

#posthoc test
as.data.frame(dunn.test(percent_cells_speciestreatments$relative_activity, percent_cells_speciestreatments$Treatment_Species, method = "bonferroni"))
```

# ARCHIVE

immune cell boxplots
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T2" | TimePoint == "FollowUp") %>% 
  mutate(num_days = as.factor(num_days)) %>% 
  dplyr::group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  ggplot(., aes(x = num_days, y = mean_replicate_percent_perID, fill = Treatment))+
  geom_boxplot() +
  facet_wrap(~Species) +
  theme_classic()+
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  xlab("Day")+
  ylab("% Phagocytic Activity")+
  theme(text = element_text(size = 15))
#ggsave("immunecell_postCBASS_boxplot.pdf")
```

## stats
```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  dplyr::filter(TimePoint == "T2" | TimePoint == "FollowUp") %>% 
  mutate(num_days = as.factor(num_days)) %>% 
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Treatment, num_days), factor) -> percent_cells_speciestreatments

treat_model <- lm(mean_replicate_percent_perID ~ Treatment*Species*num_days + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*num_days, data = treat_model_metrics) #significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

percent_cells_speciestreatments %>% 
  filter(mean_replicate_percent_perID < 26) -> percent_cells_speciestreatments

treat_model <- lm(mean_replicate_percent_perID ~ Treatment*Species*num_days + Genotype + Tank, data = percent_cells_speciestreatments)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*num_days, data = treat_model_metrics) #significant


#make interaction term
percent_cells_speciestreatments$Treatment_Species_numdays <- interaction(percent_cells_speciestreatments$Treatment, percent_cells_speciestreatments$Species, percent_cells_speciestreatments$num_days)

# kruskal wallis test
kruskal_test(mean_replicate_percent_perID ~ Treatment_Species_numdays, data = percent_cells_speciestreatments)#significant

#posthoc test

dunn.test(percent_cells_speciestreatments$mean_replicate_percent_perID, percent_cells_speciestreatments$Treatment_Species_numdays, method = "bonferroni")


as.data.frame(dunn.test(percent_cells_speciestreatments$mean_replicate_percent_perID, percent_cells_speciestreatments$Treatment_Species_numdays, method = "bonferroni")) %>% write_csv("species_recovery_immunecells_posthoc.csv")

```


 Normalization to untreated day 0 genotype percentage cells

```{r}
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" & Treatment == "Untreated") %>% 
  group_by(Species, Genotype) %>% 
  dplyr::summarise(mean_untreated_day0_genet = mean(mean_replicate_percent_perID)) -> untreated_day0_immunecells

percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent)) %>% 
  ungroup() %>% 
  select(Species, Genotype, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "43") %>% 
  right_join(., untreated_day0_immunecells, by = c("Species", "Genotype")) %>% 
  mutate(relative_activity = ((mean_replicate_percent_perID-mean_untreated_day0_genet)/mean_untreated_day0_genet)*100) %>% #T1-T0/T0*100
  ggplot(., aes(x=Species, y=relative_activity, fill= Treatment)) +
  geom_boxplot() +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("% Change Immune Cell Activity")+
  theme_classic() +
  theme(text = element_text(size = 15))
#ggsave("normalized_percentchangeimmuneactivity_boxplot_species.pdf")
```


### Statistics

Change to factors
```{r}
#average all technical replicates together before running stats
percent_cells_df %>% 
  drop_na() %>% #one technical replicate is NA for one coral ID
  group_by(num_days, Species, ID, Treatment) %>% 
  dplyr::mutate(mean_replicate_percent_perID = mean(Percent), se_replicate_percent_perID = std.error(Percent)) %>% 
  ungroup() %>% 
  dplyr::select(Species, Genotype, ID, Tank, Treatment, num_days, mean_replicate_percent_perID) %>% 
  distinct() %>% 
  filter(num_days == "0" | num_days == "43") -> percent_cells_speciestreatments

str(percent_cells_speciestreatments)

percent_cells_speciestreatments %>% 
  dplyr::mutate_at(vars(Species, Treatment, num_days), factor) -> percent_cells_speciestreatments

percent_cells_speciestreatments %>% 
  filter(num_days == "0" & Treatment == "Untreated") %>% 
  group_by(Species, Genotype) %>% 
  dplyr::summarise(mean_untreated_day0_genet = mean(mean_replicate_percent_perID)) -> untreated_day0_immunecells

percent_cells_speciestreatments %>% 
  filter(num_days == "43") %>% 
  right_join(., untreated_day0_immunecells, by = c("Species", "Genotype")) %>% 
  mutate(relative_activity = ((mean_replicate_percent_perID-mean_untreated_day0_genet)/mean_untreated_day0_genet)*100) -> relative_activity_df

#save data frame for WGCNA
#write_csv(relative_activity_df, "relative_immune_activity.csv")
```


Create linear model to test normality of residuals and homogeneity of variance. 
```{r}
treat_model <- lm(relative_activity ~ Treatment*Species + Genotype + Tank, data = relative_activity_df)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #not significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

two-way ANOVA
```{r}
summary(aov(relative_activity ~ Treatment*Species, data = relative_activity_df)) #not significant

TukeyHSD(aov(relative_activity ~ Treatment*Species, data = relative_activity_df)) #no significant pairwise
```


