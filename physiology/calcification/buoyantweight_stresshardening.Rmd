---
title: "BW_stresshardening2022"
author: "Allyson DeMerlis"
date: "4/11/2022"
output: html_document
---
# load libraries and data frames
```{r}
library(tidyverse)
library(gsw) #for density calculation
library(rstatix)
library(ggsignif)
library(dunn.test)
library(cowplot)

metadata <- readxl::read_xlsx("../metadata.xlsx")

buoyantweights<- metadata %>% 
    dplyr::select(Species, ID, Colony, Treatment, Treatment_Tank, Bw_initial_raw_mass:bw_final_temp) %>% 
    mutate(Treatment = case_when(Treatment_Tank == "1" ~ "Untreated",
                               Treatment_Tank == "2" ~ "Treated",
                               Treatment_Tank == "3" ~ "Treated",
                               Treatment_Tank == "4" ~ "Untreated",
                               Treatment_Tank == "5" ~ "Treated", 
                               Treatment_Tank == "6" ~ "Untreated",
                               Treatment_Tank == "7" ~ "Untreated",
                               Treatment_Tank == "8" ~ "Treated"))

#sample size
buoyantweights %>% group_by(Species, Treatment) %>% summarise(count = n())
```


# Calculating percent change of mass in air for both species, all genotypes together
```{r}
#determining seawater density using temperature and salinity (from Patrick Kiel's code)
#general equation:gsw_rho_t_exact(SA = salinity, t = temp,p = 10.1325)/1000

#initial and final corrected buoyant weight calculations
buoyantweights %>% 
  group_by(Species, ID, Treatment, bw_initial_date) %>% 
  mutate(SWrho_initial = gsw_rho_t_exact(SA = `bw_initial_salinity (ppt)`,
                         t = bw_initial_temp,
                         p = 10.1325)/1000) %>% 
  mutate(CalcMAir_initial = Bw_initial_raw_mass/(1-SWrho_initial/2.93)) %>%  #2.93 is the density of solid aragonite
  ungroup() %>% 
  group_by(Species, ID, Treatment, bw_final_date) %>% 
  mutate(SWrho_final = gsw_rho_t_exact(SA = bw_final_salinity,
                         t = bw_final_temp,
                         p = 10.1325)/1000) %>% 
  mutate(CalcMAir_final = bw_final_raw_mass/(1-SWrho_final/2.93)) %>% 
  filter(!(Species == "Acropora cervicornis" & ID == "94")) %>% #drop this one sample because it was tissue sampled
  ungroup() %>% 
  mutate(percent_change = ((CalcMAir_final - CalcMAir_initial)/ CalcMAir_initial)*100) %>% 
  drop_na() -> calc_bw_bothspecies_bothtimepoints

#write_csv(calc_bw_bothspecies_bothtimepoints, file = "calc_bw_bothspecies_bothtimepoints.csv")
```


#boxplot of % growth - all genotypes together
```{r}
p1<- calc_bw_bothspecies_bothtimepoints %>% 
  group_by(Treatment) %>% 
  ggplot(., aes(x=Species, y = percent_change, fill = Treatment)) + 
  geom_boxplot() + 
  theme_classic() + 
   scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))  +
  theme(text = element_text(size = 15)) +
  labs(y= "% Growth") +
  theme(legend.position="none")
#ggsave("percentgrowth_speciestreatments.pdf")
```

# stats 

Change to factors
```{r}
str(calc_bw_bothspecies_bothtimepoints)
#make factors: Colony, Puck, Tank, Treatment, Species

calc_bw_bothspecies_bothtimepoints %>% 
  mutate_at(vars(Colony, ID, Treatment_Tank, Treatment, Species), factor) -> calc_bw_bothspecies_bothtimepoints
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(percent_change ~ Treatment*Species + Treatment_Tank + Colony, data = calc_bw_bothspecies_bothtimepoints)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #not significant
```

use non-parametric method
```{r}
#do nonparametric test with interaction term of colony and tank
calc_bw_bothspecies_bothtimepoints$species_treatment <- interaction(calc_bw_bothspecies_bothtimepoints$Species, calc_bw_bothspecies_bothtimepoints$Treatment)

kruskal_test(calc_bw_bothspecies_bothtimepoints, percent_change ~ species_treatment) #significant

dunn_results <- dunn.test(calc_bw_bothspecies_bothtimepoints$percent_change, calc_bw_bothspecies_bothtimepoints$species_treatment, method = "bonferroni")

bw_posthoc_results <- as.data.frame(dunn_results) 

#write_csv(bw_posthoc_results, "bw_posthoc_results.csv")
```



# Calculating percent change of mass in air for both species and all genotypes separated
```{r}
#determining seawater density using temperature and salinity (from Patrick Kiel's code)
#general equation:gsw_rho_t_exact(SA = salinity, t = temp,p = 10.1325)/1000

#initial and final corrected buoyant weight calculations
buoyantweights %>% 
  group_by(Species, ID, Colony, Treatment, bw_initial_date) %>% 
  mutate(SWrho_initial = gsw_rho_t_exact(SA = `bw_initial_salinity (ppt)`,
                         t = bw_initial_temp,
                         p = 10.1325)/1000) %>% 
  mutate(CalcMAir_initial = Bw_initial_raw_mass/(1-SWrho_initial/2.93)) %>%  #2.93 is the density of solid aragonite
  ungroup() %>% 
  group_by(Species, ID, Colony, Treatment, bw_final_date) %>% 
  mutate(SWrho_final = gsw_rho_t_exact(SA = bw_final_salinity,
                         t = bw_final_temp,
                         p = 10.1325)/1000) %>% 
  mutate(CalcMAir_final = bw_final_raw_mass/(1-SWrho_final/2.93)) %>% 
  filter(!(Species == "Acropora cervicornis" & ID == "94")) %>% #drop this one sample because it was tissue sampled
  ungroup() %>% 
  mutate(percent_change = ((CalcMAir_final - CalcMAir_initial)/ CalcMAir_initial)*100) %>% 
  drop_na() -> calc_bw_bothspeciesgenet_bothtimepoints

#write_csv(calc_bw_bothspeciesgenet_bothtimepoints, file = "calc_bw_bothspeciesgenet_bothtimepoints.csv")
```

#boxplot of % growth - genotypes separated
```{r}
p2 <- calc_bw_bothspeciesgenet_bothtimepoints %>% 
  group_by(Colony, Treatment) %>% 
  ggplot(., aes(x=Colony, y = percent_change, fill = Treatment)) + 
  geom_boxplot() + 
  theme_classic() + 
  facet_wrap(~Species, scales= "free_x") +
    scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB"))  +
  theme(text = element_text(size = 15)) +
  labs(y= "% Growth")
```

# stats for percent change in buoyant weight

Change to factors
```{r}
str(calc_bw_bothspeciesgenet_bothtimepoints)
#make factors: Colony, Puck, Tank, Treatment, Species

calc_bw_bothspeciesgenet_bothtimepoints %>% 
  mutate_at(vars(Colony, ID, Treatment_Tank, Treatment, Species), factor) -> calc_bw_bothspeciesgenet_bothtimepoints
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(percent_change ~ Treatment*Species*Colony + Treatment_Tank, data = calc_bw_bothspeciesgenet_bothtimepoints)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species*Colony, data = treat_model_metrics) #not significant
```
use non-parametric method
```{r}
#do nonparametric test with interaction term of colony and tank
calc_bw_bothspeciesgenet_bothtimepoints$species_treatment_colony <- interaction(calc_bw_bothspeciesgenet_bothtimepoints$Species, calc_bw_bothspeciesgenet_bothtimepoints$Treatment, calc_bw_bothspeciesgenet_bothtimepoints$Colony)

kruskal_test(calc_bw_bothspeciesgenet_bothtimepoints, percent_change ~ species_treatment_colony) #significant

dunn_results2 <- dunn.test(calc_bw_bothspeciesgenet_bothtimepoints$percent_change, calc_bw_bothspeciesgenet_bothtimepoints$species_treatment_colony, method = "bonferroni")

bw_posthoc_results_bygenet <- as.data.frame(dunn_results2) 
#no interesting significant differences

#write_csv(bw_posthoc_results_bygenet, "bw_posthoc_results_bygenet.csv")
```


combined plot
```{r}
plot_grid(p1, p2, ncol = 2, rel_widths = c(1.5, 2))
ggsave("growthrates_species_genet.pdf", width = 10, height = 5)
```



