---
title: "CBASS_DRC_modeling"
author: "allyson_demerlis"
date: "2023-12-22"
output: html_document
---

# Packages

```{r}
library(tidyverse)
library(plotrix)
library(lme4)
library(ggpubr)
library(drc) #for the function "drm" dose-response model
library(broom) #for the tidy function needed for dose response model
library(car)
library(rstatix)
library(rcompanion)
library(cowplot)
library(dunn.test)
```

# Import and tidy data

```{r}
ipam_tidy_data <- read.csv("ipam_tidy_data.csv")

ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(!Treatment) -> ipam_tidy_CBASS

ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>% 
  dplyr::select(Tank, Puck, Colony, Treatment, Species) %>% 
  distinct() %>% #283 rows = one coral ID per treatment, no repeats
  mutate(Treatment = case_when(Tank == "1" ~ "Untreated",
                               Tank == "2" ~ "Treated",
                               Tank == "3" ~ "Treated",
                               Tank == "4" ~ "Untreated",
                               Tank == "5" ~ "Treated", 
                               Tank == "6" ~ "Untreated",
                               Tank == "7" ~ "Untreated",
                               Tank == "8" ~ "Treated")) %>% 
  full_join(ipam_tidy_CBASS, by = c("Puck", "Colony", "Species")) %>% 
  drop_na() %>% 
  rename(Treatment_Tank = Tank.x, CBASS_Tank = Tank.y) %>% 
  dplyr::select(-c("X", "AOI", "Ft", "Fm", "file")) -> ipam_tidy_CBASS_treatments

ipam_tidy_CBASS_treatments %>% 
  mutate_at(vars(Colony, Puck, Treatment, Species), factor) -> ipam_tidy_CBASS_treatments
```


# Species x Treatment

## boxplot
```{r}
ipam_tidy_CBASS_treatments %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) %>% 
  ggplot(., aes(x=CBASS_temp, y= fvfm, fill = Treatment)) + 
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  theme_classic()
```

### ANOVA Treatment*CBASS_temp within species

#### Acer
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Acer_CBASS

str(Acer_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#before running this section, re-import ipam_tidy_data and remake Acer_CBASS because the of the outlier removal step
AcerCBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Colony + Treatment_Tank, data = Acer_CBASS)
AcerCBASS_model_metrics <- augment(AcerCBASS_model)
plot(AcerCBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(AcerCBASS_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = AcerCBASS_model_metrics) #not significant

# identifying outliers
AcerCBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

#manually remove outlier
Acer_CBASS %>% 
  filter(!(fvfm==0.262 & Treatment == "Untreated" & CBASS_temp == "37" & Colony == "SI-C")) -> Acer_CBASS

#rerun and see if data becomes more normal
AcerCBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Colony + Treatment_Tank, data = Acer_CBASS)
AcerCBASS_model_metrics <- augment(AcerCBASS_model)
plot(AcerCBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(AcerCBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = AcerCBASS_model_metrics) #not significant
```
Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Acer_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_CBASS)), file = "fvfm_CBASStemps_Acer_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_CBASS)), file = "fvfm_CBASStemps_Acer_anova_tukey.csv")
```


#### Pcli
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Pcli_CBASS

str(Pcli_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#before running this section, re-import ipam_tidy_data and remake Acer_CBASS because the of the outlier removal step
PcliCBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Colony + Treatment_Tank, data = Pcli_CBASS)
PcliCBASS_model_metrics <- augment(PcliCBASS_model)
plot(PcliCBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(PcliCBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = PcliCBASS_model_metrics) #not significant

# identifying outliers
PcliCBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 1 outlier

#manually remove outlier
Pcli_CBASS %>% 
  filter(!(fvfm==0.277 & Treatment == "Treated" & CBASS_temp == "35" & Colony == "A")) -> Pcli_CBASS
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_CBASS)), file = "fvfm_CBASStemps_Pcli_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_CBASS)), file = "fvfm_CBASStemps_Pcli_anova_tukey.csv")
```


## DRC Curve fitting

Convert to factors
```{r}
str(ipam_tidy_CBASS_treatments)
#make factors: Colony, Puck, Treatment, Species

ipam_tidy_CBASS_treatments %>% 
  mutate_at(vars(Colony, Puck, Treatment, Species), factor) -> ipam_tidy_CBASS_treatments

#check
str(ipam_tidy_CBASS_treatments)
```


```{r}
# Checking sample sizes
aggregate(fvfm ~ Species + Treatment, data=ipam_tidy_CBASS_treatments, length)
#sample sizes are large enough to use z-test statistics from compParm()

aggregate(fvfm ~ Species + Treatment + Colony, data=ipam_tidy_CBASS_treatments, length)
```

### compParm()
```{r}
ipam_tidy_CBASS_treatments$Species_Treatment <- interaction(ipam_tidy_CBASS_treatments$Species, ipam_tidy_CBASS_treatments$Treatment)

ipam_tidy_CBASS_treatments$CBASS_temp <- as.numeric(ipam_tidy_CBASS_treatments$CBASS_temp) #needs to be numeric or drm function won't run


DRC_species_treatment = drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments, curveid = Species_Treatment,
             fct = LL.3(names = c('hill', 'max', 'ed50')))
summary(DRC_species_treatment)
plot(DRC_species_treatment)

#See example 3 from the supplementary info of drc package creators Ritz et al. 2015 (https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0146021)

#compParm compares the selected coefficient by means of a z-test
compParm(DRC_species_treatment, 'ed50')
as.data.frame(compParm(DRC_species_treatment, 'ed50', "-")) %>% 
  write.csv("DRC_species_treatment_ed50_stats.csv")

compParm(DRC_species_treatment, 'hill')
as.data.frame(compParm(DRC_species_treatment, 'hill', "-")) %>% 
  write.csv("DRC_species_treatment_hill_stats.csv")
```


### ED50s
```{r}
coeff <- as.data.frame(DRC_species_treatment$coefficients) #hill, max, and ed50 values

coeff %>% 
  rownames_to_column(var = "coeff_species_treatment") %>% 
  filter(grepl("ed50", coeff_species_treatment)) -> ED50s

ED50s
```

### Make predicted datasets for each species x treatment interaction

#### Acer
```{r}
untreated_Acer <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Untreated",], fct = LL.3())
summary(untreated_Acer)
plot(untreated_Acer)

treated_Acer <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Treated",], fct = LL.3())
summary(treated_Acer)
plot(treated_Acer)

untreated_Acer_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Acer_pred = as.data.frame(predict(untreated_Acer, newdata = untreated_Acer_preddata, interval = 'confidence'))
untreated_Acer_preddata = data.frame(untreated_Acer_preddata, fvfm = untreated_Acer_pred$Prediction, Lower = untreated_Acer_pred$Lower, Upper = untreated_Acer_pred$Upper)

treated_Acer_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Acer_pred = as.data.frame(predict(treated_Acer, newdata = treated_Acer_preddata, interval = 'confidence'))
treated_Acer_preddata = data.frame(treated_Acer_preddata, fvfm = treated_Acer_pred$Prediction, Lower = treated_Acer_pred$Lower, Upper = treated_Acer_pred$Upper)
```

### plot
```{r}
g1 <- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.05, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Acer_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Acer_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = ED50s, aes(xintercept = 36.15546), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = ED50s, aes(label = "ED50 = 36.16"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Acer_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Acer_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = ED50s, aes(xintercept = 36.24109), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = ED50s, aes(label = "ED50 = 36.20"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "A.cervicornis") +
  theme(legend.position="none") +
  theme(text = element_text(size = 15)) 
```


#### Pcli
```{r}
untreated_Pcli <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Untreated",], fct = LL.3())
summary(untreated_Pcli)
plot(untreated_Pcli)

treated_Pcli <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Treated",], fct = LL.3())
summary(treated_Pcli)
plot(treated_Pcli)

untreated_Pcli_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Pcli_pred = as.data.frame(predict(untreated_Pcli, newdata = untreated_Pcli_preddata, interval = 'confidence'))
untreated_Pcli_preddata = data.frame(untreated_Pcli_preddata, fvfm = untreated_Pcli_pred$Prediction, Lower = untreated_Pcli_pred$Lower, Upper = untreated_Pcli_pred$Upper)

treated_Pcli_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Pcli_pred = as.data.frame(predict(treated_Pcli, newdata = treated_Pcli_preddata, interval = 'confidence'))
treated_Pcli_preddata = data.frame(treated_Pcli_preddata, fvfm = treated_Pcli_pred$Prediction, Lower = treated_Pcli_pred$Lower, Upper = treated_Pcli_pred$Upper)
```


plot
```{r}
g2<- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa",], aes(x = CBASS_temp, y = fvfm, color = Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.05, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Pcli_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Pcli_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = ED50s, aes(xintercept = 36.45646), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = ED50s, aes(label = "ED50 = 36.46"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Pcli_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Pcli_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = ED50s, aes(xintercept = 36.52786), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = ED50s, aes(label = "ED50 = 36.53"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c( "#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "P.clivosa") +
  theme(text = element_text(size = 15)) 
```


### Final DRC plots
```{r}
plot_grid(g1, g2, rel_widths = c(1,1.25))
#ggsave("ED50_DRC_bothspecies.pdf", width = 15, height = 7)
```

# Colony x Treatment

## boxplot

```{r}
ipam_tidy_CBASS_treatments %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) %>% 
  ggplot(., aes(x=CBASS_temp, y= fvfm, fill = Treatment)) + 
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  geom_boxplot() +
  facet_wrap(~Species+Colony) +
  theme_classic()
```
### ANOVA Treatment*CBASS_temp*Colony

#### Acer
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Acer_CBASS

str(Acer_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

AcerCBASS_model <- lm(fvfm ~ Treatment*CBASS_temp*Colony + Treatment_Tank, data = Acer_CBASS)
AcerCBASS_model_metrics <- augment(AcerCBASS_model)
plot(AcerCBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(AcerCBASS_model_metrics$.resid) # significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Colony*CBASS_temp, data = AcerCBASS_model_metrics) #not significant

# identifying outliers
AcerCBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 2 outliers

#manually remove outliers
Acer_CBASS %>% 
  filter(!(fvfm==0.262 & Treatment == "Untreated" & CBASS_temp == "37" & Colony == "SI-C")) -> Acer_CBASS

Acer_CBASS %>% 
  filter(!(fvfm==0.000 & Treatment == "Untreated" & CBASS_temp == "37" & Colony == "SI-C")) -> Acer_CBASS

#rerun and see if data becomes more normal
AcerCBASS_model <- lm(fvfm ~ Treatment*CBASS_temp*Colony + Treatment_Tank, data = Acer_CBASS)
AcerCBASS_model_metrics <- augment(AcerCBASS_model)
plot(AcerCBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(AcerCBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp*Colony, data = AcerCBASS_model_metrics) #not significant
```

Run three-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Acer_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Acer_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Acer_CBASS)), file = "fvfm_CBASStemps_Acer_colony_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Acer_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Acer_CBASS)), file = "fvfm_CBASStemps_Acer_colony_anova_tukey.csv")
```

#### Pcli
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Pcli_CBASS

str(Pcli_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Pcli_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp*Colony + Treatment_Tank, data = Pcli_CBASS)
Pcli_CBASS_model_metrics <- augment(Pcli_CBASS_model)
plot(Pcli_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Colony*CBASS_temp, data = Pcli_CBASS_model_metrics) #not significant

# identifying outliers
Pcli_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 2 outliers

#manually remove outliers
Pcli_CBASS %>% 
  filter(!(fvfm==0.517 & Treatment == "Treated" & CBASS_temp == "34" & Colony == "A")) -> Pcli_CBASS

Pcli_CBASS %>% 
  filter(!(fvfm==0.277 & Treatment == "Treated" & CBASS_temp == "35" & Colony == "A")) -> Pcli_CBASS
```

Run three-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Pcli_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Pcli_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Pcli_CBASS)), file = "fvfm_CBASStemps_Pcli_colony_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Pcli_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp*Colony, data = Pcli_CBASS)), file = "fvfm_CBASStemps_Pcli_colony_anova_tukey.csv")
```


## DRC Curve fitting

### Acer 
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") -> Acer_CBASS

Acer_CBASS$Colony_Treatment <- interaction(Acer_CBASS$Colony, Acer_CBASS$Treatment)

str(Acer_CBASS)

DRC_Acer_colony_treatment = drm(fvfm ~ CBASS_temp, data = Acer_CBASS, curveid = Colony_Treatment,
             fct = LL.3(names = c('hill', 'max', 'ed50')))
summary(DRC_Acer_colony_treatment)
plot(DRC_Acer_colony_treatment)
compParm(DRC_Acer_colony_treatment, 'ed50')
compParm(DRC_Acer_colony_treatment, 'ed50', "-")

compParm(DRC_Acer_colony_treatment, 'hill')
compParm(DRC_Acer_colony_treatment, 'hill', "-")

Acer_coeff <- as.data.frame(DRC_Acer_colony_treatment$coefficients)

Acer_coeff %>% 
  rownames_to_column(var = "coeff_colony_treatment") %>% 
  filter(grepl("ed50", coeff_colony_treatment)) %>% 
  rename(ED50 = `DRC_Acer_colony_treatment$coefficients`) %>% 
  separate(coeff_colony_treatment, into=c("ed50", "Colony", "Treatment"), sep = "[:.]") -> Acer_ED50s

#statistics
Acer_model <- lm(ED50 ~ Treatment, data = Acer_ED50s)
Acer_model_metrics <- augment(Acer_model)
plot(Acer_model) #not normal
summary(aov(ED50 ~ Treatment, data = Acer_ED50s)) #not significant
kruskal.test(ED50 ~ Treatment, data = Acer_ED50s) #not significant
```

### Pcli
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") -> Pcli_CBASS

Pcli_CBASS$Colony_Treatment <- interaction(Pcli_CBASS$Colony, Pcli_CBASS$Treatment)

str(Pcli_CBASS)

DRC_Pcli_colony_treatment = drm(fvfm ~ CBASS_temp, data = Pcli_CBASS, curveid = Colony_Treatment,
             fct = LL.3(names = c('hill', 'max', 'ed50')))
summary(DRC_Pcli_colony_treatment)
plot(DRC_Pcli_colony_treatment)
compParm(DRC_Pcli_colony_treatment, 'ed50')
compParm(DRC_Pcli_colony_treatment, 'ed50', "-")

compParm(DRC_Pcli_colony_treatment, 'hill')
compParm(DRC_Pcli_colony_treatment, 'hill', "-")

Pcli_coeff <- as.data.frame(DRC_Pcli_colony_treatment$coefficients)

Pcli_coeff %>% 
  rownames_to_column(var = "coeff_colony_treatment") %>% 
  filter(grepl("ed50", coeff_colony_treatment)) %>% 
  rename(ED50 = `DRC_Pcli_colony_treatment$coefficients`) %>% 
  separate(coeff_colony_treatment, into=c("ed50", "Colony", "Treatment"), sep = "[:.]") -> Pcli_ED50s

#statistics
Pcli_model <- lm(ED50 ~ Treatment, data = Pcli_ED50s)
Pcli_model_metrics <- augment(Pcli_model)
plot(Pcli_model) # not normal

kruskal.test(ED50 ~ Treatment, data = Pcli_ED50s) #not significant
```

## Kruskal Wallis for hill slope of curve
```{r}
Acer_coeff %>% 
  rownames_to_column(var = "coeff_colony_treatment") %>% 
  filter(grepl("hill", coeff_colony_treatment)) %>% 
  rename(hill = `DRC_Acer_colony_treatment$coefficients`) %>% 
  separate(coeff_colony_treatment, into=c("var", "Colony", "Treatment"), sep = "[:.]") -> Acer_hills

#statistics
Acer_hill_model <- lm(hill ~ Treatment, data = Acer_hills)
Acer_hill_model_metrics <- augment(Acer_hill_model)
plot(Acer_hill_model) # need to do non parametric test

kruskal.test(hill ~ Treatment, data = Acer_hills) #not significant
```

```{r}
Pcli_coeff %>% 
  rownames_to_column(var = "coeff_colony_treatment") %>% 
  filter(grepl("hill", coeff_colony_treatment)) %>% 
  rename(hill = `DRC_Pcli_colony_treatment$coefficients`) %>% 
  separate(coeff_colony_treatment, into=c("var", "Colony", "Treatment"), sep = "[:.]") -> Pcli_hills

#statistics
Pcli_hill_model <- lm(hill ~ Treatment, data = Pcli_hills)
Pcli_hill_model_metrics <- augment(Pcli_hill_model)
plot(Pcli_hill_model) # do non parametric test

kruskal.test(hill ~ Treatment, data = Pcli_hills) #not significant
```


## make predicted datasets

### Acer colonies

#### BC8b
```{r}
untreated_Acer_BC8b <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "BC-8b",], fct = LL.3())
summary(untreated_Acer_BC8b)
plot(untreated_Acer_BC8b)

untreated_Acer_BC8b$coefficients

treated_Acer_BC8b <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "BC-8b",], fct = LL.3())
summary(treated_Acer_BC8b)
plot(treated_Acer_BC8b)

untreated_Acer_BC8b_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Acer_BC8b_pred = as.data.frame(predict(untreated_Acer_BC8b, newdata = untreated_Acer_BC8b_preddata, interval = 'confidence'))
untreated_Acer_BC8b_preddata = data.frame(untreated_Acer_BC8b_preddata, fvfm = untreated_Acer_BC8b_pred$Prediction, Lower = untreated_Acer_BC8b_pred$Lower, Upper = untreated_Acer_BC8b_pred$Upper)

treated_Acer_BC8b_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Acer_BC8b_pred = as.data.frame(predict(treated_Acer_BC8b, newdata = treated_Acer_BC8b_preddata, interval = 'confidence'))
treated_Acer_BC8b_preddata = data.frame(treated_Acer_BC8b_preddata, fvfm = treated_Acer_BC8b_pred$Prediction, Lower = treated_Acer_BC8b_pred$Lower, Upper = treated_Acer_BC8b_pred$Upper)

### ED50s are e intercept

coeff_untreated_Acer_BC8b <- as.data.frame(untreated_Acer_BC8b$coefficients) #hill, max, and ed50 values
coeff_treated_Acer_BC8b <- as.data.frame(treated_Acer_BC8b$coefficients) #hill, max, and ed50 values
```



```{r}
a1<- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Colony == "BC-8b",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Acer_BC8b_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Acer_BC8b_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Acer_BC8b, aes(xintercept = 35.9828511	), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Acer_BC8b, aes(label = "ED50 = 35.98"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Acer_BC8b_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Acer_BC8b_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Acer_BC8b, aes(xintercept = 35.9884443), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Acer_BC8b, aes(label = "ED50 = 35.99"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "A.cervicornis colony BC-8b") +
  theme(legend.position="none") +
  theme(text = element_text(size = 15)) 
```

#### MBB
```{r}
untreated_Acer_MBB <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "MB-B",], fct = LL.3())
summary(untreated_Acer_MBB)
plot(untreated_Acer_MBB)

untreated_Acer_MBB$coefficients

treated_Acer_MBB <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "MB-B",], fct = LL.3())
summary(treated_Acer_MBB)
plot(treated_Acer_MBB)

untreated_Acer_MBB_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Acer_MBB_pred = as.data.frame(predict(untreated_Acer_MBB, newdata = untreated_Acer_MBB_preddata, interval = 'confidence'))
untreated_Acer_MBB_preddata = data.frame(untreated_Acer_MBB_preddata, fvfm = untreated_Acer_MBB_pred$Prediction, Lower = untreated_Acer_MBB_pred$Lower, Upper = untreated_Acer_MBB_pred$Upper)

treated_Acer_MBB_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Acer_MBB_pred = as.data.frame(predict(treated_Acer_MBB, newdata = treated_Acer_MBB_preddata, interval = 'confidence'))
treated_Acer_MBB_preddata = data.frame(treated_Acer_MBB_preddata, fvfm = treated_Acer_MBB_pred$Prediction, Lower = treated_Acer_MBB_pred$Lower, Upper = treated_Acer_MBB_pred$Upper)

### ED50s are e intercept

coeff_untreated_Acer_MBB <- as.data.frame(untreated_Acer_MBB$coefficients) #hill, max, and ed50 values
coeff_treated_Acer_MBB <- as.data.frame(treated_Acer_MBB$coefficients) #hill, max, and ed50 values
```
```{r}
a2<- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Colony == "MB-B",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Acer_MBB_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Acer_MBB_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Acer_MBB, aes(xintercept = 36.2761978	), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Acer_MBB, aes(label = "ED50 = 36.28"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Acer_MBB_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Acer_MBB_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Acer_MBB, aes(xintercept = 36.3858018	), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Acer_MBB, aes(label = "ED50 = 36.39"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "A.cervicornis colony MB-B") +
  theme(legend.position="none") +
  theme(text = element_text(size = 15)) 
```

#### SI-C
```{r}
untreated_Acer_SIC <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "SI-C",], fct = LL.3())
summary(untreated_Acer_SIC)
plot(untreated_Acer_SIC)

untreated_Acer_SIC$coefficients

treated_Acer_SIC <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "SI-C",], fct = LL.3())
summary(treated_Acer_SIC)
plot(treated_Acer_SIC)

untreated_Acer_SIC_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Acer_SIC_pred = as.data.frame(predict(untreated_Acer_SIC, newdata = untreated_Acer_SIC_preddata, interval = 'confidence'))
untreated_Acer_SIC_preddata = data.frame(untreated_Acer_SIC_preddata, fvfm = untreated_Acer_SIC_pred$Prediction, Lower = untreated_Acer_SIC_pred$Lower, Upper = untreated_Acer_SIC_pred$Upper)

treated_Acer_SIC_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Acer_SIC_pred = as.data.frame(predict(treated_Acer_SIC, newdata = treated_Acer_SIC_preddata, interval = 'confidence'))
treated_Acer_SIC_preddata = data.frame(treated_Acer_SIC_preddata, fvfm = treated_Acer_SIC_pred$Prediction, Lower = treated_Acer_SIC_pred$Lower, Upper = treated_Acer_SIC_pred$Upper)

### ED50s are e intercept

coeff_untreated_Acer_SIC <- as.data.frame(untreated_Acer_SIC$coefficients) #hill, max, and ed50 values
coeff_treated_Acer_SIC <- as.data.frame(treated_Acer_SIC$coefficients) #hill, max, and ed50 values
```

```{r}
a3<- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Acervicornis" & ipam_tidy_CBASS_treatments$Colony == "SI-C",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Acer_SIC_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Acer_SIC_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Acer_SIC, aes(xintercept = 36.1814552	), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Acer_SIC, aes(label = "ED50 = 36.18"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Acer_SIC_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Acer_SIC_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Acer_SIC, aes(xintercept = 36.2570666		), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Acer_SIC, aes(label = "ED50 = 36.26"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "A.cervicornis colony SI-C") +
  theme(text = element_text(size = 15)) 
```

#### combine plots
```{r}
plot_grid(a1,a2,a3, rel_widths = c(1,1,1.25), ncol = 3)
#ggsave("ED50_DRC_Acercolonies.pdf", width = 15, height = 7)
```


#### ANOVA for within colony comparisons

##### Acer BC8b
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") %>% 
  filter(Colony == "BC-8b") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Acer_BC8b_CBASS

str(Acer_BC8b_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Acer_BC8b_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Acer_BC8b_CBASS)
Acer_BC8b_CBASS_model_metrics <- augment(Acer_BC8b_CBASS_model)
plot(Acer_BC8b_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_BC8b_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS_model_metrics) #not significant

# identifying outliers
Acer_BC8b_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS)), file = "fvfm_CBASStemps_Acer_BC8b_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_BC8b_CBASS)), file = "fvfm_CBASStemps_Acer_BC8b_anova_tukey.csv")
```

##### Acer MBB
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") %>% 
  filter(Colony == "MB-B") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Acer_MBB_CBASS

str(Acer_MBB_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Acer_MBB_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Acer_MBB_CBASS)
Acer_MBB_CBASS_model_metrics <- augment(Acer_MBB_CBASS_model)
plot(Acer_MBB_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_MBB_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS_model_metrics) #not significant

# identifying outliers
Acer_MBB_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS)), file = "fvfm_CBASStemps_Acer_MBB_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS)), file = "fvfm_CBASStemps_Acer_MBB_anova_tukey.csv")
```

##### Acer SIC
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Acervicornis") %>% 
  filter(Colony == "SI-C") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Acer_SIC_CBASS

str(Acer_SIC_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Acer_SIC_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Acer_SIC_CBASS)
Acer_SIC_CBASS_model_metrics <- augment(Acer_SIC_CBASS_model)
plot(Acer_SIC_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Acer_SIC_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Acer_SIC_CBASS_model_metrics) #not significant

# identifying outliers
Acer_SIC_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Acer_SIC_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_SIC_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS)), file = "fvfm_CBASStemps_Acer_MBB_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Acer_MBB_CBASS)), file = "fvfm_CBASStemps_Acer_MBB_anova_tukey.csv")
```

### Pcli colonies

#### A
```{r}
untreated_Pcli_A <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "A",], fct = LL.3())
summary(untreated_Pcli_A)
plot(untreated_Pcli_A)

treated_Pcli_A <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "A",], fct = LL.3())
summary(treated_Pcli_A)
plot(treated_Pcli_A)

untreated_Pcli_A_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Pcli_A_pred = as.data.frame(predict(untreated_Pcli_A, newdata = untreated_Pcli_A_preddata, interval = 'confidence'))
untreated_Pcli_A_preddata = data.frame(untreated_Pcli_A_preddata, fvfm = untreated_Pcli_A_pred$Prediction, Lower = untreated_Pcli_A_pred$Lower, Upper = untreated_Pcli_A_pred$Upper)

treated_Pcli_A_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Pcli_A_pred = as.data.frame(predict(treated_Pcli_A, newdata = treated_Pcli_A_preddata, interval = 'confidence'))
treated_Pcli_A_preddata = data.frame(treated_Pcli_A_preddata, fvfm = treated_Pcli_A_pred$Prediction, Lower = treated_Pcli_A_pred$Lower, Upper = treated_Pcli_A_pred$Upper)


### ED50s are e intercept

coeff_untreated_Pcli_A <- as.data.frame(untreated_Pcli_A$coefficients) #hill, max, and ed50 values
coeff_treated_Pcli_A <- as.data.frame(treated_Pcli_A$coefficients) #hill, max, and ed50 values
```

```{r}
p1<-ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Colony == "A",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Pcli_A_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Pcli_A_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Pcli_A, aes(xintercept = 36.5521498		), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Pcli_A, aes(label = "ED50 = 36.55"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Pcli_A_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Pcli_A_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Pcli_A, aes(xintercept = 36.436015), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Pcli_A, aes(label = "ED50 = 36.44"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "P.clivosa colony A") +
  theme(legend.position="none") +
  theme(text = element_text(size = 15)) 
```



#### B
```{r}
untreated_Pcli_B <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "B",], fct = LL.3())
summary(untreated_Pcli_B)
plot(untreated_Pcli_B)

treated_Pcli_B <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "B",], fct = LL.3())
summary(treated_Pcli_B)
plot(treated_Pcli_B)

untreated_Pcli_B_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Pcli_B_pred = as.data.frame(predict(untreated_Pcli_B, newdata = untreated_Pcli_B_preddata, interval = 'confidence'))
untreated_Pcli_B_preddata = data.frame(untreated_Pcli_B_preddata, fvfm = untreated_Pcli_B_pred$Prediction, Lower = untreated_Pcli_B_pred$Lower, Upper = untreated_Pcli_B_pred$Upper)

treated_Pcli_B_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Pcli_B_pred = as.data.frame(predict(treated_Pcli_B, newdata = treated_Pcli_B_preddata, interval = 'confidence'))
treated_Pcli_B_preddata = data.frame(treated_Pcli_B_preddata, fvfm = treated_Pcli_B_pred$Prediction, Lower = treated_Pcli_B_pred$Lower, Upper = treated_Pcli_B_pred$Upper)


### ED50s are e intercept

coeff_untreated_Pcli_B <- as.data.frame(untreated_Pcli_B$coefficients) #hill, max, and ed50 values
coeff_treated_Pcli_B <- as.data.frame(treated_Pcli_B$coefficients) #hill, max, and ed50 values
```

```{r}
p2<-ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Colony == "B",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Pcli_B_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Pcli_B_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Pcli_B, aes(xintercept = 36.580741), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Pcli_B, aes(label = "ED50 = 36.58"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Pcli_B_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Pcli_B_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Pcli_B, aes(xintercept = 36.7283829), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Pcli_B, aes(label = "ED50 = 36.73"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "P.clivosa colony B") +
  theme(legend.position="none") +
  theme(text = element_text(size = 15)) 
```


#### C
```{r}
untreated_Pcli_C <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Untreated" & ipam_tidy_CBASS_treatments$Colony == "C",], fct = LL.3())
summary(untreated_Pcli_C)
plot(untreated_Pcli_C)

treated_Pcli_C <- drm(fvfm ~ CBASS_temp, data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Treatment=="Treated" & ipam_tidy_CBASS_treatments$Colony == "C",], fct = LL.3())
summary(treated_Pcli_C)
plot(treated_Pcli_C)

untreated_Pcli_C_preddata = data.frame(temp = seq(27,39, length.out = 100))
untreated_Pcli_C_pred = as.data.frame(predict(untreated_Pcli_C, newdata = untreated_Pcli_C_preddata, interval = 'confidence'))
untreated_Pcli_C_preddata = data.frame(untreated_Pcli_C_preddata, fvfm = untreated_Pcli_C_pred$Prediction, Lower = untreated_Pcli_C_pred$Lower, Upper = untreated_Pcli_C_pred$Upper)

treated_Pcli_C_preddata = data.frame(temp = seq(27,39, length.out = 100))
treated_Pcli_C_pred = as.data.frame(predict(treated_Pcli_C, newdata = treated_Pcli_C_preddata, interval = 'confidence'))
treated_Pcli_C_preddata = data.frame(treated_Pcli_C_preddata, fvfm = treated_Pcli_C_pred$Prediction, Lower = treated_Pcli_C_pred$Lower, Upper = treated_Pcli_C_pred$Upper)


### ED50s are e intercept

coeff_untreated_Pcli_C <- as.data.frame(untreated_Pcli_C$coefficients) #hill, max, and ed50 values
coeff_treated_Pcli_C <- as.data.frame(treated_Pcli_C$coefficients) #hill, max, and ed50 values
```

```{r}
p3<- ggplot() +
  geom_jitter(data = ipam_tidy_CBASS_treatments[ipam_tidy_CBASS_treatments$Species == "Pclivosa" & ipam_tidy_CBASS_treatments$Colony == "C",], aes(x = CBASS_temp, y = fvfm, color =   Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(28,40), breaks=c(28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = untreated_Pcli_C_preddata, aes(x = temp, y = fvfm), color = "#60DBDB", show.legend = FALSE) +
  geom_ribbon(data = untreated_Pcli_C_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = "#60DBDB", linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_untreated_Pcli_C, aes(xintercept = 36.2330273), color = "#60DBDB", show.legend = FALSE) +
  geom_text(data = coeff_untreated_Pcli_C, aes(label = "ED50 = 36.23"), x = 38, y = 0.65, show.legend = FALSE, color = "#60DBDB") +
  geom_line(data = treated_Pcli_C_preddata, aes(x = temp, y = fvfm), color = '#F54A34', show.legend = FALSE) +
  geom_ribbon(data = treated_Pcli_C_preddata, aes(x = temp, ymin=Lower, ymax=Upper), fill = '#F54A34', linetype=2, alpha = 0.2) +
  geom_vline(data = coeff_treated_Pcli_C, aes(xintercept = 36.3295838), color = '#F54A34', show.legend = FALSE) +
  geom_text(data = coeff_treated_Pcli_C, aes(label = "ED50 = 36.33"), x = 38, y = 0.6, show.legend = FALSE, color = '#F54A34') +
  scale_color_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw() +
  labs(title = "P.clivosa colony C") +
  theme(text = element_text(size = 15)) 
```

#### combine plots
```{r}
plot_grid(p1,p2,p3, rel_widths = c(1,1,1.25), ncol = 3)
#ggsave("ED50_DRC_Pclicolonies.pdf", width = 15, height = 7)
```


#### ANOVA for within colony comparisons

##### Pcli A
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") %>% 
  filter(Colony == "A") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Pcli_A_CBASS

str(Pcli_A_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Pcli_A_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Pcli_A_CBASS)
Pcli_A_CBASS_model_metrics <- augment(Pcli_A_CBASS_model)
plot(Pcli_A_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_A_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Pcli_A_CBASS_model_metrics) #not significant

# identifying outliers
Pcli_A_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_A_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_A_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_A_CBASS)), file = "fvfm_CBASStemps_Pcli_A_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_A_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_A_CBASS)), file = "fvfm_CBASStemps_Pcli_A_anova_tukey.csv")
```

##### Pcli B
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") %>% 
  filter(Colony == "B") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Pcli_B_CBASS

str(Pcli_B_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Pcli_B_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Pcli_B_CBASS)
Pcli_B_CBASS_model_metrics <- augment(Pcli_B_CBASS_model)
plot(Pcli_B_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_B_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Pcli_B_CBASS_model_metrics) #not significant

# identifying outliers
Pcli_B_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_B_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_B_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_B_CBASS)), file = "fvfm_CBASStemps_Pcli_B_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_B_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_B_CBASS)), file = "fvfm_CBASStemps_Pcli_B_anova_tukey.csv")
```

##### Pcli C
```{r}
ipam_tidy_CBASS_treatments %>% 
  filter(Species == "Pclivosa") %>% 
  filter(Colony == "C") %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) -> Pcli_C_CBASS

str(Pcli_C_CBASS)
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
#rerun above code chunk to recreate Acer_CBASS dataset before running statistical tests because outliers have been filtered out in other sections 

Pcli_C_CBASS_model <- lm(fvfm ~ Treatment*CBASS_temp + Treatment_Tank, data = Pcli_C_CBASS)
Pcli_C_CBASS_model_metrics <- augment(Pcli_C_CBASS_model)
plot(Pcli_C_CBASS_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(Pcli_C_CBASS_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*CBASS_temp, data = Pcli_C_CBASS_model_metrics) #not significant

# identifying outliers
Pcli_C_CBASS_model_metrics %>% 
  filter(abs(.std.resid) > 3)
# 0 outliers
```

Run two-way anova
```{r}
aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_C_CBASS)

summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_C_CBASS))

#capture.output(summary(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_C_CBASS)), file = "fvfm_CBASStemps_Pcli_C_anova_table.csv")

TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_C_CBASS))
         
#capture.output(TukeyHSD(aov(fvfm ~ Treatment*CBASS_temp, data = Pcli_C_CBASS)), file = "fvfm_CBASStemps_Pcli_C_anova_tukey.csv")
```



## ED50s and hills of all colonies - species x treatment

combine both ED50 datasets into one
```{r}
Pcli_ED50s %>% 
  mutate(Species ="Pclivosa") -> Pcli_ED50s

Acer_ED50s %>% 
  mutate(Species = "Acervicornis") -> Acer_ED50s

full_join(Pcli_ED50s, Acer_ED50s) -> bothspecies_colony_ED50s

ed50_model <- lm(ED50 ~ Species*Treatment + Colony, data = bothspecies_colony_ED50s)
ed50_model_metrics <- augment(ed50_model)
plot(ed50_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(ed50_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Species*Treatment, data = ed50_model_metrics) #not significant

# identifying outliers
ed50_model_metrics %>% 
  filter(abs(.std.resid) > 3) #no outliers
```

two way ANOVA

```{r}
aov(ED50 ~ Species*Treatment, data = bothspecies_colony_ED50s)

summary(aov(ED50 ~ Species*Treatment, data = bothspecies_colony_ED50s))

#capture.output(summary(aov(ED50 ~ Species*Treatment, data = bothspecies_colony_ED50s)), file = "bothspecies_colony_ED50s_anova_table.csv")

TukeyHSD(aov(ED50 ~ Species*Treatment, data = bothspecies_colony_ED50s))
         
#capture.output(aov(ED50 ~ Species*Treatment, data = bothspecies_colony_ED50s), file = "bothspecies_colony_ED50s_anova_tukey.csv")
```



boxplot of ed50s
```{r}
p1<- ggplot(bothspecies_colony_ED50s, aes(x=Treatment, y=ED50, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  theme(legend.position="none") +
  ylim(35,37)
  
#ggsave("ed50s_boxplot_bothspecies.pdf", width = 7, height =5)
```



combine both hill datasets into one
```{r}
Pcli_hills %>% 
  mutate(Species ="Pclivosa") -> Pcli_hills

Acer_hills %>% 
  mutate(Species = "Acervicornis") -> Acer_hills

full_join(Pcli_hills, Acer_hills) -> bothspecies_colony_hills

hill_model <- lm(hill ~ Species*Treatment + Colony, data = bothspecies_colony_hills)
hill_model_metrics <- augment(hill_model)
plot(hill_model) 

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(hill_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Species*Treatment, data = hill_model_metrics) #not significant

# identifying outliers
hill_model_metrics %>% 
  filter(abs(.std.resid) > 3) #no outliers
```

one way ANOVA

```{r}
aov(hill ~ Species*Treatment, data = bothspecies_colony_hills)

summary(aov(hill ~ Species*Treatment, data = bothspecies_colony_hills))

#capture.output(summary(aov(hill ~ Species*Treatment, data = bothspecies_colony_hills)), file = "bothspecies_colony_hill_anova_table.csv")

TukeyHSD(aov(hill ~ Species*Treatment, data = bothspecies_colony_hills))
         
#capture.output(aov(hill ~ Species*Treatment, data = bothspecies_colony_hills), file = "bothspecies_colony_hill_anova_tukey.csv")
```


## boxplot of hills
```{r}
p2<-ggplot(bothspecies_colony_hills, aes(x=Treatment, y=hill, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species, scales = "free_x") +
  scale_fill_manual(labels=c("Treated", "Untreated"), values = c("#F54A34", "#60DBDB")) +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  ylim(20,120)
#ggsave("hills_boxplot_bothspecies.pdf", width = 7, height =5)
```


create combined plot
```{r}
plot_grid(p1, p2, rel_widths = c(1,1.25))
#ggsave("ED50_Hill_boxplots.pdf", width = 10, height = 5)
```
