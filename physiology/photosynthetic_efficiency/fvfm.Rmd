---
title: "FvFm"
author: "allyson_demerlis"
date: "2023-08-28"
output: html_document
---
# Packages

```{r}
library(tidyverse)
library(plotrix)
library(glmmTMB)
library(emmeans)
library(lme4)
library(ggpubr)
library(drc) #for the function "drm" dose-response model
library(broom) #for the tidy function needed for dose response model
library(car)
library(rstatix)
library(rcompanion)
library(nlme)
library(multcomp)
```


# Import data

```{r}
ipam_tidy_data <- read.csv("ipam_tidy_data.csv")
```

# 1. Raw Treatment Fv/Fm

## 1a. Raw Fv/Fm over time during the 28-d temperature treatment period.

```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(fvfm_t0 = case_when(Species == "Acervicornis" ~ `2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`)) %>% 
   mutate(fvfm_t1 = case_when(Species == "Acervicornis" ~ `2022-04-06`,
                                  Species == "Pclivosa" ~ `2022-04-06`)) %>% 
   mutate(fvfm_t2 = case_when(Species == "Acervicornis" ~ `2022-04-20`,
                                  Species == "Pclivosa" ~ `2022-04-20`)) %>% 
  pivot_longer(fvfm_t0:fvfm_t2, names_to = "fvfm_timepoint", values_to = "fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "fvfm_t0" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t1" ~ 16,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t1" ~ 21,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t2" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t2" ~ 35,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t3" ~ 65,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t3" ~ 70)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=fvfm, fill = Treatment, color = Treatment)) + 
  geom_boxplot(color = "black", outlier.shape = NA) + #not removing outliers, just removing the black dots because they are already represented in the geom_point() line
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  stat_summary(fun=mean, geom="line", aes(group=Treatment, color = Treatment), position = position_dodge(width = 0.5)) +
  facet_wrap(~Species) + 
  theme_classic() + 
  labs(y = "Fv/Fm", x = "Days in Treatment") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 14)) 
```

By genotype 
```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(fvfm_t0 = case_when(Species == "Acervicornis" ~ `2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`)) %>% 
   mutate(fvfm_t1 = case_when(Species == "Acervicornis" ~ `2022-04-06`,
                                  Species == "Pclivosa" ~ `2022-04-06`)) %>% 
   mutate(fvfm_t2 = case_when(Species == "Acervicornis" ~ `2022-04-20`,
                                  Species == "Pclivosa" ~ `2022-04-20`)) %>% 
  pivot_longer(fvfm_t0:fvfm_t2, names_to = "fvfm_timepoint", values_to = "fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "fvfm_t0" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t1" ~ 16,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t1" ~ 21,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t2" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t2" ~ 35,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t3" ~ 65,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t3" ~ 70)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=fvfm, fill = Treatment, color = Treatment)) + 
  geom_boxplot(color = "black", outlier.shape = NA) + #not removing outliers, just removing the black dots because they are already represented in the geom_point() line
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  stat_summary(fun=mean, geom="line", aes(group=Treatment, color = Treatment), position = position_dodge(width = 0.5)) +
  facet_wrap(~Species + Colony) + 
  theme_classic() + 
  labs(y = "Fv/Fm", x = "Days in Treatment") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 14))
```


### Statistics on raw data

This is repeated measures so make sure to account for that in statistical model.

update: I don't think this model for the different time points is useful, just do a statistical test for the loss of fv/fm, which innately incorporates time.

Going to copy and paste these code chunks for graphs 4-6 where the loss of fv/fm is plotted.

First creating data frames for each species
```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(fvfm_t0 = case_when(Species == "Acervicornis" ~ `2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`)) %>% 
   mutate(fvfm_t1 = case_when(Species == "Acervicornis" ~ `2022-04-06`,
                                  Species == "Pclivosa" ~ `2022-04-06`)) %>% 
   mutate(fvfm_t2 = case_when(Species == "Acervicornis" ~ `2022-04-20`,
                                  Species == "Pclivosa" ~ `2022-04-20`)) %>% 
  pivot_longer(fvfm_t0:fvfm_t2, names_to = "fvfm_timepoint", values_to = "fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "fvfm_t0" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t1" ~ 16,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t1" ~ 21,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t2" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t2" ~ 35,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t3" ~ 65,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t3" ~ 70)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Acervicornis") -> ipam_acer_raw


ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(fvfm_t0 = case_when(Species == "Acervicornis" ~ `2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`)) %>% 
   mutate(fvfm_t1 = case_when(Species == "Acervicornis" ~ `2022-04-06`,
                                  Species == "Pclivosa" ~ `2022-04-06`)) %>% 
   mutate(fvfm_t2 = case_when(Species == "Acervicornis" ~ `2022-04-20`,
                                  Species == "Pclivosa" ~ `2022-04-20`)) %>% 
  pivot_longer(fvfm_t0:fvfm_t2, names_to = "fvfm_timepoint", values_to = "fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "fvfm_t0" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t1" ~ 16,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t1" ~ 21,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t2" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t2" ~ 35,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t3" ~ 65,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t3" ~ 70)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Pclivosa") -> ipam_pcli_raw
```

Recode time as numeric for testing. Recode treatment, colony, and tank as factors
```{r}
ipam_acer_raw$numDays <- as.numeric(ipam_acer_raw$numDays)
ipam_acer_raw$Colony <- as.factor(ipam_acer_raw$Colony)
ipam_acer_raw$Tank <- as.factor(ipam_acer_raw$Tank)
ipam_acer_raw$Treatment <- as.factor(ipam_acer_raw$Treatment)

ipam_pcli_raw$numDays <- as.numeric(ipam_pcli_raw$numDays)
ipam_pcli_raw$Colony <- as.factor(ipam_pcli_raw$Colony)
ipam_pcli_raw$Tank <- as.factor(ipam_pcli_raw$Tank)
ipam_pcli_raw$Treatment <- as.factor(ipam_pcli_raw$Treatment)
```

I'm not sure if any of the below ways are correct because of the time/repeated measures component. I want to get pairwise comparisons so i can say that day 0 vs day 30 within a treatment is significant. 

#### Michael Studivan's way (ANCOVA)
The following code is coming from Dr. Michael Studivan (https://github.com/mstudiva/PortMiami-urban-coral-resilience/blob/main/stresstesting/urban%20ipam.R)
scatterplots
```{r, warning=F}
ggscatter(
  ipam_acer_raw, x = "numDays", y = "fvfm",
  facet.by  = c("Treatment", "Colony")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)
# somewhat linear decline in all combinations of treatment + colony over time

ggscatter(
  ipam_pcli_raw, x = "numDays", y = "fvfm",
  facet.by  = c("Treatment", "Colony")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)
# colony A in variable treatment does not look linear
```

Testing for homogeneity of regression slopes

check that interaction terms with covariable (time) are not significant
```{r}
ipam_acer_raw %>%
  drop_na(fvfm) %>% 
  anova_test(
    fvfm ~ numDays + Treatment + Colony +
      Treatment*Colony + numDays*Treatment +
      numDays*Colony + numDays*Colony*Treatment 
  )
#several are significant, including time

ipam_pcli_raw %>%
  drop_na(fvfm) %>% 
  anova_test(
    fvfm ~ numDays + Treatment + Colony +
      Treatment*Colony + numDays*Treatment +
      numDays*Colony + numDays*Colony*Treatment 
  )
#several are significant, including time

#these don't include Tank though because when I add tank, it makes the treatment go NA for some reason and treatment is the main effect. But not accounting for tank seems like a problem? 
```

Checking normality of residuals
```{r}
acer_model <- lm(fvfm ~ numDays + Treatment*Colony, data = ipam_acer_raw)
acer_model_metrics <- augment(acer_model)

pcli_model <- lm(fvfm ~ numDays + Treatment*Colony, data = ipam_pcli_raw)
pcli_model_metrics <- augment(pcli_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(acer_model_metrics$.resid)
shapiro_test(pcli_model_metrics$.resid)
# both significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Colony, data = acer_model_metrics)
levene_test(.resid ~ Treatment*Colony, data = pcli_model_metrics)
# both significant

# identifying outliers
acer_model_metrics %>% 
  filter(abs(.std.resid) > 3) -> acer_outliers
pcli_model_metrics %>% 
  filter(abs(.std.resid) > 3) -> pcli_outliers

# remove outliers if needed
ipam_acer_raw <- ipam_acer_raw[!rownames(ipam_acer_raw) %in% acer_outliers$.rownames,]
ipam_pcli_raw <- ipam_pcli_raw[!rownames(ipam_pcli_raw) %in% pcli_outliers$.rownames,]
```

ANCOVA
```{r}
acer_aov <- ipam_acer_raw %>% drop_na(fvfm) %>% 
  anova_test(fvfm ~ numDays + Treatment*Colony)
get_anova_table(acer_aov) # all factors significant except interaction term

#capture.output(get_anova_table(ofav_aov), file = "urban ipam ofav ancova.txt")

pcli_aov <- ipam_pcli_raw %>% drop_na(fvfm) %>% 
  anova_test(fvfm ~ numDays + Treatment*Colony)
get_anova_table(pcli_aov) # all factors significant except interaction term

#capture.output(get_anova_table(ssid_aov), file = "urban ipam ssid ancova.txt")
```
Create a contrast matrix for post-hoc test
```{r}
contrast_matrix <- contrast(
  get_anova_table(acer_aov),
  list(
    "Comparison 1" = numDays * Treatment.Control - numDays * Treatment.Variable))
```

This isn't working and it's annoying me, plus I don't think this ANCOVA model is correct because I technically need to run a mixed-model ANCOVA, which involves using terms like (1 | Group) to account for random effects. 




#### Courtney Klepac's way (repeated measures AOV -> to build in colony as a random effect)

link: https://github.com/courtneyklepac/project_reducedtolerance_massivecorals_variablehabitats/blob/master/physiology/AS_PAM-Yloss.R 

```{r}
#creating interactions for post hoc comparisons
ipam_acer_raw$colony_treatment<-interaction(ipam_acer_raw$Colony, ipam_acer_raw$Treatment)
ipam_pcli_raw$colony_treatment<-interaction(ipam_pcli_raw$Colony, ipam_pcli_raw$Treatment)
```


```{r}
# 1) Acer

#looking for outliers
boxplot(fvfm ~ Colony + numDays + Treatment, xlab="group", data=ipam_acer_raw)
#shapiro
aggregate(fvfm ~ Colony + numDays + Treatment, data=ipam_acer_raw, FUN=function(x) shapiro.test(x)$p.value)
# a couple p-values are less than 0.05

#bartlett
bartlett.test(fvfm ~ Colony, data=ipam_acer_raw) #not significant
bartlett.test(fvfm ~ Treatment, data=ipam_acer_raw) #significant
bartlett.test(fvfm ~ Tank, data=ipam_acer_raw) #significant

plotNormalHistogram(ipam_acer_raw$fvfm)

resid_acer<-lm(fvfm~Colony*Treatment*numDays, data=ipam_acer_raw)
resid_acer$residuals
plot(resid_acer,which=1) #want random scatter; no apparent trendline
qqPlot(resid_acer,data=ipam_acer_raw,na.action=na.exclude,envelope=0.95) 
#data look normal here

# 2) Pcli
#looking for outliers
boxplot(fvfm ~ Colony + numDays + Treatment, xlab="group", data=ipam_pcli_raw)
#shapiro
aggregate(fvfm ~ Colony + numDays + Treatment, data=ipam_pcli_raw, FUN=function(x) shapiro.test(x)$p.value)
# a couple p-values are less than 0.05

#bartlett
bartlett.test(fvfm ~ Colony, data=ipam_pcli_raw) # significant
bartlett.test(fvfm ~ Treatment, data=ipam_pcli_raw) #significant
bartlett.test(fvfm ~ Tank, data=ipam_pcli_raw) #significant

plotNormalHistogram(ipam_pcli_raw$fvfm) #right-skewed

resid_pcli<-lm(fvfm~Colony*Treatment*numDays, data=ipam_pcli_raw)
plot(resid_pcli,which=1) #want random scatter; no apparent trendline
qqPlot(resid_pcli,data=ipam_pcli_raw,na.action=na.exclude,envelope=0.95) 
#i think if we remove a few outliers we could get it more normal

```

repeated measures AOV - build in colony as random effect
```{r}
acer.aov <- aov(fvfm ~ numDays*Treatment + Error(Colony/numDays), data = ipam_acer_raw)
summary(acer.aov)

#Tukeys lme (can't do numDays because that's numeric)
#Treatment
model <- lme(fvfm ~ numDays*Treatment, random = ~1 | Colony, ipam_acer_raw, na.action = na.exclude)
summary(glht(model, linfct=mcp(Treatment="Tukey")), test = adjusted(type = "bonferroni"))
#significant 

#colony_treatment
model <- lme(fvfm ~ colony_treatment, random = ~1 | Colony, ipam_acer_raw, na.action = na.exclude)
summary(glht(model, linfct=mcp(colony_treatment="Tukey")), test = adjusted(type = "bonferroni")) 
#looks like two genotypes are significant: BC-8b and MB-B

#but is this formula correct because colony is nested in colony_treatment, but is also being treating as a random effect????????
```


#### Barshis lab version (lmer with mixed effects)
link: https://github.com/courtneyklepac/CBASS-vs-RSS-Physiology/blob/main/Figures/Figure%204/Fig4_PAM_plotting.R

```{r}
#Stats model
acer_model <-lmer(fvfm ~ numDays*Treatment + (1|Tank) + (1|Colony), data=ipam_acer_raw)
sjPlot::plot_model(acer_model, type="diag")

anova(acer_model)

print(emmeans(acer_model, list(pairwise ~ Treatment)), adjust = c("tukey"))

#this doesn't work and doesn't make sense
```




#### Kevin Wong's way (mixed effects model)
link: https://github.com/kevinhwong1/Thermal_Transplant_2017-2018/blob/master/scripts/Larval_2018_Statistics.R

LRT function
```{r}
## Model comparison function

#two *nested* models as input, in this case obj1 is the model without the predictor variable and obj2 is the model with the predictor variable 
lrt <- function (obj1, obj2) {
  L0 <- logLik(obj1)
  L1 <- logLik(obj2)
  L01 <- as.vector(- 2 * (L0 - L1))
  df <- attr(L1, "df") - attr(L0, "df")
  list(L01 = L01, df = df,
       "p-value" = pchisq(L01, df, lower.tail = FALSE))
}
```


Acer GLM 
```{r}
ipam_acer_raw %>% drop_na(fvfm) -> ipam_acer_raw

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_Acer_full <- glmmTMB(fvfm ~ Treatment*numDays + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_raw)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Treatment)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Colony)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(fvfm ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_acer_raw)
summary(Acer_fvfm_GLMM_Colony)

qqnorm(resid(Acer_fvfm_GLMM_Colony)) # NOT NORMAL LOL
qqline(resid(Acer_fvfm_GLMM_Colony))

boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_raw$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_raw$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(fvfm ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_raw)
summary(Acer_fvfm_GLMM_Tank)

qqnorm(resid(Acer_fvfm_GLMM_Tank)) #NOT NORMAL
qqline(resid(Acer_fvfm_GLMM_Tank))

boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_raw$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_raw$Colony)

lrt(Acer_fvfm_GLMM_Colony, glmm_Acer_full) #very significant

lrt(Acer_fvfm_GLMM_Tank, glmm_Acer_full) # very significant

# GLMM Acer Full: AIC =   -1545.5
# GLMM Acer Colony: AIC =  -937.3
# GLMM Acer Tank: AIC =  -941.8  

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, specs = ~ Treatment * numDays)
```


## 1b. Loss of fv/fm per day (not normalized to initial measurement)

```{r}
#one coral was measured twice on May 25th (P91), take the average measurement and keep that

ipam_tidy_data %>% drop_na(Tank)

str(ipam_tidy_data)

ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_rate = case_when(Species == "Acervicornis" ~ fvfm_loss/35,
                               Species == "Pclivosa" ~ fvfm_loss/30)) %>% 
  ggplot(., aes(x=Colony, y= fvfm_loss_rate, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + labs(y = "Reduction of Fv/Fm per day", x="Genotype") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x") 
  
```






# 2. Normalized to initial measurement (day 0) - Treatment Fv/Fm

## 2a. Decline of Fv/Fm over treatment period, normalized to initial measurement

```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(normalized_fvfm_start = case_when(Species == "Acervicornis" ~ `2022-03-16`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`/`2022-03-21`)) %>% 
  mutate(normalized_fvfm_end = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  pivot_longer(normalized_fvfm_start:normalized_fvfm_end, names_to = "fvfm_timepoint", values_to = "normalized_fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "normalized_fvfm_start" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "normalized_fvfm_end" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "normalized_fvfm_end" ~ 35)) %>% 
  drop_na(normalized_fvfm) %>% 
  dplyr::group_by(Treatment, Species, numDays) %>% 
  mutate(mean_fvfm = mean(normalized_fvfm)) %>% 
  mutate(stderr_fvfm = std.error(normalized_fvfm)) %>% 
  ggplot(., aes(x=numDays, y=mean_fvfm, color = Treatment)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean_fvfm - stderr_fvfm, ymax = mean_fvfm + stderr_fvfm), width =.5) +
  theme_classic() +
  facet_wrap(~Species) + 
  theme_classic() + labs(y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  labs(x= "Days in Treatment", y = "Normalized Fv/Fm")
```


## 2b. Spread of normalized Fv/Fm data at the end of the treatment period.

```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(normalized_fvfm_start = case_when(Species == "Acervicornis" ~ `2022-03-16`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`/`2022-03-21`)) %>% 
  mutate(normalized_fvfm_end = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  pivot_longer(normalized_fvfm_start:normalized_fvfm_end, names_to = "fvfm_timepoint", values_to = "normalized_fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "normalized_fvfm_start" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "normalized_fvfm_end" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "normalized_fvfm_end" ~ 35)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=normalized_fvfm, fill = Treatment)) + 
  geom_violin() + 
  facet_wrap(~Species) + 
  theme_classic() + labs(y = "Normalized Fv/Fm", x="Days in Treatment") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 15)) 
```


## 2c. Reduction of Fv/Fm over 28-d Treatment, normalized to initial measurement (all genotypes combined)

```{r}
#one coral was measured twice on May 25th (P91), take the average measurement and keep that

ipam_tidy_data %>% drop_na(Tank)

str(ipam_tidy_data)

ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  ggplot(., aes(x=Treatment, y= fvfm_loss_norm, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + 
  labs(y = "Normalized Reduction of Fv/Fm", x="Treatment") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x")
```

### Statistics 

Kevin Wong's way (mixed effects model)
link: https://github.com/kevinhwong1/Thermal_Transplant_2017-2018/blob/master/scripts/Larval_2018_Statistics.R

LRT function
```{r}
## Model comparison function

#two *nested* models as input, in this case obj1 is the model without the predictor variable and obj2 is the model with the predictor variable 
lrt <- function (obj1, obj2) {
  L0 <- logLik(obj1)
  L1 <- logLik(obj2)
  L01 <- as.vector(- 2 * (L0 - L1))
  df <- attr(L1, "df") - attr(L0, "df")
  list(L01 = L01, df = df,
       "p-value" = pchisq(L01, df, lower.tail = FALSE))
}
```

#### GLM with both species together

```{r}
ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  drop_na(fvfm_loss) %>% 
  filter(0 < fvfm_loss &  fvfm_loss < 1) -> ipam_norm
```

```{r}
ipam_norm$Species <- as.factor(ipam_norm$Species)
ipam_norm$Colony <- as.factor(ipam_norm$Colony)
ipam_norm$Tank <- as.factor(ipam_norm$Tank)
ipam_norm$Treatment <- as.factor(ipam_norm$Treatment)
```

```{r}
#model 1 = full model Species*Treatment + (1|Colony) + (1|Tank)
glmm_full <- glmmTMB(fvfm_loss_norm ~ Species*Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_norm)

summary(glmm_full) 

qqnorm(resid(glmm_full))
qqline(resid(glmm_full))

boxplot(resid(glmm_full)~ipam_norm$Species)
boxplot(resid(glmm_full)~ipam_norm$Treatment)
boxplot(resid(glmm_full)~ipam_norm$Colony)
boxplot(resid(glmm_full)~ipam_norm$Tank)

#model 2 = Species*Treatment + (1|Colony)
glmm_colony <- glmmTMB(fvfm_loss_norm ~ Species*Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_norm)

summary(glmm_colony) 

qqnorm(resid(glmm_colony))
qqline(resid(glmm_colony))

boxplot(resid(glmm_colony)~ipam_norm$Species)
boxplot(resid(glmm_colony)~ipam_norm$Treatment)
boxplot(resid(glmm_colony)~ipam_norm$Colony)

#model 3 = Species*Treatment + (1|Tank)
glmm_tank <- glmmTMB(fvfm_loss_norm ~ Species*Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_norm)

summary(glmm_tank) 

qqnorm(resid(glmm_tank))
qqline(resid(glmm_tank))

boxplot(resid(glmm_tank)~ipam_norm$Species)
boxplot(resid(glmm_tank)~ipam_norm$Treatment)
boxplot(resid(glmm_tank)~ipam_norm$Colony)

lrt(glmm_colony, glmm_full) #significant

lrt(glmm_tank, glmm_full) #significant

# GLMM Full: AIC =   -831.5 
# GLMM Colony: AIC =    -692.5 
# GLMM Tank: AIC =  -814.5

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_full, type = "II")

emmeans(glmm_full, pairwise ~ Species*Treatment)
```


#### GLM for each species

First creating data frames for each species
```{r}
ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Acervicornis") -> ipam_acer_raw


ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Pclivosa") -> ipam_pcli_raw
```

Recode treatment, colony, and tank as factors
```{r}
ipam_acer_raw$Colony <- as.factor(ipam_acer_raw$Colony)
ipam_acer_raw$Tank <- as.factor(ipam_acer_raw$Tank)
ipam_acer_raw$Treatment <- as.factor(ipam_acer_raw$Treatment)

ipam_pcli_raw$Colony <- as.factor(ipam_pcli_raw$Colony)
ipam_pcli_raw$Tank <- as.factor(ipam_pcli_raw$Tank)
ipam_pcli_raw$Treatment <- as.factor(ipam_pcli_raw$Treatment)
```


##### Acer GLM (with colony as a random effect)
```{r}
ipam_acer_raw %>% drop_na(fvfm_loss) -> ipam_acer_raw

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_Acer_full <- glmmTMB(fvfm_loss_norm ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_raw)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Treatment)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Colony)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(fvfm_loss_norm ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_acer_raw)
summary(Acer_fvfm_GLMM_Colony)

qqnorm(resid(Acer_fvfm_GLMM_Colony)) 
qqline(resid(Acer_fvfm_GLMM_Colony))

boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_raw$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_raw$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(fvfm_loss_norm ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_raw)
summary(Acer_fvfm_GLMM_Tank)

qqnorm(resid(Acer_fvfm_GLMM_Tank)) 
qqline(resid(Acer_fvfm_GLMM_Tank))

boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_raw$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_raw$Colony)

lrt(Acer_fvfm_GLMM_Colony, glmm_Acer_full) #significant

lrt(Acer_fvfm_GLMM_Tank, glmm_Acer_full) #significant

# GLMM Acer Full: AIC =   -366.2
# GLMM Acer Colony: AIC =  -335.9
# GLMM Acer Tank: AIC =  -358.2

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, pairwise ~ Treatment)

summary(glht(glmm_Acer_full, linfct=mcp(Treatment="Tukey")), test = adjusted(type = "bonferroni"))
```


##### Pcli GLM (with colony as a random effect)
```{r}
ipam_pcli_raw %>% drop_na(fvfm_loss) -> ipam_pcli_raw

ipam_pcli_raw %>% 
  filter(fvfm_loss_norm > 0) -> ipam_pcli_raw

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_pcli_full <- glmmTMB(fvfm_loss_norm ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_pcli_raw)

summary(glmm_pcli_full) 

qqnorm(resid(glmm_pcli_full))
qqline(resid(glmm_pcli_full))

boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Treatment)
boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Colony)
boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Tank)

#model 2 = Treatment*time_point + (1|Colony)
pcli_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(fvfm_loss_norm ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_pcli_raw)
summary(pcli_fvfm_GLMM_Colony)

qqnorm(resid(pcli_fvfm_GLMM_Colony)) 
qqline(resid(pcli_fvfm_GLMM_Colony))

boxplot(resid(pcli_fvfm_GLMM_Colony)~ipam_pcli_raw$Treatment) 
boxplot(resid(pcli_fvfm_GLMM_Colony)~ipam_pcli_raw$Colony)

#model 3 = Treatment*Date + (1|Tank)
pcli_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(fvfm_loss_norm ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_pcli_raw)
summary(pcli_fvfm_GLMM_Tank)

qqnorm(resid(pcli_fvfm_GLMM_Tank)) 
qqline(resid(pcli_fvfm_GLMM_Tank))

boxplot(resid(pcli_fvfm_GLMM_Tank)~ipam_pcli_raw$Treatment) 
boxplot(resid(pcli_fvfm_GLMM_Tank)~ipam_pcli_raw$Colony)

lrt(pcli_fvfm_GLMM_Colony, glmm_pcli_full) #significant

lrt(pcli_fvfm_GLMM_Tank, glmm_pcli_full) #significant

# GLMM Full: AIC =   -466.4 
# GLMM Colony: AIC = -374.0
# GLMM Tank: AIC =  -458.9

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_pcli_full, type = "II")

emmeans(glmm_pcli_full, pairwise ~ Treatment)

summary(glht(glmm_pcli_full, linfct=mcp(Treatment="Tukey")), test = adjusted(type = "bonferroni"))
```



## 2d. Reduction of Fv/Fm over 28-d Treatment, normalized to initial measurement (genotypes separated)
```{r}
#one coral was measured twice on May 25th (P91), take the average measurement and keep that

ipam_tidy_data %>% drop_na(Tank)

str(ipam_tidy_data)

ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  ggplot(., aes(x=Colony, y= fvfm_loss_norm, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + labs(y = "Normalized Reduction of Fv/Fm", x="Genotype") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x")
```

### Statistics 

First creating data frames for each species
```{r}
ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Acervicornis") -> ipam_acer_raw


ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Pclivosa") -> ipam_pcli_raw
```

Recode time as numeric for testing. Recode treatment, colony, and tank as factors
```{r}
ipam_acer_raw$Colony <- as.factor(ipam_acer_raw$Colony)
ipam_acer_raw$Tank <- as.factor(ipam_acer_raw$Tank)
ipam_acer_raw$Treatment <- as.factor(ipam_acer_raw$Treatment)

ipam_pcli_raw$Colony <- as.factor(ipam_pcli_raw$Colony)
ipam_pcli_raw$Tank <- as.factor(ipam_pcli_raw$Tank)
ipam_pcli_raw$Treatment <- as.factor(ipam_pcli_raw$Treatment)
```

Creating interactions for post hoc comparisons
```{r}
ipam_acer_raw$colony_treatment<-interaction(ipam_acer_raw$Colony, ipam_acer_raw$Treatment)
ipam_pcli_raw$colony_treatment<-interaction(ipam_pcli_raw$Colony, ipam_pcli_raw$Treatment)
```



Kevin Wong's way (mixed effects model)
link: https://github.com/kevinhwong1/Thermal_Transplant_2017-2018/blob/master/scripts/Larval_2018_Statistics.R

LRT function
```{r}
## Model comparison function

#two *nested* models as input, in this case obj1 is the model without the predictor variable and obj2 is the model with the predictor variable 
lrt <- function (obj1, obj2) {
  L0 <- logLik(obj1)
  L1 <- logLik(obj2)
  L01 <- as.vector(- 2 * (L0 - L1))
  df <- attr(L1, "df") - attr(L0, "df")
  list(L01 = L01, df = df,
       "p-value" = pchisq(L01, df, lower.tail = FALSE))
}
```


#### Acer GLM with Colony as a co-variate
```{r}
#model 1 = full model colony_treatment + (1|Tank)
glmm_Acer_full <- glmmTMB(fvfm_loss_norm ~ colony_treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_raw)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Treatment)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Colony)
boxplot(resid(glmm_Acer_full)~ipam_acer_raw$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_notank <- glmmTMB::glmmTMB(fvfm_loss_norm ~ colony_treatment, family=beta_family(link = "logit"), data=ipam_acer_raw)
summary(Acer_fvfm_GLMM_notank)

qqnorm(resid(Acer_fvfm_GLMM_notank)) 
qqline(resid(Acer_fvfm_GLMM_notank))

boxplot(resid(Acer_fvfm_GLMM_notank)~ipam_acer_raw$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_notank)~ipam_acer_raw$Colony)

lrt(Acer_fvfm_GLMM_notank, glmm_Acer_full) #significant

# GLMM Acer Full: AIC =   -371.8
# GLMM Acer no tank: AIC =  -342.3

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, pairwise ~ colony_treatment)

summary(glht(glmm_Acer_full, linfct=mcp(colony_treatment="Tukey")), test = adjusted(type = "bonferroni"))
```

#### Pcli GLM with Colony as a co-variate
```{r}
#model 1 = full model colony_treatment + (1|Tank)
glmm_pcli_full <- glmmTMB(fvfm_loss_norm ~ colony_treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_pcli_raw)

summary(glmm_pcli_full) 

qqnorm(resid(glmm_pcli_full))
qqline(resid(glmm_pcli_full))

boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Treatment)
boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Colony)
boxplot(resid(glmm_pcli_full)~ipam_pcli_raw$Tank)

#model 2 = Treatment*time_point + (1|Colony)
pcli_fvfm_GLMM_notank <- glmmTMB::glmmTMB(fvfm_loss_norm ~ colony_treatment, family=beta_family(link = "logit"), data=ipam_pcli_raw)
summary(pcli_fvfm_GLMM_notank)

qqnorm(resid(pcli_fvfm_GLMM_notank)) 
qqline(resid(pcli_fvfm_GLMM_notank))

boxplot(resid(pcli_fvfm_GLMM_notank)~ipam_pcli_raw$Treatment) 
boxplot(resid(pcli_fvfm_GLMM_notank)~ipam_pcli_raw$Colony)

lrt(pcli_fvfm_GLMM_notank, glmm_pcli_full) #significant

# GLMM Acer Full: AIC =   -468.0 
# GLMM Acer no tank: AIC =  -375.1

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_pcli_full, type = "II")

emmeans(glmm_pcli_full, pairwise ~ colony_treatment)

summary(glht(glmm_pcli_full, linfct=mcp(colony_treatment="Tukey")), test = adjusted(type = "bonferroni"))
```



## 2e. Reduction of Fv/Fm over 28-d Treatment, normalized to initial measurement. Converting to rate per day by dividing by number of days since first measurement

```{r}
#one coral was measured twice on May 25th (P91), take the average measurement and keep that

ipam_tidy_data %>% drop_na(Tank)

str(ipam_tidy_data)

ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm_rate = case_when(Species == "Acervicornis" ~ (fvfm_loss/`2022-03-16`)/35,
                               Species == "Pclivosa" ~ (fvfm_loss/`2022-03-21`)/30)) %>% 
  ggplot(., aes(x=Colony, y= fvfm_loss_norm_rate, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + labs(y = "Normalized Reduction of Fv/Fm", x="Genotype") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x")
```

### Statistics

First creating data frames for each species
```{r}
ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm_rate = case_when(Species == "Acervicornis" ~ (fvfm_loss/`2022-03-16`)/35,
                               Species == "Pclivosa" ~ (fvfm_loss/`2022-03-21`)/30)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Acervicornis") -> ipam_acer_rate_norm

ipam_tidy_data %>% 
  dplyr::select(!c(X, AOI, Ft, Fm, file)) %>% 
  dplyr::select(Species, Puck, Colony, Tank, Treatment, Date, fvfm) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  drop_na(Tank) %>% 
  filter(Date < "2022-04-22") %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm_rate = case_when(Species == "Acervicornis" ~ (fvfm_loss/`2022-03-16`)/35,
                               Species == "Pclivosa" ~ (fvfm_loss/`2022-03-21`)/30)) %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  filter(Species == "Pclivosa") -> ipam_pcli_rate_norm
```


Recode time as numeric for testing. Recode treatment, colony, and tank as factors
```{r}
ipam_acer_rate_norm$Colony <- as.factor(ipam_acer_rate_norm$Colony)
ipam_acer_rate_norm$Tank <- as.factor(ipam_acer_rate_norm$Tank)
ipam_acer_rate_norm$Treatment <- as.factor(ipam_acer_rate_norm$Treatment)

ipam_pcli_rate_norm$Colony <- as.factor(ipam_pcli_rate_norm$Colony)
ipam_pcli_rate_norm$Tank <- as.factor(ipam_pcli_rate_norm$Tank)
ipam_pcli_rate_norm$Treatment <- as.factor(ipam_pcli_rate_norm$Treatment)
```

Creating interactions for post hoc comparisons
```{r}
ipam_acer_rate_norm$colony_treatment<-interaction(ipam_acer_rate_norm$Colony, ipam_acer_rate_norm$Treatment)
ipam_pcli_rate_norm$colony_treatment<-interaction(ipam_pcli_rate_norm$Colony, ipam_pcli_rate_norm$Treatment)
```


Kevin Wong's way (mixed effects model)
link: https://github.com/kevinhwong1/Thermal_Transplant_2017-2018/blob/master/scripts/Larval_2018_Statistics.R

LRT function
```{r}
## Model comparison function

#two *nested* models as input, in this case obj1 is the model without the predictor variable and obj2 is the model with the predictor variable 
lrt <- function (obj1, obj2) {
  L0 <- logLik(obj1)
  L1 <- logLik(obj2)
  L01 <- as.vector(- 2 * (L0 - L1))
  df <- attr(L1, "df") - attr(L0, "df")
  list(L01 = L01, df = df,
       "p-value" = pchisq(L01, df, lower.tail = FALSE))
}
```


#### Acer GLM (with colony as a random effect)
```{r}
ipam_acer_rate_norm %>% drop_na(fvfm_loss) -> ipam_acer_rate_norm

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_Acer_full <- glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_rate_norm)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~ipam_acer_rate_norm$Treatment)
boxplot(resid(glmm_Acer_full)~ipam_acer_rate_norm$Colony)
boxplot(resid(glmm_Acer_full)~ipam_acer_rate_norm$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_acer_rate_norm)
summary(Acer_fvfm_GLMM_Colony)

qqnorm(resid(Acer_fvfm_GLMM_Colony)) 
qqline(resid(Acer_fvfm_GLMM_Colony))

boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_rate_norm$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_acer_rate_norm$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_acer_rate_norm)
summary(Acer_fvfm_GLMM_Tank)

qqnorm(resid(Acer_fvfm_GLMM_Tank)) 
qqline(resid(Acer_fvfm_GLMM_Tank))

boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_rate_norm$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_acer_rate_norm$Colony)

lrt(Acer_fvfm_GLMM_Colony, glmm_Acer_full) #significant

lrt(Acer_fvfm_GLMM_Tank, glmm_Acer_full) #significant

# GLMM Acer Full: AIC =   -1178.1
# GLMM Acer Colony: AIC =   -1147.7 
# GLMM Acer Tank: AIC =  -1169.8

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, pairwise ~ Treatment)

summary(glht(glmm_Acer_full, linfct=mcp(Treatment="Tukey")), test = adjusted(type = "bonferroni"))
```


#### Pcli GLM (with colony as a random effect)
```{r}
ipam_pcli_rate_norm %>% drop_na(fvfm_loss) -> ipam_pcli_rate_norm

ipam_pcli_rate_norm %>% 
  filter(fvfm_loss > 0) -> ipam_pcli_rate_norm

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_pcli_full <- glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_pcli_rate_norm)

summary(glmm_pcli_full) 

qqnorm(resid(glmm_pcli_full))
qqline(resid(glmm_pcli_full))

boxplot(resid(glmm_pcli_full)~ipam_pcli_rate_norm$Treatment)
boxplot(resid(glmm_pcli_full)~ipam_pcli_rate_norm$Colony)
boxplot(resid(glmm_pcli_full)~ipam_pcli_rate_norm$Tank)

#model 2 = Treatment*time_point + (1|Colony)
pcli_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_pcli_rate_norm)
summary(pcli_fvfm_GLMM_Colony)

qqnorm(resid(pcli_fvfm_GLMM_Colony)) 
qqline(resid(pcli_fvfm_GLMM_Colony))

boxplot(resid(pcli_fvfm_GLMM_Colony)~ipam_pcli_rate_norm$Treatment) 
boxplot(resid(pcli_fvfm_GLMM_Colony)~ipam_pcli_rate_norm$Colony)

#model 3 = Treatment*Date + (1|Tank)
pcli_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(fvfm_loss_norm_rate ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_pcli_rate_norm)
summary(pcli_fvfm_GLMM_Tank)

qqnorm(resid(pcli_fvfm_GLMM_Tank)) 
qqline(resid(pcli_fvfm_GLMM_Tank))

boxplot(resid(pcli_fvfm_GLMM_Tank)~ipam_pcli_rate_norm$Treatment) 
boxplot(resid(pcli_fvfm_GLMM_Tank)~ipam_pcli_rate_norm$Colony)

lrt(pcli_fvfm_GLMM_Colony, glmm_pcli_full) #significant

lrt(pcli_fvfm_GLMM_Tank, glmm_pcli_full) #significant

# GLMM Full: AIC =   -1383.3 
# GLMM Colony: AIC = -1291.4 
# GLMM Tank: AIC =  -1375.9 

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_pcli_full, type = "II")

emmeans(glmm_pcli_full, pairwise ~ Treatment)

summary(glht(glmm_pcli_full, linfct=mcp(Treatment="Tukey")), test = adjusted(type = "bonferroni"))
```









# 3. Raw CBASS 

## 3a. Raw CBASS Fv/Fm by species (boxplot)
```{r}
ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(!Treatment) -> ipam_tidy_CBASS

ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>% 
  dplyr::select(Puck, Colony, Treatment, Species) %>% 
  distinct() %>% #283 rows = one coral ID per treatment, no repeats
  full_join(ipam_tidy_CBASS, by = c("Puck", "Colony", "Species")) %>% 
  drop_na() %>% 
  dplyr::select(Puck:Species, fvfm, Tank:CBASS_temp) -> ipam_tidy_CBASS_treatments

ipam_tidy_CBASS_treatments %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) %>% 
  ggplot(., aes(x=CBASS_temp, y= fvfm, fill = Treatment)) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  theme_classic()
```


## 3b. Raw CBASS Fv/Fm by species (curve)
```{r}
ipam_tidy_CBASS_treatments %>%  
  mutate(CBASS_temp=as.numeric(CBASS_temp)) %>% 
ggplot(., aes(x=CBASS_temp, y = fvfm, color = Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)  + 
  facet_wrap(~Species) +
  theme_classic() +
  labs(x="Temperature (C)", y = "Fv/Fm")
```

### Statistics 

#### GLM Acer (colony as random effect)

```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75 & fvfm > 0) %>% #has to be in between 0 and 1
  dplyr::filter(Species  == "Acervicornis") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Acer_ipam_CBASS

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_AcerCBASS_full <- glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)

summary(glmm_AcerCBASS_full) 

qqnorm(resid(glmm_AcerCBASS_full))
qqline(resid(glmm_AcerCBASS_full))

boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Treatment)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Colony)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Tank)

#model 2 = Treatment*time_point + (1|Colony)
AcerCBASS_GLMM_Colony <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(AcerCBASS_GLMM_Colony)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(AcerCBASS_GLMM_Colony))
qqline(resid(AcerCBASS_GLMM_Colony))

boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_CBASS_GLMM_Tank <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Tank), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(Acer_CBASS_GLMM_Tank)

qqnorm(resid(Acer_CBASS_GLMM_Tank)) #looks great
qqline(resid(Acer_CBASS_GLMM_Tank))

boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$Tank)

lrt(AcerCBASS_GLMM_Colony, glmm_AcerCBASS_full)

lrt(Acer_CBASS_GLMM_Tank, glmm_AcerCBASS_full)

# GLMM Acer Full: AIC =  -428.5 
# GLMM Acer Colony: AIC =  -430.5, LRT to full model p-value = 1
# GLMM Acer Tank: AIC =  -423.3, LRT to full model p-value = 0.007379927

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model) ...

#the model with just colony as a fixed effect is not significantly different than the full model. However, tank model is significantly different from full. If I'm interpreting this correctly, it means that the fixed effect of colony is not important to the model, but tank is important to the model. You don't want to have too many variables to try to explain variance.  But the AIC of the full model is better than the AIC of the tank model. I will move forward with the full model.
```


```{r}
Anova(glmm_AcerCBASS_full, type = "II")

Acer_CBASS_emm <- emmeans(glmm_AcerCBASS_full, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Acer_CBASS_emm)) -> Acer_CBASS_treatment_posthoc

list <- c("Control CBASS_temp28 - Variable CBASS_temp28", "Control CBASS_temp30 - Variable CBASS_temp30", "Control CBASS_temp32 - Variable CBASS_temp32","Control CBASS_temp33 - Variable CBASS_temp33","Control CBASS_temp34 - Variable CBASS_temp34" ,"Control CBASS_temp35 - Variable CBASS_temp35","Control CBASS_temp36 - Variable CBASS_temp36","Control CBASS_temp37 - Variable CBASS_temp37")
list <- as.vector(list)

Acer_CBASS_treatment_posthoc %>% 
  filter(contrast %in% list)
```

#### GLM Pcli (colony as random effect)

```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75) %>% 
  dplyr::filter(Species  == "Pclivosa") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Pcli_ipam_CBASS

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_PcliCBASS_full <- glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)

summary(glmm_PcliCBASS_full) 

qqnorm(resid(glmm_PcliCBASS_full))
qqline(resid(glmm_PcliCBASS_full))

boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Treatment)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Colony)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Tank)

#model 2 = Treatment*time_point + (1|Colony)
PcliCBASS_GLMM_Colony <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)
summary(PcliCBASS_GLMM_Colony)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(PcliCBASS_GLMM_Colony))
qqline(resid(PcliCBASS_GLMM_Colony))

boxplot(resid(PcliCBASS_GLMM_Colony)~Pcli_ipam_CBASS$Treatment) 
boxplot(resid(PcliCBASS_GLMM_Colony)~Pcli_ipam_CBASS$CBASS_temp)
boxplot(resid(PcliCBASS_GLMM_Colony)~Pcli_ipam_CBASS$Colony)

#model 3 = Treatment*Date + (1|Tank)
Pcli_CBASS_GLMM_Tank <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Tank), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)
summary(Pcli_CBASS_GLMM_Tank)

qqnorm(resid(Pcli_CBASS_GLMM_Tank))
qqline(resid(Pcli_CBASS_GLMM_Tank))

boxplot(resid(Pcli_CBASS_GLMM_Tank)~Pcli_ipam_CBASS$Treatment) 
boxplot(resid(Pcli_CBASS_GLMM_Tank)~Pcli_ipam_CBASS$CBASS_temp)
boxplot(resid(Pcli_CBASS_GLMM_Tank)~Pcli_ipam_CBASS$Tank)

lrt(PcliCBASS_GLMM_Colony, glmm_PcliCBASS_full)

lrt(Pcli_CBASS_GLMM_Tank, glmm_PcliCBASS_full)

# GLMM Pcli Full: AIC =  -504.0
# GLMM Pcli Colony: AIC =  -506, LRT to full model p-value = 1
# GLMM Pcli Tank: AIC =  -477.2, LRT to full model p-value = 8.420974e-08

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model) ...

#the model with just colony as a fixed effect is not significantly different than the full model. However, tank model is significantly different from full. If I'm interpreting this correctly, it means that the fixed effect of colony is not important to the model, but tank is important to the model. You don't want to have too many variables to try to explain variance.  But the AIC of the full model is better than the AIC of the tank model. I will move forward with the full model.

```
```{r}
Anova(glmm_PcliCBASS_full, type = "II")

Pcli_CBASS_emm <- emmeans(glmm_PcliCBASS_full, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Pcli_CBASS_emm)) -> Pcli_CBASS_treatment_posthoc

list <- c("Control CBASS_temp28 - Variable CBASS_temp28", "Control CBASS_temp30 - Variable CBASS_temp30", "Control CBASS_temp32 - Variable CBASS_temp32","Control CBASS_temp33 - Variable CBASS_temp33","Control CBASS_temp34 - Variable CBASS_temp34" ,"Control CBASS_temp35 - Variable CBASS_temp35","Control CBASS_temp36 - Variable CBASS_temp36","Control CBASS_temp37 - Variable CBASS_temp37")
list <- as.vector(list)

Pcli_CBASS_treatment_posthoc %>% 
  filter(contrast %in% list)
```


## 3c. Raw CBASS Fv/Fm by colony (boxplot)

```{r}
ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(!Treatment) -> ipam_tidy_CBASS

ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>% 
  dplyr::select(Puck, Colony, Treatment, Species) %>% 
  distinct() %>% #283 rows = one coral ID per treatment, no repeats
  full_join(ipam_tidy_CBASS, by = c("Puck", "Colony", "Species")) %>% 
  drop_na() %>% 
  dplyr::select(Puck:Species, fvfm, Tank:CBASS_temp) -> ipam_tidy_CBASS_treatments

ipam_tidy_CBASS_treatments$Colony <- factor(ipam_tidy_CBASS_treatments$Colony, levels = c('MB-B', 'BC-8b', 'SI-C', 'A', 'B', 'C'))

ipam_tidy_CBASS_treatments %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) %>% 
  ggplot(., aes(x=CBASS_temp, y= fvfm, fill = Treatment)) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_boxplot() +
  facet_wrap(~Colony+Species) +
  theme_classic()
```

## 3d. Raw CBASS Fv/Fm by colony (curve)
```{r}
ipam_tidy_CBASS_treatments %>%  
  mutate(CBASS_temp=as.numeric(CBASS_temp)) %>% 
ggplot(., aes(x=CBASS_temp, y = fvfm, color = Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)  + 
  facet_wrap(~Colony+Species) +
  theme_classic() +
  labs(x="Temperature (C)", y = "Fv/Fm")
```

### Statistics 

#### GLM Acer colony co-variate

First need to make column for combination of colony_treatment
```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75 & fvfm > 0) %>% #has to be in between 0 and 1
  dplyr::filter(Species  == "Acervicornis") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Acer_ipam_CBASS

Acer_ipam_CBASS$colony_treatment<-interaction(Acer_ipam_CBASS$Colony, Acer_ipam_CBASS$Treatment)
```

```{r}
#model 1 = full model colony_treatment + (1|Tank)
glmm_Acer_full <- glmmTMB(fvfm ~ colony_treatment + (1|Tank), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~Acer_ipam_CBASS$Treatment)
boxplot(resid(glmm_Acer_full)~Acer_ipam_CBASS$Colony)
boxplot(resid(glmm_Acer_full)~Acer_ipam_CBASS$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_notank <- glmmTMB::glmmTMB(fvfm ~ colony_treatment, family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(Acer_fvfm_GLMM_notank)

qqnorm(resid(Acer_fvfm_GLMM_notank)) #big yikes
qqline(resid(Acer_fvfm_GLMM_notank))

boxplot(resid(Acer_fvfm_GLMM_notank)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_notank)~Acer_ipam_CBASS$Colony)

lrt(Acer_fvfm_GLMM_notank, glmm_Acer_full) #significant

# GLMM Acer Full: AIC =   -405.7
# GLMM Acer no tank: AIC =  -131.5

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, pairwise ~ colony_treatment)

summary(glht(glmm_Acer_full, linfct=mcp(colony_treatment="Tukey")), test = adjusted(type = "bonferroni"))
```


#### GLM Pcli colony co-variate

First need to make column for combination of colony_treatment
```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75) %>% 
  dplyr::filter(Species  == "Pclivosa") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Pcli_ipam_CBASS

Pcli_ipam_CBASS$colony_treatment<-interaction(Pcli_ipam_CBASS$Colony, Pcli_ipam_CBASS$Treatment)
```

```{r}
#model 1 = full model colony_treatment + (1|Tank)
glmm_Pcli_full <- glmmTMB(fvfm ~ colony_treatment + (1|Tank), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)

summary(glmm_Pcli_full) 

qqnorm(resid(glmm_Pcli_full))
qqline(resid(glmm_Pcli_full))

boxplot(resid(glmm_Pcli_full)~Pcli_ipam_CBASS$Treatment)
boxplot(resid(glmm_Pcli_full)~Pcli_ipam_CBASS$Colony)
boxplot(resid(glmm_Pcli_full)~Pcli_ipam_CBASS$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Pcli_fvfm_GLMM_notank <- glmmTMB::glmmTMB(fvfm ~ colony_treatment, family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)
summary(Pcli_fvfm_GLMM_notank)

qqnorm(resid(Pcli_fvfm_GLMM_notank)) #big yikes
qqline(resid(Pcli_fvfm_GLMM_notank))

boxplot(resid(Pcli_fvfm_GLMM_notank)~Pcli_ipam_CBASS$Treatment) 
boxplot(resid(Pcli_fvfm_GLMM_notank)~Pcli_ipam_CBASS$Colony)

lrt(Pcli_fvfm_GLMM_notank, glmm_Pcli_full) #significant

# GLMM Pcli Full: AIC =   -491.5
# GLMM Pcli no tank: AIC =  -202.9

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Pcli_full, type = "II")

emmeans(glmm_Pcli_full, pairwise ~ colony_treatment)

summary(glht(glmm_Acer_full, linfct=mcp(colony_treatment="Tukey")), test = adjusted(type = "bonferroni"))
```



## 3e. ED50 DRM curves for raw fv/fm species

### DRC for Species
```{r}
# Define dose-response curves using same constraints
ll3 <- function(data) {
  drm(fvfm ~ CBASS_temp, data = data,
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.01, 30))} 

# I changed the max value from 0.55 to 0.01 so I don't get NaN for std.error, statistic, or p-value.
#these are the limits Ross had set in his code:
#upperl = c(120, 0.72, 40),
#lowerl = c(10, 0.55, 30))

tryll3 <- possibly(ll3, otherwise = NULL)

# Fit model to each coral, get parameters, fitted values, and residuals
initmods_species <- ipam_tidy_CBASS_treatments %>%
  dplyr::select(!c(Colony, Tank, Date, Treatment_period)) %>% 
  nest(data = c(Puck, CBASS_temp, fvfm)) %>% #this line wasn't working for the longest time because I hadn't added "Puck" to the list for the nested data. 
  mutate(ll3 = map(data, tryll3)) %>% # Fit the model to each coral
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy), #tidy comes from the broom package I think?
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values for each Species and Treatment combination from model fits
ed50_species <- initmods_species %>% 
  unnest(data) %>% 
  dplyr::select(Species, Treatment, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

ed50_species %>% distinct() -> ed50_species

# Collect raw data, fitted values, and ed50 estimates
fvals_species <- initmods_species %>%
  dplyr::select(Species, Treatment, pred) %>%
  unnest(pred) %>%
  full_join(ed50_species) %>%
  rename(ed50 = estimate)
```


```{r}
ggplot(data = fvals_species, aes(x=CBASS_temp, y=fvfm)) +
  geom_point(data = fvals_species, aes(color=Treatment)) +
    geom_line(data = drop_na(fvals_species, .fitted),
              aes(y = .fitted)) +
    geom_vline(data = distinct(fvals_species, Species, Treatment, ed50), 
               aes(xintercept = ed50), 
               lwd = 0.2, lty = 2) +
    geom_text(data = distinct(fvals_species, Species, Treatment, ed50),
              aes(x = ed50, y = 0.05, label = round(ed50, 2)), 
              hjust = 1, nudge_x = -0.2, size = 3) +
    facet_grid(vars(Treatment), vars(Species)) +
  labs(x = "Temperature (C)", y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_bw() +
  theme(text = element_text(size = 14)) 
```

## 3f. Hill slope 

### DRC for Species
```{r}
# Define dose-response curves using same constraints
ll3 <- function(data) {
  drm(fvfm ~ CBASS_temp, data = data,
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.01, 30))} 

# I changed the max value from 0.55 to 0.01 so I don't get NaN for std.error, statistic, or p-value.
#these are the limits Ross had set in his code:
#upperl = c(120, 0.72, 40),
#lowerl = c(10, 0.55, 30))

tryll3 <- possibly(ll3, otherwise = NULL)

# Fit model to each coral, get parameters, fitted values, and residuals
initmods_species <- ipam_tidy_CBASS_treatments %>%
  dplyr::select(!c(Colony, Tank, Date, Treatment_period)) %>% 
  nest(data = c(Puck, CBASS_temp, fvfm)) %>% #this line wasn't working for the longest time because I hadn't added "Puck" to the list for the nested data. 
  mutate(ll3 = map(data, tryll3)) %>% # Fit the model to each coral
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy), #tidy comes from the broom package I think?
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values for each Species and Treatment combination from model fits
hill_species <- initmods_species %>% 
  unnest(data) %>% 
  dplyr::select(Species, Treatment, pars) %>%
  unnest(pars) %>%
  filter(term == "hill")

hill_species %>% distinct() -> hill_species

# Collect raw data, fitted values, and ed50 estimates
fvals_species_hill <- initmods_species %>%
  dplyr::select(Species, Treatment, pred) %>%
  unnest(pred) %>%
  full_join(hill_species) %>%
  rename(hill = estimate)
```


```{r}
ggplot(data = fvals_species_hill, aes(x=CBASS_temp, y=fvfm)) +
  geom_point(data = fvals_species_hill, aes(color=Treatment)) +
    geom_line(data = drop_na(fvals_species_hill, .fitted),
              aes(y = .fitted)) +
    geom_vline(data = distinct(fvals_species_hill, Species, Treatment, hill), 
               aes(xintercept = hill), 
               lwd = 0.2, lty = 2) +
    geom_text(data = distinct(fvals_species_hill, Species, Treatment, hill),
              aes(x = hill, y = 0.05, label = round(hill, 2)), 
              hjust = 1, nudge_x = -0.2, size = 3) +
    facet_grid(vars(Treatment), vars(Species)) +
  labs(x = "Temperature (C)", y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_bw() +
  theme(text = element_text(size = 14)) 
```



## 3f. ED50 DRM curves for raw fv/fm with colony 

### DRC for Colony
```{r, include = F}
# Define dose-response curves using same constraints
ll3 <- function(data) {
  drm(fvfm ~ CBASS_temp, data = data,
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.01, 30))} 

# when I remove the lower limit from the ll3 function, SI-C variable ED50 is 36.25712. But when I keep both limits, it is 35.96952 but the std.error, statistic, and p-value are NaN. I narrowed it down and it is an issue with the "max" value. I changed it from 0.55 to 0.01, and I get 36.25712 for the ED50. Below are the upper and lower limits set by Ross in his code.
#upperl = c(120, 0.72, 40),
#lowerl = c(10, 0.55, 30))

tryll3 <- possibly(ll3, otherwise = NULL)

# Fit model to each coral, get parameters, fitted values, and residuals
initmods_colony <- ipam_tidy_CBASS_treatments %>%
  dplyr::select(!c(Tank, Date, Treatment_period)) %>% 
  nest(data = c(Puck, CBASS_temp, fvfm)) %>% #this line wasn't working for the longest time because I hadn't added "Puck" to the list for the nested data. 
  mutate(ll3 = map(data, tryll3)) %>% # Fit the model to each coral
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy), #tidy comes from the broom package I think?
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values for each Colony and Treatment combination from model fits
ed50_colony <- initmods_colony%>% 
  unnest(data) %>% 
  dplyr::select(Colony, Treatment, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

ed50_colony %>% distinct() -> ed50_colony

# Collect raw data, fitted values, and ed50 estimates
fvals_colony <- initmods_colony %>%
  dplyr::select(Species, Treatment, Colony, pred) %>%
  unnest(pred) %>%
  full_join(ed50_colony) %>%
  rename(ed50 = estimate)
```


```{r}
fvals_colony$Colony <- factor(fvals_colony$Colony, levels = c('MB-B', 'BC-8b', 'SI-C', 'A', 'B', 'C'))

fvals_colony

ggplot(data = fvals_colony, aes(x=CBASS_temp, y=fvfm)) +
  geom_point(data = fvals_colony, aes(color=Treatment)) +
    geom_line(data = drop_na(fvals_colony, .fitted),
              aes(y = .fitted)) +
    geom_vline(data = distinct(fvals_colony, Colony, Treatment, ed50), 
               aes(xintercept = ed50), 
               lwd = 0.2, lty = 2) +
    geom_text(data = distinct(fvals_colony, Colony, Treatment, ed50),
              aes(x = ed50, y = 0.05, label = round(ed50, 2)), 
              hjust = 1, nudge_x = -0.2, size = 3) +
    facet_grid(vars(Treatment), vars(Colony)) +
  labs(x = "Temperature (C)", y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_bw() +
  theme(text = element_text(size = 14)) 
```

### ED50 Statistical test 

Take all genotypes together and compare the mean ED50 of treatment (that way you have multiple samples to add to the total group mean)

Kruskall-wallis test
```{r}
#Acer
ed50_colony %>% 
  filter(Colony == "BC-8b" | Colony == "MB-B" | Colony == "SI-C") %>% 
kruskal_test(data = ., estimate ~ Treatment) #not significant


#Pcli
ed50_colony %>% 
  filter(Colony == "A" | Colony == "B" | Colony == "C") %>% 
kruskal_test(data = ., estimate ~ Treatment) #not significant
```

### Independent t-test for Acer
```{r}
ed50_colony %>% 
  filter(Colony == "BC-8b" | Colony == "MB-B" | Colony == "SI-C") %>% 
  group_by(Treatment) %>% 
  shapiro_test(estimate) #normality test not significant

ed50_colony %>% 
  filter(Colony == "BC-8b" | Colony == "MB-B" | Colony == "SI-C") %>% 
  levene_test(estimate ~ Treatment) # variances are equal (p-value not significant)

ed50_colony %>% 
  filter(Colony == "BC-8b" | Colony == "MB-B" | Colony == "SI-C") %>% 
  t_test(estimate ~ Treatment) #ed50s are not significantly different for Acer
```

### Independent t-test for Pcli
```{r}
ed50_colony %>% 
  filter(Colony == "A" | Colony == "B" | Colony == "C") %>% 
  group_by(Treatment) %>% 
  shapiro_test(estimate) #normality test not significant

ed50_colony %>% 
   filter(Colony == "A" | Colony == "B" | Colony == "C") %>% 
  levene_test(estimate ~ Treatment) # variances are equal (p-value not significant)

ed50_colony %>% 
   filter(Colony == "A" | Colony == "B" | Colony == "C") %>% 
  t_test(estimate ~ Treatment) #ed50s are not significantly different for Pcli
```

## 3g. ED50 DRM curves for raw fv/fm for species using Evensen et al. 2021 code to predict data at higher temperatures

Acer
```{r}
Acer_ipam_CBASS -> Acer_CBASS
Acer_CBASS$CBASS_temp <- as.numeric(as.character(Acer_CBASS$CBASS_temp))
CBASS_Acer_DRC <- drm(fvfm ~ CBASS_temp, data = Acer_CBASS, curveid = Treatment, fct = LL.3(names = c('hill', 'max', 'ed50')))
mselect(CBASS_Acer_DRC, list(LL.2(), LL.4(), LL.5(), LL2.2(), LL2.3(), LL2.4(), LL2.5(), AR.2(), AR.3(), EXD.2(), EXD.3()), icfct = AIC)
modelFit(CBASS_Acer_DRC)
summary(CBASS_Acer_DRC)
plot(CBASS_Acer_DRC)

#extract ED50
Acer_CBASS_variable_coeff<-CBASS_Acer_DRC$coefficients[5]
Acer_CBASS_control_coeff<-CBASS_Acer_DRC$coefficients[6]

Acer_coeff <- data.frame(Acer_CBASS_variable_coeff,Acer_CBASS_control_coeff)

control_CBASS <- drm(fvfm ~ CBASS_temp, data = Acer_CBASS[Acer_CBASS$Treatment=="Control",], fct = LL.3())
summary(control_CBASS)
plot(control_CBASS)

variable_CBASS <- drm(fvfm ~ CBASS_temp, data = Acer_CBASS[Acer_CBASS$Treatment=="Variable",], fct = LL.3())
summary(variable_CBASS)
plot(variable_CBASS)

control_CBASS_preddata = data.frame(temp = seq(27,39, length.out = 100))
control_CBASS_pred = as.data.frame(predict(control_CBASS, newdata = control_CBASS_preddata, interval = 'confidence'))
control_CBASS_preddata = data.frame(control_CBASS_preddata, fvfm = control_CBASS_pred$Prediction, Lower = control_CBASS_pred$Lower, Upper = control_CBASS_pred$Upper)

variable_CBASS_preddata = data.frame(temp = seq(27,39, length.out = 100))
variable_CBASS_pred = as.data.frame(predict(variable_CBASS, newdata = variable_CBASS_preddata, interval = 'confidence'))
variable_CBASS_preddata = data.frame(variable_CBASS_preddata, fvfm = variable_CBASS_pred$Prediction, Lower = variable_CBASS_pred$Lower, Upper = variable_CBASS_pred$Upper)


ggplot() +
  geom_jitter(data = Acer_CBASS, aes(x = CBASS_temp, y = fvfm, color = Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(26,40), breaks=c(26,28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = control_CBASS_preddata, aes(x = temp, y = fvfm), color = '#66ccfe', show.legend = FALSE) +
  geom_ribbon(data = control_CBASS_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = '#66ccfe', linetype=2, alpha = 0.2) +
  geom_vline(data = Acer_coeff, aes(xintercept = Acer_CBASS_control_coeff), color = '#66ccfe', show.legend = FALSE) +
  geom_text(data = Acer_coeff, aes(label = Acer_CBASS_control_coeff), x = 30, y = 0.2, show.legend = FALSE, color = '#66ccfe') +
 
  geom_line(data = variable_CBASS_preddata, aes(x = temp, y = fvfm), color = '#e92000', show.legend = FALSE) +
  geom_ribbon(data = variable_CBASS_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = '#e92000', linetype=2, alpha = 0.2) +
  geom_vline(data = Acer_coeff, aes(xintercept = Acer_CBASS_variable_coeff), color = '#e92000', show.legend = FALSE) +
  geom_text(data = Acer_coeff, aes(label = Acer_CBASS_variable_coeff), x = 30, y = 0.1, show.legend = FALSE, color = '#e92000') +

  scale_color_manual(values=c('#66ccfe','#e92000')) +
  ylab("Fv/Fm") +
  xlab("Temperature (C)") +
  theme_bw() +
  labs(title = "Acervicornis")
```

Pcli
```{r}
Pcli_ipam_CBASS -> Pcli_CBASS
Pcli_CBASS$CBASS_temp <- as.numeric(as.character(Pcli_CBASS$CBASS_temp))
CBASS_Pcli_DRC <- drm(fvfm ~ CBASS_temp, data = Pcli_CBASS, curveid = Treatment, fct = LL.3(names = c('hill', 'max', 'ed50')))
mselect(CBASS_Pcli_DRC, list(LL.2(), LL.4(), LL.5(), LL2.2(), LL2.3(), LL2.4(), LL2.5(), AR.2(), AR.3(), EXD.2(), EXD.3()), icfct = AIC)
modelFit(CBASS_Pcli_DRC)
summary(CBASS_Pcli_DRC)
plot(CBASS_Pcli_DRC)

#extract ED50
Pcli_CBASS_variable_coeff<-CBASS_Pcli_DRC$coefficients[5]
Pcli_CBASS_control_coeff<-CBASS_Pcli_DRC$coefficients[6]

Pcli_coeff <- data.frame(Pcli_CBASS_variable_coeff,Pcli_CBASS_control_coeff)

control_CBASS <- drm(fvfm ~ CBASS_temp, data = Pcli_CBASS[Pcli_CBASS$Treatment=="Control",], fct = LL.3())
summary(control_CBASS)
plot(control_CBASS)

variable_CBASS <- drm(fvfm ~ CBASS_temp, data = Pcli_CBASS[Pcli_CBASS$Treatment=="Variable",], fct = LL.3())
summary(variable_CBASS)
plot(variable_CBASS)

control_CBASS_preddata = data.frame(temp = seq(27,39, length.out = 100))
control_CBASS_pred = as.data.frame(predict(control_CBASS, newdata = control_CBASS_preddata, interval = 'confidence'))
control_CBASS_preddata = data.frame(control_CBASS_preddata, fvfm = control_CBASS_pred$Prediction, Lower = control_CBASS_pred$Lower, Upper = control_CBASS_pred$Upper)

variable_CBASS_preddata = data.frame(temp = seq(27,39, length.out = 100))
variable_CBASS_pred = as.data.frame(predict(variable_CBASS, newdata = variable_CBASS_preddata, interval = 'confidence'))
variable_CBASS_preddata = data.frame(variable_CBASS_preddata, fvfm = variable_CBASS_pred$Prediction, Lower = variable_CBASS_pred$Lower, Upper = variable_CBASS_pred$Upper)


ggplot() +
  geom_jitter(data = Pcli_CBASS, aes(x = CBASS_temp, y = fvfm, color = Treatment), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(26,40), breaks=c(26,28,30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.1, 0.7), breaks=c(0, 0.2, 0.4, 0.6)) +
  geom_line(data = control_CBASS_preddata, aes(x = temp, y = fvfm), color = '#66ccfe', show.legend = FALSE) +
  geom_ribbon(data = control_CBASS_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = '#66ccfe', linetype=2, alpha = 0.2) +
  geom_vline(data = Pcli_coeff, aes(xintercept = Pcli_CBASS_control_coeff), color = '#66ccfe', show.legend = FALSE) +
  geom_text(data = Pcli_coeff, aes(label = Pcli_CBASS_control_coeff), x = 30, y = 0.2, show.legend = FALSE, color = '#66ccfe') +
 
  geom_line(data = variable_CBASS_preddata, aes(x = temp, y = fvfm), color = '#e92000', show.legend = FALSE) +
  geom_ribbon(data = variable_CBASS_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = '#e92000', linetype=2, alpha = 0.2) +
  geom_vline(data = Pcli_coeff, aes(xintercept = Pcli_CBASS_variable_coeff), color = '#e92000', show.legend = FALSE) +
  geom_text(data = Pcli_coeff, aes(label = Pcli_CBASS_variable_coeff), x = 30, y = 0.1, show.legend = FALSE, color = '#e92000') +

  scale_color_manual(values=c('#66ccfe','#e92000')) +
  ylab("Fv/Fm") +
  xlab("Temperature (C)") +
  theme_bw() +
  labs(title = "Pclivosa")
```






# 4. Normalized to initial measurement (treatment day 0 - T1/T0) - CBASS

```{r}
ipam_tidy_data %>% 
  filter(Date < "2022-03-22") %>% 
  dplyr::select(fvfm, Puck, Colony, Date, Treatment,Species) %>% 
  mutate(fvfm_T0 = fvfm) %>% 
  dplyr::select(!fvfm) -> preCBASSfvfm

ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(fvfm, Puck:Date, CBASS_temp, Species) %>% 
  mutate(fvfm_T1 = fvfm) %>% 
  dplyr::select(!fvfm) %>% 
  left_join(preCBASSfvfm, by = c("Puck", "Colony", "Species")) %>% 
  dplyr::select(!Date.x) %>% 
  dplyr::select(!Date.y) %>% 
  filter(fvfm_T0 < 0.75) %>% #there were some weird outliers where the fvfm = 2.00
  filter(fvfm_T1 < 0.75) %>% 
  mutate(CBASS_normalize_fvfm = fvfm_T1/fvfm_T0) %>% 
  filter(CBASS_normalize_fvfm > 0) %>% 
  filter(CBASS_normalize_fvfm < 1) %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp))-> ipam_CBASS_normalized

  ggplot(ipam_CBASS_normalized, aes(x=CBASS_temp, y = CBASS_normalize_fvfm, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_classic()
```


```{r}
ipam_CBASS_normalized %>% 
  mutate(CBASS_temp=as.numeric(as.character(CBASS_temp))) %>% 
ggplot(., aes(x=CBASS_temp, y = CBASS_normalize_fvfm, color = Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)  + 
  facet_wrap(~Species) +
  theme_classic() +
  labs(x="Temperature (C)", y = "Normalized Fv/Fm")
```

### GLM Acer

```{r}
ipam_CBASS_normalized %>% 
  filter(Species == "Acervicornis") -> Acer_ipam_CBASS

#model 1 = full model
glmm_AcerCBASS_full <- glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)

summary(glmm_AcerCBASS_full) 

qqnorm(resid(glmm_AcerCBASS_full))
qqline(resid(glmm_AcerCBASS_full))

boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Treatment)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Colony)

#model 2 
AcerCBASS_GLMM <- glmmTMB::glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp, family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(AcerCBASS_GLMM)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(AcerCBASS_GLMM))
qqline(resid(AcerCBASS_GLMM))

boxplot(resid(AcerCBASS_GLMM)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(AcerCBASS_GLMM)~Acer_ipam_CBASS$CBASS_temp)

lrt(AcerCBASS_GLMM, glmm_AcerCBASS_full)

lrt(Acer_CBASS_GLMM_Tank, glmm_AcerCBASS_full)

# GLMM Acer Full: AIC =  -323.6 
# GLMM Acer no Colony: AIC =  -324.1

# no colony is better based on AIC, and lrt p-value is not significant
```


```{r}
Anova(AcerCBASS_GLMM, type = "II")

Acer_CBASS_emm <- emmeans(AcerCBASS_GLMM, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Acer_CBASS_emm))
```


### GLM Pcli

```{r}
ipam_CBASS_normalized %>% 
  filter(Species == "Pclivosa") -> Pcli_ipam_CBASS

#model 1 = full model
glmm_PcliCBASS_full <- glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)

summary(glmm_PcliCBASS_full) 

qqnorm(resid(glmm_PcliCBASS_full))
qqline(resid(glmm_PcliCBASS_full))

boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Treatment)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Colony)

#model 2 
PcliCBASS_GLMM <- glmmTMB::glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp, family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)
summary(PcliCBASS_GLMM)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(PcliCBASS_GLMM))
qqline(resid(PcliCBASS_GLMM))

boxplot(resid(PcliCBASS_GLMM)~Pcli_ipam_CBASS$Treatment) 
boxplot(resid(PcliCBASS_GLMM)~Pcli_ipam_CBASS$CBASS_temp)

lrt(PcliCBASS_GLMM, glmm_PcliCBASS_full)

# GLMM Pcli Full: AIC =  -355.8 
# GLMM Pcli no Colony: AIC =  -344.3  , LRT p-value = 0.0002403821

# full model is better based on AIC and p-value
```


```{r}
Anova(glmm_PcliCBASS_full, type = "II")

Pcli_CBASS_emm <- emmeans(glmm_PcliCBASS_full, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Pcli_CBASS_emm))
```





# 5. Normalized to final treatment measurement (treatment day 28) - CBASS

```{r}
ipam_tidy_data %>% 
  filter(Date == "2022-04-20") %>% 
  dplyr::select(fvfm, Puck, Colony, Date, Treatment,Species) %>% 
  mutate(fvfm_T0 = fvfm) %>% 
  dplyr::select(!fvfm) -> preCBASSfvfm_endoftreatment

ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(fvfm, Puck:Date, CBASS_temp, Species) %>% 
  mutate(fvfm_T1 = fvfm) %>% 
  dplyr::select(!fvfm) %>% 
  left_join(preCBASSfvfm_endoftreatment, by = c("Puck", "Colony", "Species")) %>% 
  dplyr::select(!Date.x) %>% 
  dplyr::select(!Date.y) %>% 
  filter(fvfm_T0 < 0.75) %>% #there were some weird outliers where the fvfm = 2.00
  filter(fvfm_T1 < 0.75) %>% 
  mutate(CBASS_normalize_fvfm = fvfm_T1/fvfm_T0) %>% 
  #filter(CBASS_normalize_fvfm > 0) %>% 
  #filter(CBASS_normalize_fvfm < 1) %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp))-> ipam_CBASS_normalized_endoftreatment

  ggplot(ipam_CBASS_normalized_endoftreatment, aes(x=CBASS_temp, y = CBASS_normalize_fvfm, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_classic()
  
  #there are a lot of values > 1 here so I can't just filter it out so the data is 0<x<1 
```