---
title: "FvFm"
author: "allyson_demerlis"
date: "2023-08-28"
output: html_document
---

## Import data and load libraries

```{r}
ipam_tidy_data <- read.csv("ipam_tidy_data.csv")
```

```{r}
library(tidyverse)
library(plotrix)
library(glmmTMB)
library(emmeans)
library(lme4)
library(ggpubr)
library(drc) #for the function "drm" dose-response model
library(broom) #for the tidy function needed for dose response model
library(car)
```

## FvFm during 28-day temperature treatment

### Boxplot over time
```{r, echo = F, warning = F, include = T, fig.cap = "Fv/Fm values of corals within the control or variable treatment during the one-month treatment period (March 23-April 20)."}
#what are the differences in Fv/Fm between treatments? (pre-CBASS)
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  mutate(Date = as.factor(Date)) %>% 
  dplyr::group_by(Treatment, Date, Species) %>% 
  ggplot(., aes(x=Date, y=fvfm, fill = Treatment)) + 
  geom_boxplot() + 
  stat_summary(fun=mean, geom="line", aes(group=Treatment, color = Treatment), position = position_dodge(width = 0.5)) +
  facet_wrap(~Species) + 
  scale_x_discrete(labels = c("Mar 16", "Mar 21", "Apr 6", "Apr 20")) + 
  theme_classic() + labs(y = "Fv/Fm") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 15)) 
```

### mean FvFm over time
```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% 
  #mutate(Date = as.factor(Date)) %>% 
  dplyr::group_by(Treatment, Date, Species) %>% 
  mutate(mean_fvfm = mean(fvfm)) %>% 
  mutate(stderr_fvfm = std.error(fvfm)) %>% 
  ggplot(., aes(x=Date, y=mean_fvfm, color = Treatment)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean_fvfm - stderr_fvfm, ymax = mean_fvfm + stderr_fvfm), width =.5) +
  theme_classic() +
  facet_wrap(~Species) + 
  scale_x_date(
    date_labels = "%d %b",
    date_breaks = "15 day") +
  theme_classic() + labs(y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))
```
### normalized FvFm to initial value
```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(normalized_fvfm = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  dplyr::select(Colony:Species, normalized_fvfm) -> ipam_normalized_data
```

### visualizing normalized fvfm from start to end of treatment period

```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(normalized_fvfm_start = case_when(Species == "Acervicornis" ~ `2022-03-16`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`/`2022-03-21`)) %>% 
  mutate(normalized_fvfm_end = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  pivot_longer(normalized_fvfm_start:normalized_fvfm_end, names_to = "fvfm_timepoint", values_to = "normalized_fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "normalized_fvfm_start" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "normalized_fvfm_end" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "normalized_fvfm_end" ~ 35)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=normalized_fvfm, fill = Treatment)) + 
  geom_violin() + 
  facet_wrap(~Species) + 
  theme_classic() + labs(y = "Normalized Fv/Fm", x="Days in Treatment") +
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34"))  +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme(text = element_text(size = 15)) 
```


```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(normalized_fvfm_start = case_when(Species == "Acervicornis" ~ `2022-03-16`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`/`2022-03-21`)) %>% 
  mutate(normalized_fvfm_end = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  pivot_longer(normalized_fvfm_start:normalized_fvfm_end, names_to = "fvfm_timepoint", values_to = "normalized_fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "normalized_fvfm_start" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "normalized_fvfm_end" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "normalized_fvfm_end" ~ 35)) %>% 
  drop_na(normalized_fvfm) %>% 
  dplyr::group_by(Treatment, Species, numDays) %>% 
  mutate(mean_fvfm = mean(normalized_fvfm)) %>% 
  mutate(stderr_fvfm = std.error(normalized_fvfm)) %>% 
  ggplot(., aes(x=numDays, y=mean_fvfm, color = Treatment)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean_fvfm - stderr_fvfm, ymax = mean_fvfm + stderr_fvfm), width =.5) +
  theme_classic() +
  facet_wrap(~Species) + 
  theme_classic() + labs(y = "Fv/Fm") +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  labs(x= "Days in Treatment", y = "Normalized Fv/Fm")
```

Separate by genotype to look for any significant patterns

```{r}
ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(fvfm < 0.75) %>% #filter out the outliers, 0.75 was set in Cunning et al 2021
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(normalized_fvfm_start = case_when(Species == "Acervicornis" ~ `2022-03-16`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`/`2022-03-21`)) %>% 
  mutate(normalized_fvfm_end = case_when(Species == "Acervicornis" ~ `2022-04-20`/`2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-04-20`/`2022-03-21`)) %>% 
  pivot_longer(normalized_fvfm_start:normalized_fvfm_end, names_to = "fvfm_timepoint", values_to = "normalized_fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "normalized_fvfm_start" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "normalized_fvfm_end" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "normalized_fvfm_end" ~ 35)) %>% 
  drop_na(normalized_fvfm) %>% 
  dplyr::group_by(Treatment, Colony, Species, numDays) %>% 
  mutate(mean_fvfm = mean(normalized_fvfm)) %>% 
  mutate(stderr_fvfm = std.error(normalized_fvfm)) %>% 
  ggplot(., aes(x=numDays, y=mean_fvfm, color = Colony, lty = Treatment)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean_fvfm - stderr_fvfm, ymax = mean_fvfm + stderr_fvfm), width =.5) +
  theme_classic() +
  facet_wrap(~Species) + 
  theme_classic() + labs(y = "Fv/Fm") +
  labs(x= "Days in Treatment", y = "Normalized Fv/Fm")
```


### Statistics

LRT function

```{r}
## Model comparison function (from Dr. Kevin Wong: https://github.com/kevinhwong1/Thermal_Transplant_2017-2018/blob/master/scripts/Larval_2018_Statistics.R)
#two *nested* models as input, in this case obj1 is the model without the predictor variable and obj2 is the model with the predictor variable 
lrt <- function (obj1, obj2) {
  L0 <- logLik(obj1)
  L1 <- logLik(obj2)
  L01 <- as.vector(- 2 * (L0 - L1))
  df <- attr(L1, "df") - attr(L0, "df")
  list(L01 = L01, df = df,
       "p-value" = pchisq(L01, df, lower.tail = FALSE))
}
```


#### Acer GLM 

```{r}
ipam_normalized_data %>% 
  filter(Species == "Acervicornis") %>% 
  drop_na() -> ipam_data_28d_Acer

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_Acer_full <- glmmTMB(normalized_fvfm ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_data_28d_Acer)

summary(glmm_Acer_full) 

qqnorm(resid(glmm_Acer_full))
qqline(resid(glmm_Acer_full))

boxplot(resid(glmm_Acer_full)~ipam_data_28d_Acer$Treatment)
boxplot(resid(glmm_Acer_full)~ipam_data_28d_Acer$Colony)
boxplot(resid(glmm_Acer_full)~ipam_data_28d_Acer$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Acer_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(normalized_fvfm ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_data_28d_Acer)
summary(Acer_fvfm_GLMM_Colony)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(Acer_fvfm_GLMM_Colony))
qqline(resid(Acer_fvfm_GLMM_Colony))

boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_data_28d_Acer$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Colony)~ipam_data_28d_Acer$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(normalized_fvfm ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_data_28d_Acer)
summary(Acer_fvfm_GLMM_Tank)

qqnorm(resid(Acer_fvfm_GLMM_Tank)) #looks great
qqline(resid(Acer_fvfm_GLMM_Tank))

boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_data_28d_Acer$Treatment) 
boxplot(resid(Acer_fvfm_GLMM_Tank)~ipam_data_28d_Acer$Tank)

lrt(Acer_fvfm_GLMM_Colony, glmm_Acer_full)

lrt(Acer_fvfm_GLMM_Tank, glmm_Acer_full)

# GLMM Acer Full: AIC =  -366.2
# GLMM Acer Colony: AIC =  -335.9, LRT to full model p-value = 1.345583e-08
# GLMM Acer Tank: AIC =  -358.2, LRT to full model p-value = 0.001634789

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Acer_full, type = "II")

emmeans(glmm_Acer_full, specs = pairwise ~ Treatment)
```

#### Pcli GLM 

```{r}
ipam_normalized_data %>% 
  filter(Species == "Pclivosa") %>% 
  drop_na() %>% 
  filter(normalized_fvfm < 1) -> ipam_data_28d_Pcli

#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_Pcli_full <- glmmTMB(normalized_fvfm ~ Treatment + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=ipam_data_28d_Pcli)

summary(glmm_Pcli_full) 

qqnorm(resid(glmm_Pcli_full))
qqline(resid(glmm_Pcli_full))

boxplot(resid(glmm_Pcli_full)~ipam_data_28d_Pcli$Treatment)
boxplot(resid(glmm_Pcli_full)~ipam_data_28d_Pcli$Colony)
boxplot(resid(glmm_Pcli_full)~ipam_data_28d_Pcli$Tank)

#model 2 = Treatment*time_point + (1|Colony)
Pcli_fvfm_GLMM_Colony <- glmmTMB::glmmTMB(normalized_fvfm ~ Treatment + (1|Colony), family=beta_family(link = "logit"), data=ipam_data_28d_Pcli)
summary(Pcli_fvfm_GLMM_Colony)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(Pcli_fvfm_GLMM_Colony))
qqline(resid(Pcli_fvfm_GLMM_Colony))

boxplot(resid(Pcli_fvfm_GLMM_Colony)~ipam_data_28d_Pcli$Treatment) 
boxplot(resid(Pcli_fvfm_GLMM_Colony)~ipam_data_28d_Pcli$Colony)

#model 3 = Treatment*Date + (1|Tank)
Pcli_fvfm_GLMM_Tank <- glmmTMB::glmmTMB(normalized_fvfm ~ Treatment + (1|Tank), family=beta_family(link = "logit"), data=ipam_data_28d_Pcli)
summary(Pcli_fvfm_GLMM_Tank)

qqnorm(resid(Pcli_fvfm_GLMM_Tank))
qqline(resid(Pcli_fvfm_GLMM_Tank))

boxplot(resid(Pcli_fvfm_GLMM_Tank)~ipam_data_28d_Pcli$Treatment) 
boxplot(resid(Pcli_fvfm_GLMM_Tank)~ipam_data_28d_Pcli$Tank)

lrt(Pcli_fvfm_GLMM_Colony, glmm_Pcli_full)

lrt(Pcli_fvfm_GLMM_Tank, glmm_Pcli_full)

# GLMM Pcli Full: AIC =   -466.4
# GLMM Pcli Colony: AIC =  -374.0 , LRT to full model p-value = 2.571284e-22
# GLMM Pcli Tank: AIC =  -458.9 , LRT to full model p-value = 0.002067941

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model), the full model is the best model.
```


```{r}
Anova(glmm_Pcli_full, type = "II")

emmeans(glmm_Pcli_full, specs = pairwise ~ Treatment)
```



## CBASS FvFm

### Visualize raw FvFms at different temperatures
```{r}
ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(!Treatment) -> ipam_tidy_CBASS

ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>% 
  dplyr::select(Puck, Colony, Treatment, Species) %>% 
  distinct() %>% #283 rows = one coral ID per treatment, no repeats
  full_join(ipam_tidy_CBASS, by = c("Puck", "Colony", "Species")) %>% 
  drop_na() %>% 
  dplyr::select(Puck:Species, fvfm, Tank:CBASS_temp) -> ipam_tidy_CBASS_treatments

ipam_tidy_CBASS_treatments %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp)) %>% 
  ggplot(., aes(x=CBASS_temp, y= fvfm, fill = Treatment)) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  theme_classic()
```

#### GLM Acer

```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75 & fvfm > 0.001) %>% #has to be in between 0 and 1
  dplyr::filter(Species  == "Acervicornis") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Acer_ipam_CBASS


#model 1 = full model Treatment*time_point + (1|Colony) + (1|Tank)
glmm_AcerCBASS_full <- glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony) + (1|Tank), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)

summary(glmm_AcerCBASS_full) 

qqnorm(resid(glmm_AcerCBASS_full))
qqline(resid(glmm_AcerCBASS_full))

boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Treatment)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Colony)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Tank)

#model 2 = Treatment*time_point + (1|Colony)
AcerCBASS_GLMM_Colony <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(AcerCBASS_GLMM_Colony)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(AcerCBASS_GLMM_Colony))
qqline(resid(AcerCBASS_GLMM_Colony))

boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(AcerCBASS_GLMM_Colony)~Acer_ipam_CBASS$Colony)

#model 3 = Treatment*Date + (1|Tank)
Acer_CBASS_GLMM_Tank <- glmmTMB::glmmTMB(fvfm ~ Treatment*CBASS_temp + (1|Tank), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(Acer_CBASS_GLMM_Tank)

qqnorm(resid(Acer_CBASS_GLMM_Tank)) #looks great
qqline(resid(Acer_CBASS_GLMM_Tank))

boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(Acer_CBASS_GLMM_Tank)~Acer_ipam_CBASS$Tank)

lrt(AcerCBASS_GLMM_Colony, glmm_AcerCBASS_full)

lrt(Acer_CBASS_GLMM_Tank, glmm_AcerCBASS_full)

# GLMM Acer Full: AIC =  -428.5 
# GLMM Acer Colony: AIC =  -430.5, LRT to full model p-value = 1
# GLMM Acer Tank: AIC =  -423.3, LRT to full model p-value = 0.007379927

#based on AIC and LRT p-values (lowest AIC is best, if p-value is significant that means there is a significant difference in the full model versus the reduced model) ...

#the model with just colony as a fixed effect is not significantly different than the full model. However, tank model is significantly different from full. If I'm interpreting this correctly, it means that the fixed effect of colony is not important to the model, but tank is important to the model. You don't want to have too many variables to try to explain variance.  But the AIC of the full model is better than the AIC of the tank model. I will move forward with the full model.
```


```{r}
Anova(glmm_AcerCBASS_full, type = "II")

Acer_CBASS_emm <- emmeans(glmm_AcerCBASS_full, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Acer_CBASS_emm)) %>% 
  filter(p.value < 0.05)
```


#### GLM Pcli

```{r}
ipam_tidy_CBASS_treatments %>% 
  dplyr::filter(fvfm < 0.75) %>% 
  dplyr::filter(Species  == "Pclivosa") %>% 
  mutate(CBASS_temp=as.factor(CBASS_temp)) -> Pcli_ipam_CBASS


```



### Normalize CBASS Fv/Fm values following Klepac and Barshis 2020

"Normalized Fv/Fm values (21–0 h)/0 h were used for statistical analyses to correct for between ramet variation in starting values. Fv/Fm values measured at the end of each assay were used for plotting for simplicity to allow for easy comparison to previous studies."

I'm going to try to plot it as the normalized ones so I can see the effect of just the CBASS. 

the formula (21–0 h)/0 h is calculating the percent difference from initial to final, whereas in my normalization I want to repeat what I did in the above 28-d treatment plot and do a ratio of final / initial. 

Maybe I need to normalize to the initial Fvfm value (before the treatment started?)? because i feel like normalizing to end of treatment value actually removes the effect of treatment.


```{r}
ipam_tidy_data %>% 
  filter(Date < "2022-03-22") %>% 
  dplyr::select(fvfm, Puck, Colony, Date, Treatment,Species) %>% 
  mutate(fvfm_T0 = fvfm) %>% 
  dplyr::select(!fvfm) -> preCBASSfvfm

ipam_tidy_data %>% 
  dplyr::filter(Treatment_period == "CBASS") %>% 
  dplyr::select(fvfm, Puck:Date, CBASS_temp, Species) %>% 
  mutate(fvfm_T1 = fvfm) %>% 
  dplyr::select(!fvfm) %>% 
  left_join(preCBASSfvfm, by = c("Puck", "Colony", "Species")) %>% 
  dplyr::select(!Date.x) %>% 
  dplyr::select(!Date.y) %>% 
  filter(fvfm_T0 < 0.75) %>% #there were some weird outliers where the fvfm = 2.00
  filter(fvfm_T1 < 0.75) %>% 
  mutate(CBASS_normalize_fvfm = fvfm_T1/fvfm_T0) %>% 
  filter(CBASS_normalize_fvfm > 0) %>% 
  filter(CBASS_normalize_fvfm < 1) %>% 
  mutate(CBASS_temp = as.factor(CBASS_temp))-> ipam_CBASS_normalized

  ggplot(ipam_CBASS_normalized, aes(x=CBASS_temp, y = CBASS_normalize_fvfm, fill=Treatment)) +
  geom_boxplot() +
  facet_wrap(~Species) + 
  scale_fill_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  theme_classic()
```


```{r}
ipam_CBASS_normalized %>% 
  mutate(CBASS_temp=as.numeric(CBASS_temp)) %>% 
ggplot(., aes(x=CBASS_temp, y = CBASS_normalize_fvfm, color = Treatment)) +
  geom_point() +
  scale_color_manual(labels=c("Control", "Variable"), values = c( "#60DBDB", "#F54A34")) +
  geom_smooth(formula = y ~ x, method = "loess", span = 0.9)  + 
  facet_wrap(~Species) +
  theme_classic() +
  labs(x="Temperature (ºC)", y = "Normalized Fv/Fm")
```

#### GLM Acer

```{r}
ipam_CBASS_normalized %>% 
  filter(Species == "Acervicornis") -> Acer_ipam_CBASS

#model 1 = full model
glmm_AcerCBASS_full <- glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Acer_ipam_CBASS)

summary(glmm_AcerCBASS_full) 

qqnorm(resid(glmm_AcerCBASS_full))
qqline(resid(glmm_AcerCBASS_full))

boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Treatment)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_AcerCBASS_full)~Acer_ipam_CBASS$Colony)

#model 2 
AcerCBASS_GLMM <- glmmTMB::glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp, family=beta_family(link = "logit"), data=Acer_ipam_CBASS)
summary(AcerCBASS_GLMM)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(AcerCBASS_GLMM))
qqline(resid(AcerCBASS_GLMM))

boxplot(resid(AcerCBASS_GLMM)~Acer_ipam_CBASS$Treatment) 
boxplot(resid(AcerCBASS_GLMM)~Acer_ipam_CBASS$CBASS_temp)

lrt(AcerCBASS_GLMM, glmm_AcerCBASS_full)

lrt(Acer_CBASS_GLMM_Tank, glmm_AcerCBASS_full)

# GLMM Acer Full: AIC =  -323.6 
# GLMM Acer no Colony: AIC =  -324.1

# no colony is better based on AIC, and lrt p-value is not significant
```


```{r}
Anova(AcerCBASS_GLMM, type = "II")

Acer_CBASS_emm <- emmeans(AcerCBASS_GLMM, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Acer_CBASS_emm))
```


#### GLM Pcli

```{r}
ipam_CBASS_normalized %>% 
  filter(Species == "Pclivosa") -> Pcli_ipam_CBASS

#model 1 = full model
glmm_PcliCBASS_full <- glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp + (1|Colony), family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)

summary(glmm_PcliCBASS_full) 

qqnorm(resid(glmm_PcliCBASS_full))
qqline(resid(glmm_PcliCBASS_full))

boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Treatment)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$CBASS_temp)
boxplot(resid(glmm_PcliCBASS_full)~Pcli_ipam_CBASS$Colony)

#model 2 
PcliCBASS_GLMM <- glmmTMB::glmmTMB(CBASS_normalize_fvfm ~ Treatment*CBASS_temp, family=beta_family(link = "logit"), data=Pcli_ipam_CBASS)
summary(PcliCBASS_GLMM)

#need to check normality and variance visually (boxplots of fixed effects only)
qqnorm(resid(PcliCBASS_GLMM))
qqline(resid(PcliCBASS_GLMM))

boxplot(resid(PcliCBASS_GLMM)~Pcli_ipam_CBASS$Treatment) 
boxplot(resid(PcliCBASS_GLMM)~Pcli_ipam_CBASS$CBASS_temp)

lrt(PcliCBASS_GLMM, glmm_PcliCBASS_full)

# GLMM Pcli Full: AIC =  -355.8 
# GLMM Pcli no Colony: AIC =  -344.3  , LRT p-value = 0.0002403821

# full model is better based on AIC and p-value
```


```{r}
Anova(glmm_PcliCBASS_full, type = "II")

Pcli_CBASS_emm <- emmeans(glmm_PcliCBASS_full, specs = ~ Treatment*CBASS_temp)

as.data.frame(pairs(Pcli_CBASS_emm))
```


#### linear mixed model Acer
following Evensen et al. 2020 code: https://github.com/BarshisLab/CBASS-vs-RSS-Physiology/blob/main/Figures/Figure%204/Fig4_PAM_plotting.R
```{r}
ipam_CBASS_normalized %>% 
  filter(Species == "Acervicornis") -> CBASS_Acer_normalized

#Stats model
Acer_lmer <-lmer(CBASS_normalize_fvfm ~ Treatment*CBASS_temp + (1|Colony), data=CBASS_Acer_normalized)
sjPlot::plot_model(Acer_lmer, type="diag")

anova(Acer_lmer)

get_anova_table(anova_test(CBASS_normalize_fvfm ~ Treatment*CBASS_temp, data=CBASS_Acer_normalized))

CBASS_Acer_emm <- emmeans(Acer_lmer, list(pairwise ~ Treatment*CBASS_temp))

as.data.frame(CBASS_Acer_emm$`pairwise differences of Treatment, CBASS_temp`)
```


####obtain ED50 
following Evensen et al. 2020 code: https://github.com/BarshisLab/CBASS-vs-RSS-Physiology/blob/main/Figures/Figure%204/Fig4_PAM_plotting.R

```{r}
ipam_CBASS_normalized %>% 
  dplyr::filter(Species  == "Acervicornis") %>% 
  mutate(CBASS_temp=as.numeric(CBASS_temp)) -> Acer_ipam_CBASS_norm

DRC <- drm(CBASS_normalize_fvfm ~ CBASS_temp, data = Acer_ipam_CBASS_norm, curveid = Treatment, fct = LL.3(names = c('hill', 'max', 'ed50')))
mselect(DRC, list(LL.2(), LL.4(), LL.5(), LL2.2(), LL2.3(), LL2.4(), LL2.5(), AR.2(), AR.3(), EXD.2(), EXD.3()), icfct = AIC)

DRC <- drm(CBASS_normalize_fvfm ~ CBASS_temp, data = Acer_ipam_CBASS_norm, curveid = Treatment, fct = LL.4(names = c('hill', 'max', 'ed50')))
modelFit(DRC)
summary(DRC)
plot(DRC)

DRC$coefficients

#extract ED50
variable_DRC_coeff<-DRC$coefficients[5]
control_DRC_coeff<-DRC$coefficients[6]
```




