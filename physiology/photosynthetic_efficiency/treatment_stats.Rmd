---
title: "FvFm"
author: "allyson_demerlis"
date: "2023-08-28"
output: html_document
---
# Packages

```{r}
library(tidyverse)
library(plotrix)
library(emmeans)
library(lme4) 
library(lmerTest)
library(ggpubr)
library(drc) #for the function "drm" dose-response model
library(broom) #for the tidy function needed for dose response model
library(car)
library(rstatix)
library(rcompanion)
library(nlme)
library(multcomp)
```


# Import data and create tidy datasets
```{r}
ipam_tidy_data <- read.csv("ipam_tidy_data.csv")

treatment_time_bothspecies <- ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species) %>% 
  dplyr::filter(Date <= "2022-04-20") %>% 
    mutate(Treatment = case_when(Tank == "1" ~ "Untreated",
                               Tank == "2" ~ "Treated",
                               Tank == "3" ~ "Treated",
                               Tank == "4" ~ "Untreated",
                               Tank == "5" ~ "Treated", 
                               Tank == "6" ~ "Untreated",
                               Tank == "7" ~ "Untreated",
                               Tank == "8" ~ "tank_8")) %>% 
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
   mutate(fvfm_t0 = case_when(Species == "Acervicornis" ~ `2022-03-16`,
                                  Species == "Pclivosa" ~ `2022-03-21`)) %>% 
   mutate(fvfm_t1 = case_when(Species == "Acervicornis" ~ `2022-04-06`,
                                  Species == "Pclivosa" ~ `2022-04-06`)) %>% 
   mutate(fvfm_t2 = case_when(Species == "Acervicornis" ~ `2022-04-20`,
                                  Species == "Pclivosa" ~ `2022-04-20`)) %>% 
  pivot_longer(fvfm_t0:fvfm_t2, names_to = "fvfm_timepoint", values_to = "fvfm") %>% 
  mutate(numDays = case_when(fvfm_timepoint == "fvfm_t0" ~ 0,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t1" ~ 16,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t1" ~ 21,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t2" ~ 30,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t2" ~ 35,
                             Species == "Pclivosa" & fvfm_timepoint == "fvfm_t3" ~ 65,
                             Species == "Acervicornis" & fvfm_timepoint == "fvfm_t3" ~ 70))

treatment_normalized_bothspecies <- ipam_tidy_data %>% 
  dplyr::filter(!Treatment_period == "CBASS") %>%
  drop_na(Colony) %>% #this is because there are some corals that never matched up to IPAM values so they're just NA
  dplyr::select(Date, Colony, Puck, Tank, fvfm, Treatment, Species)  %>% 
    mutate(Treatment = case_when(Tank == "1" ~ "Untreated",
                               Tank == "2" ~ "Treated",
                               Tank == "3" ~ "Treated",
                               Tank == "4" ~ "Untreated",
                               Tank == "5" ~ "Treated", 
                               Tank == "6" ~ "Untreated",
                               Tank == "7" ~ "Untreated",
                               Tank == "8" ~ "tank_8")) %>% 
  dplyr::filter(Date <= "2022-04-20") %>% #pre-CBASS time points
  pivot_wider(names_from = Date, values_from = fvfm) %>% 
  mutate(fvfm_loss = case_when(Species == "Acervicornis" ~ `2022-03-16` - `2022-04-20`,
                               Species == "Pclivosa" ~ `2022-03-21` - `2022-04-20`)) %>% 
  mutate(fvfm_loss_norm = case_when(Species == "Acervicornis" ~ fvfm_loss/`2022-03-16`,
                               Species == "Pclivosa" ~ fvfm_loss/`2022-03-21`))
```



# 1. (for figure) Raw Fv/Fm over time during the 28-d temperature treatment period.
```{r, warning = F}
treatment_time_bothspecies %>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=fvfm, fill = Treatment, color = Treatment)) + 
  geom_boxplot(color = "black", outlier.shape = NA, alpha=0.3) + #not removing outliers, just removing the black dots because they are already represented in the geom_point() line
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  stat_summary(fun=mean, geom="line", aes(group=Treatment, color = Treatment), position = position_dodge(width = 0.5)) +
  facet_wrap(~Species) + 
  theme_classic() + 
  labs(y = "Fv/Fm", x = "Days in Treatment") +
  scale_fill_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB"))  +
  scale_color_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 14)) 
#ggsave("treatment_bothspecies_overtimeboxplots.pdf")
```

By genotype 
```{r, warning = F}
treatment_time_bothspecies%>% 
  dplyr::select(!c(`2022-04-06`:`2022-04-20`)) %>% 
  mutate(numDays = as.factor(numDays)) %>% 
  ggplot(., aes(x=numDays, y=fvfm, fill = Treatment, color = Treatment)) + 
  geom_boxplot(color = "black", outlier.shape = NA,  alpha=0.3) + #not removing outliers, just removing the black dots because they are already represented in the geom_point() line
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  stat_summary(fun=mean, geom="line", aes(group=Treatment, color = Treatment), position = position_dodge(width = 0.5)) +
  facet_wrap(~Species + Colony) + 
  theme_classic() + 
  labs(y = "Fv/Fm", x = "Days in Treatment") +
  scale_fill_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB"))  +
  scale_color_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 14))
```

# 2. (for stats) Normalized to initial measurement (day 0) - Treatment Fv/Fm

## 2a. Reduction of Fv/Fm over 28-d Treatment, normalized to initial measurement (all genotypes combined)
```{r, warning = F}
treatment_normalized_bothspecies%>% 
  ggplot(., aes(x=Treatment, y= fvfm_loss_norm, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + 
  labs(y = "Decline in Fv/Fm", x="Treatment") +
  scale_fill_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB"))  +
  scale_color_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x")
ggsave("treatment_normalized_bothspecies_boxplot.pdf")
```

### Statistics

Change to factors
```{r}
str(treatment_normalized_bothspecies)
#make factors: Colony, Puck, Tank, Treatment, Species

treatment_normalized_bothspecies %>% 
  mutate_at(vars(Colony, Puck, Tank, Treatment, Species), factor) -> treatment_normalized_bothspecies
```

Create linear model to test normality of residuals and homogeneity of variance. Remove outliers
```{r}
treat_model <- lm(fvfm_loss_norm ~ Treatment*Species*Colony + Tank, data = treatment_normalized_bothspecies)
treat_model_metrics <- augment(treat_model)
plot(treat_model)

# assess normality of residuals using Shapiro-Wilk test
shapiro_test(treat_model_metrics$.resid) # not significant

# assess homogeneity of variances using Levene's Test
levene_test(.resid ~ Treatment*Species, data = treat_model_metrics) #not significant

# identifying outliers
treat_model_metrics %>% 
  filter(abs(.std.resid) > 3) -> treat_outliers
# 2 outliers

#remove outliers
treatment_normalized_bothspecies <- treatment_normalized_bothspecies[!rownames(treatment_normalized_bothspecies) %in% treat_outliers$.rownames,]
```

Run 2-way ANOVA
```{r}
aov(fvfm_loss_norm ~ Treatment*Species, data = treatment_normalized_bothspecies)

summary(aov(fvfm_loss_norm ~ Treatment*Species, data = treatment_normalized_bothspecies))

#capture.output(summary(aov(fvfm_loss_norm ~ Treatment*Species, data = treatment_normalized_bothspecies)), file = "fvfm_loss_norm_bothspecies_anova_table.csv")


TukeyHSD(aov(fvfm_loss_norm ~ Treatment*Species, data = treatment_normalized_bothspecies))
         
#capture.output(TukeyHSD(aov(fvfm_loss_norm ~ Treatment*Species, data = treatment_normalized_bothspecies)), file = "fvfm_loss_norm_bothspecies_anova_tukey.csv")
```






## 2b. Reduction of Fv/Fm over 28-d Treatment, normalized to initial measurement (genotypes separated)
```{r, warning = F}
treatment_normalized_bothspecies%>% 
  ggplot(., aes(x=Colony, y= fvfm_loss_norm, color= Treatment)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(), alpha=0.3) +
  theme_classic() + labs(y = "Normalized Reduction of Fv/Fm", x="Genotype") +
  scale_fill_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB"))  +
  scale_color_manual(labels=c("Tank 8", "Treated", "Untreated"), values = c("grey", "#F54A34", "#60DBDB")) +
  theme(text = element_text(size = 12)) + 
  facet_wrap(~Species, scales = "free_x")
#ggsave("treatment_normalized_genotypes_boxplot.pdf")
```

Run 3-way ANOVA
```{r}
aov(fvfm_loss_norm ~ Treatment*Species*Colony, data = treatment_normalized_bothspecies)

summary(aov(fvfm_loss_norm ~ Treatment*Species*Colony, data = treatment_normalized_bothspecies))

#capture.output(summary(aov(fvfm_loss_norm ~ Treatment*Species*Colony, data = treatment_normalized_bothspecies)), file = "fvfm_loss_norm_bothspeciesgenet_anova_table.csv")


TukeyHSD(aov(fvfm_loss_norm ~ Treatment*Species*Colony, data = treatment_normalized_bothspecies))
         
#capture.output(TukeyHSD(aov(fvfm_loss_norm ~ Treatment*Species*Colony, data = treatment_normalized_bothspecies)), file = "fvfm_loss_norm_bothspeciesgenet_anova_tukey.csv")
```




